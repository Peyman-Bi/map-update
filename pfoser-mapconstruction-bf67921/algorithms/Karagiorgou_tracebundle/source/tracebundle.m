% TraceBundle map construction 1.0
% Copyright 2013 Sophia Karagiorgou and Dieter Pfoser
% 
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
% 
%     http://www.apache.org/licenses/LICENSE-2.0
% 
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
% 
% ------------------------------------------------------------------------
% 
% This software is based on the following article(s). Please cite this
% article when using this code as part of a research publication:
% 
% S. Karagiorgou and D. Pfoser. On Vehicle Tracking Data-Based Road Network Generation. 
% In Proc. 20th ACM SIGSPATIAL GIS Conference, pp. 89-98, 2012. 
% 
% S. Karagiorgou and D. Pfoser. Segmentation-Based Road Network Construction. 
% In Proc. 21th ACM SIGSPATIAL GIS Conference, pp. 470-473, 2013.   
% 
% ------------------------------------------------------------------------
% 
% Author: Sophia Karagiorgou (karagior@gmail.com)
% Filename: tracebundle.m

 
currentFolder = pwd;
cd(currentFolder);

pts_to_tr=[];
inter_to_tr=[];
cluster_to_tr=[];

idx=1; % index for angle matrix
id=1;

fprintf('Starting at %s\n', timestamp);

fprintf('Loading files\n');

lfile= 'centre_pts.mat';
centre_pts_t=load(lfile) ; % load the file
centre_pts=centre_pts_t.centre_pts;

ifile= 'clusterseeds.mat';
clusterseeds = load(ifile) ; % load the file

lfile= 'inter_to_cluster.mat';
inter_to_cluster_t=load(lfile) ; % load the file
inter_to_cluster=inter_to_cluster_t.inter_to_cluster;

ifile= 'pts_to_inter.mat';
pts_to_inter = load(ifile) ; % load the file

lfile= 'pts_ln.mat';
pts_ln=load(lfile) ; % load the file

lfile= 'slk.mat';
slk_t=load(lfile) ; % load the file
slk=slk_t.slk;

lfile= 'vehicles.mat';
vehicles_t=load(lfile) ; % load the file
vehicles=vehicles_t.vehicles;

fprintf('Finding correspondancies among position samples and intersections\n');

idx=1;
cluster_to_tr=[];
netsections=[];
for g=1:length(vehicles)
    tr=find(pts_ln.pts_ln(:,3)==vehicles(g));
    itr=unique(pts_ln.pts_ln(tr,8),'rows');
    
    res = find(pts_to_inter.pts_to_inter(:,3)==vehicles(g));
    if ~isempty(res)
        pts_to_i=pts_to_inter.pts_to_inter(res,:);
        pts_to_i=sortrows(pts_to_i,4);
        for h=1:length(pts_to_i(:,1))-1
            rx1=find(inter_to_cluster(:,1)==pts_to_i(h,3) & inter_to_cluster(:,2)==pts_to_i(h,4));
            rx2=find(inter_to_cluster(:,1)==pts_to_i(h+1,3) & inter_to_cluster(:,2)==pts_to_i(h+1,4));
            cc1=find(centre_pts(:,3)==inter_to_cluster(rx1,3));
            cc2=find(centre_pts(:,3)==inter_to_cluster(rx2,3));
            
            rp1=find(pts_ln.pts_ln(:,3)==vehicles(g) & pts_ln.pts_ln(:,4)==pts_to_i(h,4));
            rp2=find(pts_ln.pts_ln(:,3)==vehicles(g) & pts_ln.pts_ln(:,4)==pts_to_i(h+1,4));
            
            if pts_ln.pts_ln(rp1,8)==pts_ln.pts_ln(rp2,8)
                rp=find(pts_ln.pts_ln(:,3)==vehicles(g) & pts_ln.pts_ln(:,4)>pts_to_i(h,4)&pts_ln.pts_ln(:,4)<pts_to_i(h+1,4));
                if ~isempty(rp)
                    if length(rp)>1
                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(cc1,3) centre_pts(cc2,3) idx 2]);
                        for v=1:length(rp)
                            netsections=vertcat(netsections,[idx pts_ln.pts_ln(rp(v),1) pts_ln.pts_ln(rp(v),2)]);
                        end
                        idx=idx+1;
                    else
                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(cc1,3) centre_pts(cc2,3) idx 2]);
                        netsections=vertcat(netsections,[idx pts_ln.pts_ln(rp(1),1) pts_ln.pts_ln(rp(1),2)]);
                        idx=idx+1;
                    end
                    
                    for b=1:length(rp)
                        pts_ln.pts_ln(rp(b),10)=pts_to_i(h,3);
                        pts_ln.pts_ln(rp(b),11)=pts_to_i(h,4);
                        pts_ln.pts_ln(rp(b),12)=pts_to_i(h+1,3);
                        pts_ln.pts_ln(rp(b),13)=pts_to_i(h+1,4);
                        pts_ln.pts_ln(rp(b),14)=centre_pts(cc1,3);
                        pts_ln.pts_ln(rp(b),15)=centre_pts(cc2,3);
                        pts_ln.pts_ln(rp(b),16)=1;
                        pts_ln.pts_ln(rp(b),17)=2;
                    end
                else
                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(cc1,3) centre_pts(cc2,3) idx 2]);
                    idx=idx+1;
                end
            end
        end
    end
end


for g=1:length(cluster_to_tr(:,1))
    res=[];
    sres=[];
    if ~isempty(netsections)
        res=find(netsections(:,1)==cluster_to_tr(g,3));
    end
    if ~isempty(cluster_to_tr)
        sres=find(cluster_to_tr(:,3)==cluster_to_tr(g,3));
    end
    if ~isempty(res) && ~isempty(sres)
        
        resc1=find(centre_pts(:,3)==cluster_to_tr(sres,1));
        resc2=find(centre_pts(:,3)==cluster_to_tr(sres,2));
        
        st(1,1)=centre_pts(resc1,1);
        st(1,2)=centre_pts(resc1,2);
        en(1,1)=centre_pts(resc2,1);
        en(1,2)=centre_pts(resc2,2);
        
        mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(1),2), netsections(res(1),3)]));
        netsections(res(1),4)=mdegrees1;
        if length(res)>1
            for m=1:(length(res)-1)
                if m==1 % outgoing direction
                    mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                    netsections(res(m),4)=mdegrees1;
                    if length(res)>1
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                        netsections(res(m),5)=mdegrees2;
                    else
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2),netsections(res(m),3)],[en(1,1), en(1,2)]));
                        netsections(res(m),5)=mdegrees2;
                    end
                end
                if m==(length(res)-1)
                    if m>1
                        mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                    else
                        mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                    end
                    
                    mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                    netsections(res(m),5)=mdegrees2;
                    
                    mdegrees1=mdegrees2;
                    netsections(res(m+1),4)=mdegrees1;
                end
                if m<length(res)&&m>1
                    mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                    netsections(res(m),4)=mdegrees1;
                    mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                    netsections(res(m),5)=mdegrees2;
                end
            end
        end
        mdegrees2=rad2deg(angle2Points([netsections(res(length(res)),2),netsections(res(length(res)),3)],[en(1,1), en(1,2)]));
        netsections(res(length(res)),5)=mdegrees2;
    end
end


minx=min(pts_ln.pts_ln(:,1));
maxx=max(pts_ln.pts_ln(:,1));
miny=min(pts_ln.pts_ln(:,2));
maxy=max(pts_ln.pts_ln(:,2));

rc=find(centre_pts(:,1)>=minx&centre_pts(:,1)<=maxx&centre_pts(:,2)>=miny&centre_pts(:,2)<=maxy);
temp_centre_pts=centre_pts(rc,:);
nedges=[];
for g=1:length(temp_centre_pts(:,1))
    rs=find(cluster_to_tr(:,1)==temp_centre_pts(g,3)|cluster_to_tr(:,2)==temp_centre_pts(g,3));
    if ~isempty(rs)
        nedges=vertcat(nedges,cluster_to_tr(rs,3));
    end
end
nedges=unique(nedges,'rows');
ic=[];
for g=1:length(nedges)
    rx=find(cluster_to_tr(:,3)==nedges(g));
    if ~isempty(rx)
        ic=vertcat(ic, rx);
    end
end

cluster_to_tr=cluster_to_tr(ic,:);
centre_pts=temp_centre_pts;

tempnetsections=netsections;
tempcluster=cluster_to_tr;
tempcluster2=tempcluster;
[cluster_to_tr, cluid]=unique([cluster_to_tr(:,1) cluster_to_tr(:,2)],'rows', 'first');


netnodes=[];
nnets=[];
lk=[];

cluster_to_tr(:,4)=0;
cluster_to_tr(:,5)=0;
cluster_to_tr(:,6)=0;


fprintf('Compacting the same link samples\n');

for g=1:length(cluster_to_tr(:,1))
    rx=[];
    nx=[];
    rxo=[];
    nxo=[];
    pts=[];
    rx=find(tempcluster(:,1)==cluster_to_tr(g,1)&tempcluster(:,2)==cluster_to_tr(g,2));
    c1=find(centre_pts(:,3)==cluster_to_tr(g,1));
    c2=find(centre_pts(:,3)==cluster_to_tr(g,2));
    
    dist=(centre_pts(c1,8)+centre_pts(c2,8))/2;
    cluster_to_tr(g,4)=round((centre_pts(c1,9)+centre_pts(c2,9))/2);
    cluster_to_tr(g,5)=dist;
    
    if ~isempty(c1)&&~isempty(c2)
        
        if ~isempty(rx)
            for h=1:length(rx)
                xx=find(netsections(:,1)==tempcluster(rx(h),3));
                if ~isempty(xx)
                    nx=vertcat(nx,xx);
                end
            end
        end
        
        if isempty(nx)
            cluster_to_tr(g,3)=g;
            netnodes=vertcat(netnodes, [g length(rx) 1]);
            
            lk=vertcat(lk,[centre_pts(c1,1), centre_pts(c1,2), centre_pts(c2,1), centre_pts(c2,2)]);
        else
            cluster_to_tr(g,3)=g;
            netnodes=vertcat(netnodes, [g length(rx) 1]);
            pts=unique([netsections(nx,2) netsections(nx,3)],'rows');
            
            circle = [[centre_pts(c1,1) centre_pts(c1,2)] 10];
            idx=[];
            for l=1:length(pts(:,1))
                if isPointInCircle([pts(l,1), pts(l,2)], circle)
                    idx=vertcat(idx,l);
                end
            end
            pts(idx,:)=[];
            
            circle = [[centre_pts(c2,1) centre_pts(c2,2)] 10];
            idx=[];
            for l=1:length(pts(:,1))
                if isPointInCircle([pts(l,1), pts(l,2)], circle)
                    idx=vertcat(idx,l);
                end
            end
            pts(idx,:)=[];
            
            pseq=[];
            
            if ~isempty(pts)
                for b=1:length(pts(:,1))
                    rb=find(netsections(nx,2)==pts(b,1)&netsections(nx,3)==pts(b,2));
                    ndegrees=max(netsections(nx(rb),4));
                    x1=pts(b,1)+dist;
                    y1=pts(b,2)+dist;
                    x2=pts(b,1)+dist;
                    y2=pts(b,2)-dist;
                    x3=pts(b,1)-dist;
                    y3=pts(b,2)+dist;
                    x4=pts(b,1)-dist;
                    y4=pts(b,2)-dist;
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
                    in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
                    
                    rs1=find(in1==1);
                    rs2=find(in2==1);
                    rss=union(rs1,rs2,'rows');
                    
                    if b==1
                        in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                    elseif b==length(pts(:,1))
                        in = createLine([pts(b,1) pts(b,2)],[centre_pts(c2,1) centre_pts(c2,2)]);
                    elseif b<length(pts(:,1))
                        in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                    end
                    
                    e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                    ce1=createEdge(e1,dist);
                    tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                    tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                    dest1 = transformEdge(ce1,tr1);
                    dest2 = transformEdge(ce1,tr2);
                    
                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                    
                    vpts=[];
                    for h=1:length(rss)
                        if slk(rss(h),1)~=pts(b,1)&slk(rss(h),2)~=pts(b,2)&slk(rss(h),3)~=pts(b,1)&slk(rss(h),4)~=pts(b,2)
                            e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                            point = intersectEdges(ce1, e2);
                            if ~isnan(point(1,1)) && ~isinf(point(1,1)) && (abs(ndegrees-rad2deg(angle2Points([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)])))<=45||abs(ndegrees-rad2deg(angle2Points([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)])))>=315||abs(ndegrees-rad2deg(angle2Points([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)])))>=135&&abs(ndegrees-rad2deg(angle2Points([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)])))<=225)
                                vpts=vertcat(vpts,point);
                            end
                        end
                    end
                    
                    
                    if ~isempty(vpts)
                        rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                        if isempty(rv)
                            vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                        end
                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                        
                        if length(vpts(:,1))>1
                            aa=centroid(vpts);
                            pts(b,1)=aa(1,1);
                            pts(b,2)=aa(1,2);
                        end
                    end
                end
            end
            
            pseq=pts;
            
            if ~isempty(pseq)
                NP=[centre_pts(c1,1) centre_pts(c1,2)];
                [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                NP=vertcat(NP, MP);
                NP=vertcat(NP, [centre_pts(c2,1) centre_pts(c2,2)]);
                Mdist=[NP(:,1) NP(:,2)];
                Y = pdist(Mdist,'euclid');
                SQ=squareform(Y);
                mclusters=zeros(length(Mdist), 1);
                Mdist(:,3)=1;
                for k=1:length(SQ(:,:))
                    SQ(k,k)=100000.0;
                end
                
                %finding sequence of point cloud
                j=1;
                idxk=1;
                minip=100000.0;
                while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                    if length(idxk)>1
                        index=0;
                        for h=1:length(idxk)
                            mindist=min(SQ(idxk(h),:));
                            if mindist<=minip
                                minip=mindist;
                                index=h;
                            end
                        end
                        resi=find(SQ(idxk(index),:)==minip);
                        mclusters(j)=idxk(index);
                        minip=100000.0;
                        j=j+1;
                    else
                        mindist=min(SQ(idxk,:));
                        resi=find(SQ(idxk,:)==mindist);
                        mclusters(j)=idxk;
                        j=j+1;
                    end
                    
                    if length(NP(:,1))==idxk
                        break;
                    end
                    
                    SQ(idxk,:)=100000;
                    SQ(:,resi)=100000;
                    
                    if idxk==1
                        SQ(:,idxk)=100000;
                    end
                    
                    curr=resi;
                    idxk=curr;
                end
                
                f=mclusters~=0;
                tempc=mclusters(f);
                clear mclusters;
                mclusters=tempc;
                clear tempc;
                
                temp=Mdist(mclusters(2:length(mclusters)-1),:);
                ppseq=temp;
                if ~isempty(ppseq)
                    for h=1:length(ppseq(:,1))
                        nnets=vertcat(nnets,[g ppseq(h,1) ppseq(h,2) length(rx)]);
                    end
                end
            end
        end
    end
end

rc=find(lk(:,1)>=minx&lk(:,1)<=maxx&lk(:,2)>=miny&lk(:,2)<=maxy&lk(:,3)>=minx&lk(:,3)<=maxx&lk(:,4)>=miny&lk(:,4)<=maxy);
lk=lk(rc,:);

netsections=nnets;
rx=find(cluster_to_tr(:,3)==0);
cluster_to_tr(rx,:)=[];

fprintf('Calculating link samples network distance\n');

% calculate polyline dist
for g=1:length(cluster_to_tr(:,1))
    rx=find(netsections(:,1)==cluster_to_tr(g,3));
    rc=find(netnodes(:,1)==cluster_to_tr(g,3));
    c1=find(centre_pts(:,3)==cluster_to_tr(g,1));
    c2=find(centre_pts(:,3)==cluster_to_tr(g,2));
    d=0;
    if isempty(rx)
        xy=[centre_pts(c1,1) centre_pts(c1,2)];
        xy=vertcat(xy,[centre_pts(c2,1) centre_pts(c2,2)]);
        d = polylineLength(xy,'open');
        cluster_to_tr(g,6)=d;
        netnodes(rc,4)=d;
    else
        xy=[centre_pts(c1,1) centre_pts(c1,2)];
        xy=vertcat(xy,[netsections(rx,2) netsections(rx,3)]);
        xy=vertcat(xy,[centre_pts(c2,1) centre_pts(c2,2)]);
        d = polylineLength(xy,'open');
        cluster_to_tr(g,6)=d;
        netnodes(rc,4)=d;
    end
end

temp_netsections=netsections;
temp_netnodes=netnodes;
temp_cluster_to_tr=cluster_to_tr;
temp_centre=centre_pts;

cnt=0;

% clean cluster_to_tr
% after that len(netnodes)=len(cluster_to_tr)
toremove=[];
for k=1:length(cluster_to_tr)
    sres=find(netnodes(:,1)==cluster_to_tr(k,3));
    if isempty(sres)
        toremove=vertcat(toremove,cluster_to_tr(k,3));
    end
end

for k=1:length(toremove)
    r=find(cluster_to_tr(:,3)==toremove(k));
    if ~isempty(r)
        cluster_to_tr(r,:)=[];
    end
end

toremove=[];
for k=1:length(netnodes(:,1))
    sres=find(cluster_to_tr(:,3)==netnodes(k,1));
    if isempty(sres)
        toremove=vertcat(toremove,netnodes(k,1));
    end
end

for k=1:length(toremove)
    r=find(netnodes(:,1)==toremove(k));
    if ~isempty(r)
        netnodes(r,:)=[];
    end
end

% calculating incoming-outgoing degrees
for g=1:length(netnodes(:,1))
    res=find(netsections(:,1)==netnodes(g,1));
    sres=find(cluster_to_tr(:,3)==netnodes(g,1));
    if ~isempty(res) && ~isempty(sres)
        
        resc1=find(centre_pts(:,3)==cluster_to_tr(sres,1));
        resc2=find(centre_pts(:,3)==cluster_to_tr(sres,2));
        
        st(1,1)=centre_pts(resc1,1);
        st(1,2)=centre_pts(resc1,2);
        en(1,1)=centre_pts(resc2,1);
        en(1,2)=centre_pts(resc2,2);
        
        mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(1),2), netsections(res(1),3)]));
        netsections(res(1),4)=mdegrees1;
        if length(res)>1
            for m=1:(length(res)-1)
                if m==1 % outgoing direction
                    mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                    netsections(res(m),4)=mdegrees1;
                    if length(res)>1
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                        netsections(res(m),5)=mdegrees2;
                    else
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2),netsections(res(m),3)],[en(1,1), en(1,2)]));
                        netsections(res(m),5)=mdegrees2;
                    end
                end
                if m==(length(res)-1)
                    if m>1
                        mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                    else
                        mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                    end
                    
                    mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                    netsections(res(m),5)=mdegrees2;
                    
                    mdegrees1=mdegrees2;
                    netsections(res(m+1),4)=mdegrees1;
                end
                if m<length(res)&&m>1
                    mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                    netsections(res(m),4)=mdegrees1;
                    mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                    netsections(res(m),5)=mdegrees2;
                end
            end
        end
        mdegrees2=rad2deg(angle2Points([netsections(res(length(res)),2),netsections(res(length(res)),3)],[en(1,1), en(1,2)]));
        netsections(res(length(res)),5)=mdegrees2;
    end
end

% clean the same starting and ending nodes
ntoremove=[];
for i=1:length(netnodes(:,1))
    r=find(cluster_to_tr(:,3)==netnodes(i,1));
    if cluster_to_tr(r,1)==cluster_to_tr(r,2)
        ntoremove=vertcat(ntoremove,netnodes(i,1));
    end
end

for i=1:length(ntoremove)
    r=find(netnodes(:,1)==ntoremove(i));
    if ~isempty(r)
        netnodes(r,:)=[];
    end
    r=find(cluster_to_tr(:,3)==ntoremove(i));
    if ~isempty(r)
        cluster_to_tr(r,:)=[];
    end
    r=find(netsections(:,1)==ntoremove(i));
    if ~isempty(r)
        r=unique(r);
        h=length(r);
        while h>=1
            netsections(r(h),:)=[];
            h=h-1;
        end
    end
end

nodes=[];
for k=1:length(netnodes(:,1))
    r=find(cluster_to_tr(:,3)==netnodes(k,1));
    nodes=vertcat(nodes, cluster_to_tr(r,1));
    nodes=vertcat(nodes, cluster_to_tr(r,2));
end

nodes=unique(nodes, 'rows');
cnt=0;
for k=1:length(nodes(:,1))
    r=[];
    r=find(cluster_to_tr(:,1)==nodes(k));
    nodes(k,2)=length(r);
    r=[];
    r=find(cluster_to_tr(:,2)==nodes(k));
    nodes(k,3)=length(r);
    r=find(centre_pts(:,3)==nodes(k));
    cnt=cnt+centre_pts(r,6);
end

idx=[];
for k=1:length(cluster_to_tr(:,1))
    c1=find(centre_pts(:,3)==cluster_to_tr(k,1));
    c2=find(centre_pts(:,3)==cluster_to_tr(k,2));
    rs=find(netsections(:,1)==cluster_to_tr(k,3));
    dd=(centre_pts(c1,8)+centre_pts(c2,8))/2;
    if isempty(rs)
        midp=midPoint([centre_pts(c1,1) centre_pts(c1,2) centre_pts(c2,1) centre_pts(c2,2)]);
        
        x1=midp(1,1)+10;
        y1=midp(1,2)+10;
        x2=midp(1,1)+10;
        y2=midp(1,2)-10;
        x3=midp(1,1)-10;
        y3=midp(1,2)+10;
        x4=midp(1,1)-10;
        y4=midp(1,2)-10;
        
        x=[x1 x2 x3 x4];
        x=vertcat(x,[y1 y2 y3 y4]);
        mb=minBoundingBox(x);
        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
        in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
        in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
        
        rs1=find(in1==1);
        rs2=find(in2==1);
        rss=union(rs1,rs2,'rows');
        
        in=createLine([centre_pts(c1,1) centre_pts(c1,2)],[midp(1,1) midp(1,2)]);
        e1 =orthogonalLine(in, [midp(1,1) midp(1,2)]);
        ce1=createEdge(e1,15);
        tr1 = createRotation([midp(1,1) midp(1,2)], 0);
        tr2 = createRotation([midp(1,1) midp(1,2)], pi);
        dest1 = transformEdge(ce1,tr1);
        dest2 = transformEdge(ce1,tr2);
        
        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
        
        vpts=[];
        for h=1:length(rss)
            if slk(rss(h),1)~=midp(1,1)&slk(rss(h),2)~=midp(1,2)&slk(rss(h),3)~=midp(1,1)&slk(rss(h),4)~=midp(1,2)
                e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                point = intersectEdges(ce1, e2);
                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                    vpts=vertcat(vpts,point);
                end
            end
        end
        
        if isempty(vpts)
            idx=vertcat(idx,k);
        end
    end
end

for k=1:length(idx)
    r=find(netnodes(:,1)==cluster_to_tr(idx(k),3));
    if ~isempty(r)
        netnodes(r,:)=[];
    end
end
cluster_to_tr(idx,:)=[];

toremove=[];
for k=1:length(netnodes(:,1))
    sres=find(cluster_to_tr(:,3)==netnodes(k,1));
    if isempty(sres)
        toremove=vertcat(toremove,netnodes(k,1));
    end
end

for k=1:length(toremove)
    r=find(netnodes(:,1)==toremove(k));
    if ~isempty(r)
        netnodes(r,:)=[];
    end
end


elk=slk;

res=[];
temp_netsections=netsections;
temp_netnodes=netnodes;
temp_cluster_to_tr=cluster_to_tr;
temp_centre=centre_pts;
iter=1;
times=1;
hold on;

tempnet=sortrows(netnodes,-4);
netnodes=tempnet;

classdx(1)=100;
classdx(2)=200;
classdx(3)=300;
classdx(4)=400;
classdx(5)=500;
classdx(6)=600;
classdx(7)=700;
classdx(8)=800;
classdx(9)=900;
classdx(10)=1000;

classdy(1)=15;
classdy(2)=25;
classdy(3)=30;
classdy(4)=35;
classdy(5)=50;
classdy(6)=60;
classdy(7)=70;
classdy(8)=80;
classdy(9)=90;
classdy(10)=100;

aclass(1)=30;
aclass(2)=60;
aclass(3)=90;
aclass(4)=120;
aclass(5)=150;
aclass(6)=180;
aclass(7)=210;
aclass(8)=240;
aclass(9)=270;
aclass(10)=300;
aclass(11)=330;
aclass(12)=360;

clear inter_to_tr;
clear tempcluster;
clear tempcluster2;
clear inter_to_cluster;

netnodes(:,5)=1;
netnodes(:,6)=0;
netnodes(:,7)=0;
netnodes(:,8)=0;
gscounter=2;

k=1;
rlen=length(netnodes(:,1));
distances=[];
distances1=[];
temp=[];
currlen=length(cluster_to_tr(:,1));
prevlen=0;
scounter=1;

temp_netsections=netsections;
temp_netnodes=netnodes;
temp_cluster_to_tr=cluster_to_tr;
temp_centre=centre_pts;

sss=0;
hold on;
tcase=[];
ccase=[];
d=[];

fprintf('Merging link samples into links\n');

while prevlen~=rlen && scounter<=gscounter
    
    prevlen=rlen;
    maxclen=length(centre_pts(:,1));
    maxk=netnodes(rlen,1);
    while (k<=rlen && netnodes(k,1)<=maxk)||k<=rlen
        netnodes(k,8)=netnodes(k,8)+1;
        res=find(netsections(:,1)==netnodes(k,1));
        sres=find(cluster_to_tr(:,3)==netnodes(k,1));
        
        if ~isempty(res) && ~isempty(sres)
            c1=find(centre_pts(:,3)==cluster_to_tr(sres,1));
            c2=find(centre_pts(:,3)==cluster_to_tr(sres,2));
            st(1,1)=centre_pts(c1,1);
            st(1,2)=centre_pts(c1,2);
            en(1,1)=centre_pts(c2,1);
            en(1,2)=centre_pts(c2,2);
            dy=abs(centre_pts(c1,2)-centre_pts(c2,2));
            nxtfl=[];
            prvfl=[];
            
            memf=c2;
            sid=1;
            minids=[];
            mid=1;
            
            bbox=[];
            rbbox=[];
            bbox2=[];
            rbbox2=[];
            c4=[];
            intermediate2=[];
            
            for t=1:length(res)
                gdy=0;
                if t==1
                    ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(t),2),netsections(res(t),3)]);
                    dx1=sqrt((centre_pts(c1,1)-netsections(res(t),2))^2+(centre_pts(c1,2)-netsections(res(t),3))^2);
                    distances=vertcat(distances,[dx1 k]);
                    
                    if dx1<=classdx(1)
                        dy=classdy(1);
                    elseif dx1>classdx(1)&&dx1<=classdx(2)
                        dy=classdy(2);
                    elseif dx1>classdx(2)&&dx1<=classdx(3)
                        dy=classdy(3);
                    elseif dx1>classdx(3)&&dx1<=classdx(4)
                        dy=classdy(4);
                    elseif dx1>classdx(4)
                        dy=classdy(5);
                    end
                    
                    if length(res)>1
                        pdegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                    else
                        pdegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                    end
                    
                    if scounter>10
                        dy1=20;
                        dy2=20;
                        gdy=15;
                    elseif scounter<=10
                        if cluster_to_tr(sres,5)~=0
                            if cluster_to_tr(sres,5)<=50
                                dy1=cluster_to_tr(sres,5)+5;
                                dy2=cluster_to_tr(sres,5)+5;
                                gdy=20;
                            else
                                dy1=cluster_to_tr(sres,5);
                                dy2=cluster_to_tr(sres,5);
                                gdy=20;
                            end
                            
                        else
                            dy1=45;
                            dy2=45;
                            gdy=20;
                        end
                    end
                    
                    x1=centre_pts(c1,1)+(dy1)*cosd(ndegrees-90);
                    y1=centre_pts(c1,2)+(dy1)*sind(ndegrees-90);
                    x2=centre_pts(c1,1)+(dy2)*cosd(ndegrees+90);
                    y2=centre_pts(c1,2)+(dy2)*sind(ndegrees+90);
                    x3=netsections(res(1),2)+(dy1)*cosd(ndegrees-90);
                    y3=netsections(res(1),3)+(dy1)*sind(ndegrees-90);
                    x4=netsections(res(1),2)+(dy2)*cosd(ndegrees+90);
                    y4=netsections(res(1),3)+(dy2)*sind(ndegrees+90);
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    
                    in = inpolygon(centre_pts(:,1),centre_pts(:,2),mb(1,:),mb(2,:));
                    c4=vertcat(c4,centre_pts(in,3));
                    
                    in = inpolygon(pts_ln.pts_ln(:,1),pts_ln.pts_ln(:,2),mb(1,:),mb(2,:));
                    intermediate2=vertcat(intermediate2,[pts_ln.pts_ln(in,1),pts_ln.pts_ln(in,2)]);
                    
                    
                    node=[x1 y1;x3 y3];
                    rbbox=vertcat(rbbox,[x2 y2]);
                    rbbox=vertcat(rbbox,[x4 y4]);
                    bbox=vertcat(bbox,[node(:,1) node(:,2)]);
                    
                    x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                    y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                    x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                    y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                    x3=netsections(res(1),2)+(gdy)*cosd(ndegrees-90);
                    y3=netsections(res(1),3)+(gdy)*sind(ndegrees-90);
                    x4=netsections(res(1),2)+(gdy)*cosd(ndegrees+90);
                    y4=netsections(res(1),3)+(gdy)*sind(ndegrees+90);
                    
                    node=[x1 y1;x3 y3];
                    rbbox2=vertcat(rbbox2,[x2 y2]);
                    rbbox2=vertcat(rbbox2,[x4 y4]);
                    bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                end
                if t==length(res)
                    ndegrees=line_angle([netsections(res(length(res)),2),netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                    dy=abs(centre_pts(c2,2)-netsections(res(length(res)),3));
                    dx1=sqrt((centre_pts(c2,1)-netsections(res(length(res)),2))^2+(centre_pts(c2,2)-netsections(res(length(res)),3))^2);
                    distances=vertcat(distances,[dx1 k]);
                    
                    if dx1<=classdx(1)
                        dy=classdy(1);
                    elseif dx1>classdx(1)&&dx1<=classdx(2)
                        dy=classdy(2);
                    elseif dx1>classdx(2)&&dx1<=classdx(3)
                        dy=classdy(3);
                    elseif dx1>classdx(3)&&dx1<=classdx(4)
                        dy=classdy(4);
                    elseif dx1>classdx(4)
                        dy=classdy(5);
                    end
                    
                    if length(res)>1
                        pdegrees=line_angle([netsections(res(length(res)-1),2),netsections(res(length(res)-1),3)],[netsections(res(length(res)),2),netsections(res(length(res)),3)]);
                    else
                        pdegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(length(res)),2),netsections(res(length(res)),3)]);
                    end
                    
                    if scounter>10
                        dy1=20;
                        dy2=20;
                        gdy=15;
                    elseif scounter<=10
                        if cluster_to_tr(sres,5)~=0
                            if cluster_to_tr(sres,5)<=50
                                dy1=cluster_to_tr(sres,5)+5;
                                dy2=cluster_to_tr(sres,5)+5;
                                gdy=20;
                            else
                                dy1=cluster_to_tr(sres,5);
                                dy2=cluster_to_tr(sres,5);
                                gdy=20;
                            end
                            
                        else
                            dy1=45;
                            dy2=45;
                            gdy=20;
                        end
                    end
                    
                    x1=netsections(res(length(res)),2)+(dy1)*cosd(ndegrees-90);
                    y1=netsections(res(length(res)),3)+(dy1)*sind(ndegrees-90);
                    x2=netsections(res(length(res)),2)+(dy2)*cosd(ndegrees+90);
                    y2=netsections(res(length(res)),3)+(dy2)*sind(ndegrees+90);
                    x3=centre_pts(c2,1)+(dy1)*cosd(ndegrees-90);
                    y3=centre_pts(c2,2)+(dy1)*sind(ndegrees-90);
                    x4=centre_pts(c2,1)+(dy2)*cosd(ndegrees+90);
                    y4=centre_pts(c2,2)+(dy2)*sind(ndegrees+90);
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    
                    in = inpolygon(centre_pts(:,1),centre_pts(:,2),mb(1,:),mb(2,:));
                    c4=vertcat(c4,centre_pts(in,3));
                    
                    in = inpolygon(pts_ln.pts_ln(:,1),pts_ln.pts_ln(:,2),mb(1,:),mb(2,:));
                    intermediate2=vertcat(intermediate2,[pts_ln.pts_ln(in,1),pts_ln.pts_ln(in,2)]);
                    
                    node=[x3 y3];
                    rbbox=vertcat(rbbox,[x4 y4]);
                    bbox=vertcat(bbox,[node(:,1) node(:,2)]);
                    
                    x1=netsections(res(length(res)),2)+(gdy)*cosd(ndegrees-90);
                    y1=netsections(res(length(res)),3)+(gdy)*sind(ndegrees-90);
                    x2=netsections(res(length(res)),2)+(gdy)*cosd(ndegrees+90);
                    y2=netsections(res(length(res)),3)+(gdy)*sind(ndegrees+90);
                    x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                    y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                    x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                    y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                    
                    node=[x3 y3];
                    rbbox2=vertcat(rbbox2,[x4 y4]);
                    bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                end
                if t<length(res)
                    ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                    dy=abs(netsections(res(t+1),3)-netsections(res(t),3));
                    dx1=sqrt((netsections(res(t),2)-netsections(res(t+1),2))^2+(netsections(res(t),3)-netsections(res(t+1),3))^2);
                    distances=vertcat(distances,[dx1 k]);
                    
                    if dx1<=classdx(1)
                        dy=classdy(1);
                    elseif dx1>classdx(1)&&dx1<=classdx(2)
                        dy=classdy(2);
                    elseif dx1>classdx(2)&&dx1<=classdx(3)
                        dy=classdy(3);
                    elseif dx1>classdx(3)&&dx1<=classdx(4)
                        dy=classdy(4);
                    elseif dx1>classdx(4)
                        dy=classdy(5);
                    end
                    
                    if (t+2)<=length(res)
                        pdegrees=line_angle([netsections(res(t+1),2),netsections(res(t+1),3)],[netsections(res(t+2),2),netsections(res(t+2),3)]);
                    else
                        pdegrees=line_angle([netsections(res(t+1),2),netsections(res(t+1),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                    end
                    
                    if scounter>10
                        dy1=20;
                        dy2=20;
                        gdy=15;
                    elseif scounter<=10
                        if cluster_to_tr(sres,5)~=0
                            if cluster_to_tr(sres,5)<=50
                                dy1=cluster_to_tr(sres,5)+5;
                                dy2=cluster_to_tr(sres,5)+5;
                                gdy=20;
                            else
                                dy1=cluster_to_tr(sres,5);
                                dy2=cluster_to_tr(sres,5);
                                gdy=20;
                            end
                            
                        else
                            dy1=45;
                            dy2=45;
                            gdy=20;
                        end
                    end
                    
                    x1=netsections(res(t),2)+(dy1)*cosd(ndegrees-90);
                    y1=netsections(res(t),3)+(dy1)*sind(ndegrees-90);
                    x2=netsections(res(t),2)+(dy2)*cosd(ndegrees+90);
                    y2=netsections(res(t),3)+(dy2)*sind(ndegrees+90);
                    x3=netsections(res(t+1),2)+(dy1)*cosd(ndegrees-90);
                    y3=netsections(res(t+1),3)+(dy1)*sind(ndegrees-90);
                    x4=netsections(res(t+1),2)+(dy2)*cosd(ndegrees+90);
                    y4=netsections(res(t+1),3)+(dy2)*sind(ndegrees+90);
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    
                    in = inpolygon(centre_pts(:,1),centre_pts(:,2),mb(1,:),mb(2,:));
                    c4=vertcat(c4,centre_pts(in,3));
                    
                    in = inpolygon(pts_ln.pts_ln(:,1),pts_ln.pts_ln(:,2),mb(1,:),mb(2,:));
                    intermediate2=vertcat(intermediate2,[pts_ln.pts_ln(in,1),pts_ln.pts_ln(in,2)]);
                    
                    node=[x3 y3];
                    rbbox=vertcat(rbbox,[x4 y4]);
                    bbox=vertcat(bbox,[node(:,1) node(:,2)]);
                    
                    x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                    y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                    x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                    y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                    x3=netsections(res(t+1),2)+(gdy)*cosd(ndegrees-90);
                    y3=netsections(res(t+1),3)+(gdy)*sind(ndegrees-90);
                    x4=netsections(res(t+1),2)+(gdy)*cosd(ndegrees+90);
                    y4=netsections(res(t+1),3)+(gdy)*sind(ndegrees+90);
                    
                    node=[x3 y3];
                    rbbox2=vertcat(rbbox2,[x4 y4]);
                    bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                end
            end
            intermediate2(:,3)=1;
            ni=length(rbbox(:,1));
            
            while ni>=1
                bbox=vertcat(bbox,[rbbox(ni,1) rbbox(ni,2)]);
                ni=ni-1;
            end
            bbox=vertcat(bbox,[bbox(1,1) bbox(1,2)]);
            
            ni=length(rbbox2(:,1));
            
            while ni>=1
                bbox2=vertcat(bbox2,[rbbox2(ni,1) rbbox2(ni,2)]);
                ni=ni-1;
            end
            bbox2=vertcat(bbox2,[bbox2(1,1) bbox2(1,2)]);
            
            if scounter>5
                x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                
                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                bbox2=node;
            end
            
            c4=unique(c4,'rows');
            
            hold on;
            nsegs=[];
            validids=[];
            segscl=[];
            poly1=[centre_pts(c1,1) centre_pts(c1,2)];
            poly1=vertcat(poly1,[netsections(res,2) netsections(res,3)]);
            poly1=vertcat(poly1,[centre_pts(c2,1) centre_pts(c2,2)]);
            cx=[];
            cnt=0;
            
            
            
            if ~isempty(c4)
                intermediate=[];
                split=[];
                for h=1:length(c4)
                    rc=find(cluster_to_tr(:,1)==c4(h)|cluster_to_tr(:,2)==c4(h));
                    
                    if isempty(rc)
                        for t=1:length(res)
                            
                            if t==1
                                rcen=find(centre_pts(:,3)==c4(h));
                                Ddist=vertcat([centre_pts(rcen,1) centre_pts(rcen,2)]);
                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                if d<=10
                                    rcv=find(centre_pts(:,3)==c4(h));
                                    validids=vertcat(validids, [rcv centre_pts(rcv,6)]);
                                end
                            end
                            if t==length(res)
                                rcen=find(centre_pts(:,3)==c4(h));
                                Ddist=vertcat([centre_pts(rcen,1) centre_pts(rcen,2)]);
                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                if d<=10
                                    rcv=find(centre_pts(:,3)==c4(h));
                                    validids=vertcat(validids, [rcv centre_pts(rcv,6)]);
                                end
                            end
                            if t<length(res)
                                rcen=find(centre_pts(:,3)==c4(h));
                                Ddist=vertcat([centre_pts(rcen,1) centre_pts(rcen,2)]);
                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                if d<=10
                                    rcv=find(centre_pts(:,3)==c4(h));
                                    validids=vertcat(validids, [rcv centre_pts(rcv,6)]);
                                end
                            end
                            
                        end
                    else
                        for n=1:length(rc)
                            
                            flag=0;
                            segment=[];
                            maxd=0;
                            if cluster_to_tr(rc(n),1)==cluster_to_tr(sres,1)&&cluster_to_tr(rc(n),2)==cluster_to_tr(sres,2)
                                continue;
                            elseif cluster_to_tr(rc(n),1)==cluster_to_tr(sres,2)&&cluster_to_tr(rc(n),2)==cluster_to_tr(sres,1)
                                rw=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                netnodes(k,2)=netnodes(k,2)+netnodes(rw,2);
                                netnodes(k,4)=2;
                                nsegs=vertcat(nsegs,[cluster_to_tr(rc(n),3),2]);
                                continue;
                            else
                                memcntr=0;
                                rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                rn=find(netsections(:,1)==cluster_to_tr(rc(n),3));
                                ri=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                if ~isempty(ri)
                                    riw=netnodes(ri,2);
                                end
                                segment=[centre_pts(rc1,1) centre_pts(rc1,2)];
                                segment=vertcat(segment, [netsections(rn,2) netsections(rn,3)]);
                                segment=vertcat(segment, [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                segment(:,3)=0;
                                
                                if isempty(rn)
                                    poly2=[centre_pts(rc1,1) centre_pts(rc1,2)];
                                    poly2=vertcat(poly2,[centre_pts(rc2,1) centre_pts(rc2,2)]);
                                    
                                else
                                    poly2=[centre_pts(rc1,1) centre_pts(rc1,2)];
                                    poly2=vertcat(poly2,[netsections(rn,2) netsections(rn,3)]);
                                    poly2=vertcat(poly2,[centre_pts(rc2,1) centre_pts(rc2,2)]);
                                end
                                
                                
                                
                                for t=1:length(res)
                                    
                                    if t==1
                                        dy=abs(centre_pts(c1,2)-netsections(res(t),3));
                                        ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(t),2),netsections(res(t),3)]);
                                        dx1=sqrt((centre_pts(c1,1)-netsections(res(t),2))^2+(centre_pts(c1,2)-netsections(res(t),3))^2);
                                        if dx1<=classdx(1)
                                            dy=classdy(1);
                                        elseif dx1>classdx(1)&&dx1<=classdx(2)
                                            dy=classdy(2);
                                        elseif dx1>classdx(2)&&dx1<=classdx(3)
                                            dy=classdy(3);
                                        elseif dx1>classdx(3)&&dx1<=classdx(4)
                                            dy=classdy(4);
                                        elseif dx1>classdx(4)
                                            dy=classdy(5);
                                        end
                                        
                                        if dy>maxd
                                            maxd=dy;
                                        end
                                        
                                        if length(res)>1
                                            pdegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                                        else
                                            pdegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                        end
                                        
                                        if scounter>10
                                            dy1=20;
                                            dy2=20;
                                            gdy=15;
                                        elseif scounter<=10
                                            if cluster_to_tr(sres,5)~=0
                                                if cluster_to_tr(sres,5)<=50
                                                    dy1=cluster_to_tr(sres,5)+5;
                                                    dy2=cluster_to_tr(sres,5)+5;
                                                    gdy=20;
                                                else
                                                    dy1=cluster_to_tr(sres,5);
                                                    dy2=cluster_to_tr(sres,5);
                                                    gdy=20;
                                                end
                                                
                                            else
                                                dy1=45;
                                                dy2=45;
                                                gdy=20;
                                            end
                                        end
                                        
                                        if ndegrees>=0 && ndegrees<90
                                            x1=centre_pts(c1,1)+(dy1)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy1)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy2)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy2)*sind(ndegrees+90);
                                            x3=netsections(res(1),2)+(dy1)*cosd(ndegrees-90);
                                            y3=netsections(res(1),3)+(dy1)*sind(ndegrees-90);
                                            x4=netsections(res(1),2)+(dy2)*cosd(ndegrees+90);
                                            y4=netsections(res(1),3)+(dy2)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>=295 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>=295 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                                
                                            end
                                        elseif ndegrees>=90 && ndegrees<180
                                            x1=centre_pts(c1,1)+(dy2)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy2)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy1)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy1)*sind(ndegrees+90);
                                            x3=netsections(res(1),2)+(dy2)*cosd(ndegrees-90);
                                            y3=netsections(res(1),3)+(dy2)*sind(ndegrees-90);
                                            x4=netsections(res(1),2)+(dy1)*cosd(ndegrees+90);
                                            y4=netsections(res(1),3)+(dy1)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=180 && ndegrees<270
                                            x1=centre_pts(c1,1)+(dy1)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy1)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy2)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy2)*sind(ndegrees+90);
                                            x3=netsections(res(1),2)+(dy1)*cosd(ndegrees-90);
                                            y3=netsections(res(1),3)+(dy1)*sind(ndegrees-90);
                                            x4=netsections(res(1),2)+(dy2)*cosd(ndegrees+90);
                                            y4=netsections(res(1),3)+(dy2)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=270 && ndegrees<=361
                                            x1=centre_pts(c1,1)+(dy2)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy2)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy1)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy1)*sind(ndegrees+90);
                                            x3=netsections(res(1),2)+(dy2)*cosd(ndegrees-90);
                                            y3=netsections(res(1),3)+(dy2)*sind(ndegrees-90);
                                            x4=netsections(res(1),2)+(dy1)*cosd(ndegrees+90);
                                            y4=netsections(res(1),3)+(dy1)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                                
                                                
                                            end
                                        else
                                            
                                            disp(['mpikes4' num2str(ndegrees)])
                                        end
                                    end
                                    if t==length(res)
                                        ndegrees=line_angle([netsections(res(length(res)),2),netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                        dy=abs(centre_pts(c2,2)-netsections(res(length(res)),3));
                                        dx1=sqrt((centre_pts(c2,1)-netsections(res(length(res)),2))^2+(centre_pts(c2,2)-netsections(res(length(res)),3))^2);
                                        if dx1<=classdx(1)
                                            dy=classdy(1);
                                        elseif dx1>classdx(1)&&dx1<=classdx(2)
                                            dy=classdy(2);
                                        elseif dx1>classdx(2)&&dx1<=classdx(3)
                                            dy=classdy(3);
                                        elseif dx1>classdx(3)&&dx1<=classdx(4)
                                            dy=classdy(4);
                                        elseif dx1>classdx(4)
                                            dy=classdy(5);
                                        end
                                        
                                        if dy>maxd
                                            maxd=dy;
                                        end
                                        
                                        if length(res)>1
                                            pdegrees=line_angle([netsections(res(length(res)-1),2),netsections(res(length(res)-1),3)],[netsections(res(length(res)),2),netsections(res(length(res)),3)]);
                                        else
                                            pdegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(length(res)),2),netsections(res(length(res)),3)]);
                                        end
                                        
                                        if scounter>10
                                            dy1=20;
                                            dy2=20;
                                            gdy=15;
                                        elseif scounter<=10
                                            if cluster_to_tr(sres,5)~=0
                                                if cluster_to_tr(sres,5)<=50
                                                    dy1=cluster_to_tr(sres,5)+5;
                                                    dy2=cluster_to_tr(sres,5)+5;
                                                    gdy=20;
                                                else
                                                    dy1=cluster_to_tr(sres,5);
                                                    dy2=cluster_to_tr(sres,5);
                                                    gdy=20;
                                                end
                                                
                                            else
                                                dy1=45;
                                                dy2=45;
                                                gdy=20;
                                            end
                                        end
                                        
                                        if ndegrees>=0 && ndegrees<90
                                            x1=netsections(res(length(res)),2)+(dy1)*cosd(ndegrees-90);
                                            y1=netsections(res(length(res)),3)+(dy1)*sind(ndegrees-90);
                                            x2=netsections(res(length(res)),2)+(dy2)*cosd(ndegrees+90);
                                            y2=netsections(res(length(res)),3)+(dy2)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy1)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy1)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy2)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy2)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                            
                                            
                                        elseif ndegrees>=90 && ndegrees<180
                                            x1=netsections(res(length(res)),2)+(dy2)*cosd(ndegrees-90);
                                            y1=netsections(res(length(res)),3)+(dy2)*sind(ndegrees-90);
                                            x2=netsections(res(length(res)),2)+(dy1)*cosd(ndegrees+90);
                                            y2=netsections(res(length(res)),3)+(dy1)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy2)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy2)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy1)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy1)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=180 && ndegrees<270
                                            x1=netsections(res(length(res)),2)+(dy1)*cosd(ndegrees-90);
                                            y1=netsections(res(length(res)),3)+(dy1)*sind(ndegrees-90);
                                            x2=netsections(res(length(res)),2)+(dy2)*cosd(ndegrees+90);
                                            y2=netsections(res(length(res)),3)+(dy2)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy1)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy1)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy2)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy2)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=270 && ndegrees<=361
                                            x1=netsections(res(length(res)),2)+(dy2)*cosd(ndegrees-90);
                                            y1=netsections(res(length(res)),3)+(dy2)*sind(ndegrees-90);
                                            x2=netsections(res(length(res)),2)+(dy1)*cosd(ndegrees+90);
                                            y2=netsections(res(length(res)),3)+(dy1)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy2)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy2)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy1)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy1)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        else disp(['mpikes5' num2str(ndegrees)])
                                        end
                                    end
                                    if t<length(res)
                                        ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                                        dy=abs(netsections(res(t+1),3)-netsections(res(t),3));
                                        dx1=sqrt((netsections(res(t),2)-netsections(res(t+1),2))^2+(netsections(res(t),3)-netsections(res(t+1),3))^2);
                                        if dx1<=classdx(1)
                                            dy=classdy(1);
                                        elseif dx1>classdx(1)&&dx1<=classdx(2)
                                            dy=classdy(2);
                                        elseif dx1>classdx(2)&&dx1<=classdx(3)
                                            dy=classdy(3);
                                        elseif dx1>classdx(3)&&dx1<=classdx(4)
                                            dy=classdy(4);
                                        elseif dx1>classdx(4)
                                            dy=classdy(5);
                                        end
                                        
                                        if dy>maxd
                                            maxd=dy;
                                        end
                                        
                                        if (t+2)<=length(res)
                                            pdegrees=line_angle([netsections(res(t+1),2),netsections(res(t+1),3)],[netsections(res(t+2),2),netsections(res(t+2),3)]);
                                        else
                                            pdegrees=line_angle([netsections(res(t+1),2),netsections(res(t+1),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                        end
                                        
                                        if scounter>10
                                            dy1=20;
                                            dy2=20;
                                            gdy=15;
                                        elseif scounter<=10
                                            if cluster_to_tr(sres,5)~=0
                                                if cluster_to_tr(sres,5)<=50
                                                    dy1=cluster_to_tr(sres,5)+5;
                                                    dy2=cluster_to_tr(sres,5)+5;
                                                    gdy=20;
                                                else
                                                    dy1=cluster_to_tr(sres,5);
                                                    dy2=cluster_to_tr(sres,5);
                                                    gdy=20;
                                                end
                                                
                                            else
                                                dy1=45;
                                                dy2=45;
                                                gdy=20;
                                            end
                                        end
                                        
                                        if ndegrees>=0 && ndegrees<90
                                            x1=netsections(res(t),2)+(dy1)*cosd(ndegrees-90);
                                            y1=netsections(res(t),3)+(dy1)*sind(ndegrees-90);
                                            x2=netsections(res(t),2)+(dy2)*cosd(ndegrees+90);
                                            y2=netsections(res(t),3)+(dy2)*sind(ndegrees+90);
                                            x3=netsections(res(t+1),2)+(dy1)*cosd(ndegrees-90);
                                            y3=netsections(res(t+1),3)+(dy1)*sind(ndegrees-90);
                                            x4=netsections(res(t+1),2)+(dy2)*cosd(ndegrees+90);
                                            y4=netsections(res(t+1),3)+(dy2)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=90 && ndegrees<180
                                            x1=netsections(res(t),2)+(dy2)*cosd(ndegrees-90);
                                            y1=netsections(res(t),3)+(dy2)*sind(ndegrees-90);
                                            x2=netsections(res(t),2)+(dy1)*cosd(ndegrees+90);
                                            y2=netsections(res(t),3)+(dy1)*sind(ndegrees+90);
                                            x3=netsections(res(t+1),2)+(dy2)*cosd(ndegrees-90);
                                            y3=netsections(res(t+1),3)+(dy2)*sind(ndegrees-90);
                                            x4=netsections(res(t+1),2)+(dy1)*cosd(ndegrees+90);
                                            y4=netsections(res(t+1),3)+(dy1)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=180 && ndegrees<270
                                            x1=netsections(res(t),2)+(dy1)*cosd(ndegrees-90);
                                            y1=netsections(res(t),3)+(dy1)*sind(ndegrees-90);
                                            x2=netsections(res(t),2)+(dy2)*cosd(ndegrees+90);
                                            y2=netsections(res(t),3)+(dy2)*sind(ndegrees+90);
                                            x3=netsections(res(t+1),2)+(dy1)*cosd(ndegrees-90);
                                            y3=netsections(res(t+1),3)+(dy1)*sind(ndegrees-90);
                                            x4=netsections(res(t+1),2)+(dy2)*cosd(ndegrees+90);
                                            y4=netsections(res(t+1),3)+(dy2)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        elseif ndegrees>=270 && ndegrees<=361
                                            x1=netsections(res(t),2)+(dy2)*cosd(ndegrees-90);
                                            y1=netsections(res(t),3)+(dy2)*sind(ndegrees-90);
                                            x2=netsections(res(t),2)+(dy1)*cosd(ndegrees+90);
                                            y2=netsections(res(t),3)+(dy1)*sind(ndegrees+90);
                                            x3=netsections(res(t+1),2)+(dy2)*cosd(ndegrees-90);
                                            y3=netsections(res(t+1),3)+(dy2)*sind(ndegrees-90);
                                            x4=netsections(res(t+1),2)+(dy1)*cosd(ndegrees+90);
                                            y4=netsections(res(t+1),3)+(dy1)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            if ~isempty(rn)
                                                for o=1:length(rn)
                                                    if o==1
                                                        [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                        if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(o+1,3)=in;
                                                        end
                                                        
                                                    end
                                                    if o==length(rn)
                                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                        pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+2,3)=in;
                                                        end
                                                        [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                                        if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                            segment(length(rn)+1,3)=in;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                                    if o<length(rn)
                                                        pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                                    elseif length(rn)==1
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                                    end
                                                    if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<45||abs(ndegrees-pdegrees)>315 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225)
                                                        segment(o+1,3)=in;
                                                    end
                                                end
                                            else
                                                [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                                [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                
                                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                                
                                                if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                                    if d(1)~=0&&d(2)~=0
                                                        if d(1)<=20&&d(2)<=20 && (in1~=0||in2~=0)
                                                            segment(1,3)=1;
                                                            segment(2,3)=1;
                                                        else
                                                            if d(1)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc1;
                                                                segment(1,3)=1;
                                                            end
                                                            if d(2)<=20 && (in1~=0||in2~=0)
                                                                memcntr=rc2;
                                                                segment(2,3)=1;
                                                            end
                                                        end
                                                    else
                                                        if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                        if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                            
                                                            if in1==1
                                                                validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                            elseif in2==1
                                                                validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                            end
                                                            segment(1,3)=in1;
                                                            segment(2,3)=in2;
                                                        end
                                                    end
                                                else
                                                    if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(1,3)=in;
                                                        if in==1
                                                            memcntr=rc1;
                                                        end
                                                    end
                                                    [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                                    
                                                    if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<225) && (d(1)<=100&&d(2)<=100)
                                                        segment(2,3)=in;
                                                        if in==1
                                                            memcntr=rc2;
                                                        end
                                                    end
                                                end
                                            end
                                        else disp(['mpikes6' num2str(ndegrees)])
                                        end
                                    end
                                    
                                end
                                nrs=find(segment(:,3)==1);
                                
                                
                                if ~isempty(rn) && ~isempty(nrs)
                                    if (length(nrs)/length(segment(:,1)))~=1
                                        if length(nrs)==1 && (centre_pts(rc1,3)==centre_pts(c1,3)||centre_pts(rc1,3)==centre_pts(c2,3)||centre_pts(rc2,3)==centre_pts(c1,3)||centre_pts(rc2,3)==centre_pts(c2,3))
                                        else
                                            if segment(1,3)==0&&segment(length(segment(:,1)),3)==0
                                                g=2;
                                                while g<=(length(segment(:,1))-1)
                                                    if segment(g,3)==1
                                                        intermediate=vertcat(intermediate,[segment(g,1) segment(g,2) riw]);
                                                    end
                                                    g=g+1;
                                                end
                                                
                                            elseif segment(1,3)==0||segment(length(segment(:,1)),3)==0
                                                if segment(1,3)==1
                                                    validids=vertcat(validids, [rc1 cluster_to_tr(rc(n),4)]);
                                                elseif segment(length(segment(:,1)),3)==1
                                                    validids=vertcat(validids, [rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                
                                                g=2;
                                                while g<=(length(segment(:,1))-1)
                                                    if segment(g,3)==1
                                                        intermediate=vertcat(intermediate,[segment(g,1) segment(g,2) riw]);
                                                    end
                                                    g=g+1;
                                                end
                                                
                                                
                                                if length(nrs)>1
                                                    % fix new segment
                                                    if segment(1,3)==0
                                                        new=[];
                                                        g=2;
                                                        new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                        g=g+1;
                                                        while segment(g,3)~=1 && g<=length(segment(:,1))
                                                            new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                            g=g+1;
                                                        end
                                                        
                                                        memcen=[segment(g,1) segment(g,2)];
                                                        pdegrees=line_angle([new(length(new(:,1)),1), new(length(new(:,1)),2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                        
                                                        if centre_pts(rc1,1)~=new(length(new(:,1)),1)&&centre_pts(rc1,2)~=new(length(new(:,1)),2)
                                                            rcen=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                            rcenm=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                            if ~isempty(rcen)%centre1_exists
                                                                rl=find(cluster_to_tr(:,1)==centre_pts(rc1,3) & cluster_to_tr(:,2)==centre_pts(rcen,3));
                                                                if isempty(rl)
                                                                    if centre_pts(rc1,3)~=centre_pts(rcen,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),centre_pts(rcen,3), maxcl, round((centre_pts(rc1,9)+centre_pts(rcen,9))/2), round((centre_pts(rc1,8)+centre_pts(rcen,8))/2), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rcen,1) centre_pts(rcen,2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        if length(new(:,1))>1
                                                                            g=1;
                                                                            while g<length(new(:,1))
                                                                                netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                                g=g+1;
                                                                            end
                                                                        end
                                                                    end
                                                                end
                                                                
                                                                if ~isempty(rcenm)%centre2_exists
                                                                    rl2=find(cluster_to_tr(:,1)==centre_pts(rcen,3) & cluster_to_tr(:,2)==centre_pts(rcenm,3));
                                                                    if isempty(rl2)
                                                                        if centre_pts(rcen,3)~=centre_pts(rcenm,3)
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcen,3),centre_pts(rcenm,3), maxcl, round((centre_pts(rcen,9)+centre_pts(rcenm,9))/2), round((centre_pts(rcen,8)+centre_pts(rcenm,8))/2), distancePoints([centre_pts(rcen,1) centre_pts(rcen,2)], [centre_pts(rcenm,1) centre_pts(rcenm,2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                    end
                                                                else
                                                                    x1=memcen(1,1)+10;
                                                                    y1=memcen(1,2)+10;
                                                                    x2=memcen(1,1)+10;
                                                                    y2=memcen(1,2)-10;
                                                                    x3=memcen(1,1)-10;
                                                                    y3=memcen(1,2)+10;
                                                                    x4=memcen(1,1)-10;
                                                                    y4=memcen(1,2)-10;
                                                                    
                                                                    node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                    in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                    inidx=find(in~=0);
                                                                    if ~isempty(inidx)
                                                                        if length(inidx)>1
                                                                            Pd=[memcen(1,1) memcen(1,2)];
                                                                            Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                            Y = pdist(Pd,'euclid');
                                                                            SQ=squareform(Y);
                                                                            minid=find(SQ(1,:)>0);
                                                                            mindist=min(SQ(minid));
                                                                            rm=find(SQ(1,:)==mindist);
                                                                            if length(rm)>1% two with the same distance
                                                                                maxc=centre_pts(inidx(rm(1)-1),3);
                                                                            else
                                                                                maxc=centre_pts(inidx(rm-1),3);
                                                                            end
                                                                        else
                                                                            maxc=centre_pts(inidx,3);
                                                                        end
                                                                    else
                                                                        rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                        if isempty(rxc)
                                                                            maxc=(max(centre_pts(:,3))+1);
                                                                            centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                        end
                                                                    end
                                                                    
                                                                    rl2=find(cluster_to_tr(:,1)==centre_pts(rcen,3) & cluster_to_tr(:,2)==maxc);
                                                                    if isempty(rl2)
                                                                        if centre_pts(rcen,3)~=maxc
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcen,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rcen,1) centre_pts(rcen,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                    end
                                                                    
                                                                end
                                                                
                                                            else%centre_1_not_exists
                                                                x1=new(length(new(:,1)),1)+10;
                                                                y1=new(length(new(:,1)),2)+10;
                                                                x2=new(length(new(:,1)),1)+10;
                                                                y2=new(length(new(:,1)),2)-10;
                                                                x3=new(length(new(:,1)),1)-10;
                                                                y3=new(length(new(:,1)),2)+10;
                                                                x4=new(length(new(:,1)),1)-10;
                                                                y4=new(length(new(:,1)),2)-10;
                                                                
                                                                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                inidx=find(in~=0);
                                                                mflag=0;
                                                                if ~isempty(inidx)
                                                                    if length(inidx)>1
                                                                        Pd=[new(length(new(:,1)),1), new(length(new(:,1)),2)];
                                                                        Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                        Y = pdist(Pd,'euclid');
                                                                        SQ=squareform(Y);
                                                                        minid=find(SQ(1,:)>0);
                                                                        mindist=min(SQ(minid));
                                                                        rm=find(SQ(1,:)==mindist);
                                                                        if length(rm)>1% two with the same distance
                                                                            maxc=centre_pts(inidx(rm(1)-1),3);
                                                                        else
                                                                            maxc=centre_pts(inidx(rm-1),3);
                                                                        end
                                                                    else
                                                                        maxc=centre_pts(inidx,3);
                                                                    end
                                                                    mflag=1;
                                                                else
                                                                    rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                    if isempty(rxc)
                                                                        maxc=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    end
                                                                end
                                                                
                                                                rl2=find(cluster_to_tr(:,1)==centre_pts(rc1,3) & cluster_to_tr(:,2)==maxc);
                                                                if isempty(rl2)
                                                                    if centre_pts(rc1,3)~=maxc
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        if length(new(:,1))>1
                                                                            g=1;
                                                                            while g<length(new(:,1))
                                                                                netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                                g=g+1;
                                                                            end
                                                                        end
                                                                    elseif centre_pts(rc1,3)==maxc && mflag==1 && length(new(:,1))==1
                                                                        rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                        if isempty(rxc)
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            maxc=(max(centre_pts(:,3))+1);
                                                                            centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                            rcv=find(centre_pts(:,3)==maxc);
                                                                            validids=vertcat(validids, [rcv cluster_to_tr(rc(n),4)]);
                                                                        end
                                                                    end
                                                                end
                                                                
                                                                if ~isempty(rcenm)%centre2_exists
                                                                    rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==centre_pts(rcenm,3));
                                                                    if isempty(rl2)
                                                                        if maxc~=centre_pts(rcenm,3)
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rcenm,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], [centre_pts(rcenm,1) centre_pts(rcenm,2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                    end
                                                                else
                                                                    x1=memcen(1,1)+10;
                                                                    y1=memcen(1,2)+10;
                                                                    x2=memcen(1,1)+10;
                                                                    y2=memcen(1,2)-10;
                                                                    x3=memcen(1,1)-10;
                                                                    y3=memcen(1,2)+10;
                                                                    x4=memcen(1,1)-10;
                                                                    y4=memcen(1,2)-10;
                                                                    
                                                                    node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                    in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                    inidx=find(in~=0);
                                                                    if ~isempty(inidx)
                                                                        if length(inidx)>1
                                                                            Pd=[memcen(1,1) memcen(1,2)];
                                                                            Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                            Y = pdist(Pd,'euclid');
                                                                            SQ=squareform(Y);
                                                                            minid=find(SQ(1,:)>0);
                                                                            mindist=min(SQ(minid));
                                                                            rm=find(SQ(1,:)==mindist);
                                                                            if length(rm)>1% two with the same distance
                                                                                maxc2=centre_pts(inidx(rm(1)-1),3);
                                                                            else
                                                                                maxc2=centre_pts(inidx(rm-1),3);
                                                                            end
                                                                        else
                                                                            maxc2=centre_pts(inidx,3);
                                                                        end
                                                                    else
                                                                        rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                        if isempty(rxc)
                                                                            maxc2=(max(centre_pts(:,3))+1);
                                                                            centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc2 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                        end
                                                                    end
                                                                    rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==maxc2);
                                                                    if isempty(rl2)
                                                                        if maxc~=maxc2
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            rmc1=find(centre_pts(:,3)==maxc);
                                                                            rmc2=find(centre_pts(:,3)==maxc2);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[maxc,maxc2, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rmc1,1) centre_pts(rmc1,2)], [centre_pts(rmc2,1) centre_pts(rmc2,2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                        
                                                                        nrsp=find(segment(:,3)==0);
                                                                        if length(nrsp)==2 && maxc2~=rc2 && length(segment(:,3))<5
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            split=vertcat(split,[maxc2, centre_pts(rc2,3), netnodes(wht,2), cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5)]);
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                        end
                                                        
                                                    elseif segment(length(segment(:,1)),3)==0
                                                        new=[];
                                                        g=length(segment(:,1))-1;
                                                        new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                        g=g-1;
                                                        while segment(g,3)~=1 && g>0
                                                            new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                            g=g-1;
                                                        end
                                                        
                                                        
                                                        memcen=[segment(g,1) segment(g,2)];
                                                        
                                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[new(length(new(:,1)),1), new(length(new(:,1)),2)]);
                                                        
                                                        if centre_pts(rc2,1)~=new(length(new(:,1)),1)&&centre_pts(rc2,2)~=new(length(new(:,1)),2)
                                                            rcen=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                            rcenm=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                            if ~isempty(rcen)%centre_exists
                                                                rl=find(cluster_to_tr(:,2)==centre_pts(rc2,3) & cluster_to_tr(:,1)==centre_pts(rcen,3));
                                                                if isempty(rl)
                                                                    if centre_pts(rcen,3)~=centre_pts(rc2,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcen,3),centre_pts(rc2,3), maxcl, round((centre_pts(rcen,9)+centre_pts(rc2,9))/2), round((centre_pts(rcen,8)+centre_pts(rc2,8))/2), distancePoints([centre_pts(rcen,1) centre_pts(rcen,2)], [centre_pts(rc2,1) centre_pts(rc2,2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        if length(new(:,1))>1
                                                                            g=length(new(:,1))-1;
                                                                            while g>0
                                                                                netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                                g=g-1;
                                                                            end
                                                                        end
                                                                    end
                                                                end
                                                                
                                                                if ~isempty(rcenm)%centre2_exists
                                                                    rl2=find(cluster_to_tr(:,1)==centre_pts(rcenm,3) & cluster_to_tr(:,2)==centre_pts(rcen,3));
                                                                    if isempty(rl2)
                                                                        if centre_pts(rcenm,3)~=centre_pts(rcen,3)
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcenm,3),centre_pts(rcen,3), maxcl, round((centre_pts(rcenm,9)+centre_pts(rcen,9))/2), round((centre_pts(rcenm,8)+centre_pts(rcen,8))/2), distancePoints([centre_pts(rcenm,1) centre_pts(rcenm,2)], [centre_pts(rcen,1) centre_pts(rcen,2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                    end
                                                                else
                                                                    x1=memcen(1,1)+10;
                                                                    y1=memcen(1,2)+10;
                                                                    x2=memcen(1,1)+10;
                                                                    y2=memcen(1,2)-10;
                                                                    x3=memcen(1,1)-10;
                                                                    y3=memcen(1,2)+10;
                                                                    x4=memcen(1,1)-10;
                                                                    y4=memcen(1,2)-10;
                                                                    
                                                                    node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                    in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                    inidx=find(in~=0);
                                                                    if ~isempty(inidx)
                                                                        if length(inidx)>1
                                                                            Pd=[memcen(1,1) memcen(1,2)];
                                                                            Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                            Y = pdist(Pd,'euclid');
                                                                            SQ=squareform(Y);
                                                                            minid=find(SQ(1,:)>0);
                                                                            mindist=min(SQ(minid));
                                                                            rm=find(SQ(1,:)==mindist);
                                                                            if length(rm)>1% two with the same distance
                                                                                maxc=centre_pts(inidx(rm(1)-1),3);
                                                                            else
                                                                                maxc=centre_pts(inidx(rm-1),3);
                                                                            end
                                                                        else
                                                                            maxc=centre_pts(inidx,3);
                                                                        end
                                                                    else
                                                                        rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                        if isempty(rxc)
                                                                            maxc=(max(centre_pts(:,3))+1);
                                                                            centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                        end
                                                                    end
                                                                    rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==centre_pts(rcen,3));
                                                                    if isempty(rl2)
                                                                        if maxc~=centre_pts(rcen,3)
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rcen,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], [centre_pts(rcen,1) centre_pts(rcen,2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                    end
                                                                    
                                                                end
                                                            else
                                                                x1=new(length(new(:,1)),1)+10;
                                                                y1=new(length(new(:,1)),2)+10;
                                                                x2=new(length(new(:,1)),1)+10;
                                                                y2=new(length(new(:,1)),2)-10;
                                                                x3=new(length(new(:,1)),1)-10;
                                                                y3=new(length(new(:,1)),2)+10;
                                                                x4=new(length(new(:,1)),1)-10;
                                                                y4=new(length(new(:,1)),2)-10;
                                                                
                                                                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                inidx=find(in~=0);
                                                                if ~isempty(inidx)
                                                                    if length(inidx)>1
                                                                        Pd=[new(length(new(:,1)),1), new(length(new(:,1)),2)];
                                                                        Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                        Y = pdist(Pd,'euclid');
                                                                        SQ=squareform(Y);
                                                                        minid=find(SQ(1,:)>0);
                                                                        mindist=min(SQ(minid));
                                                                        rm=find(SQ(1,:)==mindist);
                                                                        if length(rm)>1% two with the same distance
                                                                            maxc=centre_pts(inidx(rm(1)-1),3);
                                                                        else
                                                                            maxc=centre_pts(inidx(rm-1),3);
                                                                        end
                                                                    else
                                                                        maxc=centre_pts(inidx,3);
                                                                    end
                                                                else
                                                                    rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                    if isempty(rxc)
                                                                        maxc=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    end
                                                                end
                                                                rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==centre_pts(rc2,3));
                                                                if isempty(rl2)
                                                                    if maxc~=centre_pts(rc2,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rc2,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], [centre_pts(rc2,1) centre_pts(rc2,2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        if length(new(:,1))>1
                                                                            g=length(new(:,1))-1;
                                                                            while g>0
                                                                                netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                                g=g-1;
                                                                            end
                                                                        end
                                                                    end
                                                                end
                                                                if ~isempty(rcenm)%centre2_exists
                                                                    rl2=find(cluster_to_tr(:,1)==centre_pts(rcenm(1),3) & cluster_to_tr(:,2)==maxc);
                                                                    if isempty(rl2)
                                                                        if centre_pts(rcenm(1),3)~=maxc
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcenm,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rcenm,1) centre_pts(rcenm,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                    end
                                                                else
                                                                    x1=memcen(1,1)+10;
                                                                    y1=memcen(1,2)+10;
                                                                    x2=memcen(1,1)+10;
                                                                    y2=memcen(1,2)-10;
                                                                    x3=memcen(1,1)-10;
                                                                    y3=memcen(1,2)+10;
                                                                    x4=memcen(1,1)-10;
                                                                    y4=memcen(1,2)-10;
                                                                    
                                                                    node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                    in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                    inidx=find(in~=0);
                                                                    if ~isempty(inidx)
                                                                        if length(inidx)>1
                                                                            Pd=[memcen(1,1) memcen(1,2)];
                                                                            Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                            Y = pdist(Pd,'euclid');
                                                                            SQ=squareform(Y);
                                                                            minid=find(SQ(1,:)>0);
                                                                            mindist=min(SQ(minid));
                                                                            rm=find(SQ(1,:)==mindist);
                                                                            if length(rm)>1% two with the same distance
                                                                                maxc2=centre_pts(inidx(rm(1)-1),3);
                                                                            else
                                                                                maxc2=centre_pts(inidx(rm-1),3);
                                                                            end
                                                                        else
                                                                            maxc2=centre_pts(inidx,3);
                                                                        end
                                                                    else
                                                                        rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                        if isempty(rxc)
                                                                            maxc2=(max(centre_pts(:,3))+1);
                                                                            centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc2 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                        end
                                                                    end
                                                                    rl2=find(cluster_to_tr(:,1)==maxc2 & cluster_to_tr(:,2)==maxc);
                                                                    if isempty(rl2)
                                                                        if maxc2~=maxc
                                                                            maxcl=(max(netnodes(:,1))+1);
                                                                            rmc1=find(centre_pts(:,3)==maxc2);
                                                                            rmc2=find(centre_pts(:,3)==maxc);
                                                                            cluster_to_tr=vertcat(cluster_to_tr,[maxc2,maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rmc1,1) centre_pts(rmc1,2)], [centre_pts(rmc2,1) centre_pts(rmc2,2)], 2)]);
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        end
                                                                        
                                                                        nrsp=find(segment(:,3)==0);
                                                                        if length(nrsp)==2 && maxc2~=rc1 && length(segment(:,3))<5
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            split=vertcat(split,[centre_pts(rc1,3), maxc2, netnodes(wht,2), cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5)]);
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                        end
                                                    end
                                                    ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                                    if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                        segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),2]);
                                                    else
                                                        segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),1]);
                                                    end
                                                end
                                            else
                                                validids=vertcat(validids, [rc1 cluster_to_tr(rc(n),4)]);
                                                validids=vertcat(validids, [rc2 cluster_to_tr(rc(n),4)]);
                                                
                                                g=2;
                                                while g<=(length(segment(:,1))-1)
                                                    if segment(g,3)==1
                                                        intermediate=vertcat(intermediate,[segment(g,1) segment(g,2) riw]);
                                                    end
                                                    g=g+1;
                                                end
                                                rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                                rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                                ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                    segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),2]);
                                                else
                                                    segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),1]);
                                                end
                                            end
                                        end
                                    else
                                        rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                        rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                        ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                        if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                            nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                        else
                                            nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                        end
                                    end
                                elseif isempty(rn)&&(length(nrs)/length(segment(:,1)))>=0.5
                                    if length(nrs)/length(segment(:,1))>0.5
                                        rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                        rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                        ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                        if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                            nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                        else
                                            nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                        end
                                        
                                    elseif memcntr~=0 && memcntr~=centre_pts(c1,3) && memcntr~=centre_pts(c2,3)
                                        validids=vertcat(validids, [memcntr cluster_to_tr(rc(n),4)]);
                                    elseif centre_pts(c1,3)==centre_pts(rc1,3)||centre_pts(c2,3)==centre_pts(rc1,3)||centre_pts(c1,3)==centre_pts(rc2,3)||centre_pts(c2,3)==centre_pts(rc2,3)
                                        cnode=[];
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),1));
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),2));
                                        rcn=find(cnode(:)~=centre_pts(c1,3)&cnode(:)~=centre_pts(c2,3));
                                        if length(rcn)==1
                                            rl=find(cluster_to_tr(:,1)==cnode(rcn)|cluster_to_tr(:,2)==cnode(rcn));
                                            anodes=[];
                                            for g=1:length(rl)
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),1));
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),2));
                                            end
                                            rl1=find(anodes(:)==centre_pts(c1,3));
                                            rl2=find(anodes(:)==centre_pts(c2,3));
                                            rt=find(cluster_to_tr(:,1)==cnode(rcn)&cluster_to_tr(:,2)==centre_pts(c1,3)|cluster_to_tr(:,1)==centre_pts(c1,3)&cluster_to_tr(:,2)==cnode(rcn));
                                            if ~isempty(rl1)&&~isempty(rl2)
                                                maxr=max([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                medr=median([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                minr=min([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                if cluster_to_tr(sres,4)==minr%||cluster_to_tr(sres,4)==medr
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                                    tcase=vertcat(tcase,[cluster_to_tr(sres,3),cluster_to_tr(sres,4), cluster_to_tr(sres,6), cluster_to_tr(rc(n),3),cluster_to_tr(rc(n),4),cluster_to_tr(rc(n),6),cluster_to_tr(rt(1),3),cluster_to_tr(rt(1),4),cluster_to_tr(rt(1),6),6]);
                                                    ccase=vertcat(ccase,[cluster_to_tr(sres,1) cluster_to_tr(sres,2) cluster_to_tr(rc(n),1) cluster_to_tr(rc(n),2) cluster_to_tr(rt(1),1) cluster_to_tr(rt(1),2)]);
                                                end
                                                
                                                
                                            end
                                        elseif length(rcn)==2
                                            rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                            rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                            ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                            else
                                                nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                            end
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
            
            
            
            if ~isempty(intermediate)
                sss=sss+length(intermediate(:,1));
            end
            if ~isempty(split)
                for g=1:length(split(:,1))
                    rc1=find(centre_pts(:,3)==split(g,1));
                    rc2=find(centre_pts(:,3)==split(g,2));
                    in1 = inpolygon(centre_pts(rc1,1),centre_pts(rc1,2),bbox2(:,1),bbox2(:,2));
                    in2 = inpolygon(centre_pts(rc2,1),centre_pts(rc2,2),bbox2(:,1),bbox2(:,2));
                    ds=sqrt((centre_pts(rc1,1)-centre_pts(rc2,1))^2+(centre_pts(rc1,2)-centre_pts(rc2,2))^2);
                    if (in1==0||in2==0)&&(centre_pts(rc1,3)~=centre_pts(rc2,3))
                        maxcl=(max(netnodes(:,1))+1);
                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),centre_pts(rc2,3), maxcl, round((centre_pts(rc1,9)+centre_pts(rc2,9))/2), round((centre_pts(rc1,8)+centre_pts(rc2,8))/2), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)], 2)]);
                        netnodes=vertcat(netnodes,[maxcl,split(g,3),0,1,1,0,0,0]);
                    end
                end
            end
            
            validids=unique(validids,'rows');
            
            cm=find(c4(:)~=centre_pts(c1,3)&c4(:)~=centre_pts(c2,3));
            if ~isempty(cm) && scounter>=1
                for g=1:length(cm)
                    if ~isempty(validids)
                        rv=find(centre_pts(validids(:,1),3)==c4(cm(g)));
                        if isempty(rv)%compute vert dist
                            for t=1:length(res)
                                gdy=0;
                                if t==1
                                    bbox2=[];
                                    slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                    b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                    rcen=find(centre_pts(:,3)==c4(cm(g)));
                                    d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                                    dx1=sqrt((centre_pts(c1,1)-netsections(res(t),2))^2+(centre_pts(c1,2)-netsections(res(t),3))^2);
                                    
                                    ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(t),2),netsections(res(t),3)]);
                                    
                                    
                                    if scounter<=10
                                        gdy=20;
                                    else
                                        gdy=15;
                                    end
                                    
                                    
                                    x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                                    y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                                    x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                                    y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                                    x3=netsections(res(1),2)+(gdy)*cosd(ndegrees-90);
                                    y3=netsections(res(1),3)+(gdy)*sind(ndegrees-90);
                                    x4=netsections(res(1),2)+(gdy)*cosd(ndegrees+90);
                                    y4=netsections(res(1),3)+(gdy)*sind(ndegrees+90);
                                    
                                    node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                    bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                    
                                    inp = inpolygon(centre_pts(rcen,1),centre_pts(rcen,2),bbox2(:,1),bbox2(:,2));
                                    if d<=gdy && inp==1
                                        validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                                    end
                                end
                                if t==length(res)
                                    bbox2=[];
                                    slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                    b=centre_pts(c2,2) - slope*centre_pts(c2,1);
                                    rcen=find(centre_pts(:,3)==c4(cm(g)));
                                    d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                                    dx1=sqrt((centre_pts(c2,1)-netsections(res(t),2))^2+(centre_pts(c2,2)-netsections(res(t),3))^2);
                                    
                                    ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                    
                                    if scounter<=10
                                        gdy=20;
                                    else
                                        gdy=15;
                                    end
                                    
                                    x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                    y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                    x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                    y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                    x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                                    y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                                    x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                                    y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                                    
                                    node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                    bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                    
                                    inp = inpolygon(centre_pts(rcen,1),centre_pts(rcen,2),bbox2(:,1),bbox2(:,2));
                                    
                                    if d<=gdy && inp==1
                                        validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                                    end
                                end
                                if t<length(res)
                                    bbox2=[];
                                    slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                    b=netsections(res(t),3) - slope*netsections(res(t),2);
                                    rcen=find(centre_pts(:,3)==c4(cm(g)));
                                    d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                                    dx1=sqrt((netsections(res(t),2)-netsections(res(t+1),2))^2+(netsections(res(t),3)-netsections(res(t+1),3))^2);
                                    
                                    ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                                    
                                    if scounter<=10
                                        gdy=20;
                                    else
                                        gdy=15;
                                    end
                                    
                                    x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                    y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                    x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                    y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                    x3=netsections(res(t+1),2)+(gdy)*cosd(ndegrees-90);
                                    y3=netsections(res(t+1),3)+(gdy)*sind(ndegrees-90);
                                    x4=netsections(res(t+1),2)+(gdy)*cosd(ndegrees+90);
                                    y4=netsections(res(t+1),3)+(gdy)*sind(ndegrees+90);
                                    
                                    node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                    bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                    
                                    inp = inpolygon(centre_pts(rcen,1),centre_pts(rcen,2),bbox2(:,1),bbox2(:,2));
                                    
                                    if d<=gdy && inp==1
                                        validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                                    end
                                end
                            end
                        end
                        
                    else
                        for t=1:length(res)
                            gdy=0;
                            if t==1
                                bbox2=[];
                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                rcen=find(centre_pts(:,3)==c4(cm(g)));
                                d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                                dx1=sqrt((centre_pts(c1,1)-netsections(res(t),2))^2+(centre_pts(c1,2)-netsections(res(t),3))^2);
                                
                                ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(t),2),netsections(res(t),3)]);
                                
                                
                                if scounter<=10
                                    gdy=20;
                                else
                                    gdy=15;
                                end
                                
                                
                                x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                                y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                                x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                                y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                                x3=netsections(res(1),2)+(gdy)*cosd(ndegrees-90);
                                y3=netsections(res(1),3)+(gdy)*sind(ndegrees-90);
                                x4=netsections(res(1),2)+(gdy)*cosd(ndegrees+90);
                                y4=netsections(res(1),3)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(rcen,1),centre_pts(rcen,2),bbox2(:,1),bbox2(:,2));
                                if d<=gdy && inp==1
                                    validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                                end
                            end
                            if t==length(res)
                                bbox2=[];
                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                b=centre_pts(c2,2) - slope*centre_pts(c2,1);
                                rcen=find(centre_pts(:,3)==c4(cm(g)));
                                d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                                dx1=sqrt((centre_pts(c2,1)-netsections(res(t),2))^2+(centre_pts(c2,2)-netsections(res(t),3))^2);
                                
                                ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                
                                if scounter<=10
                                    gdy=20;
                                else
                                    gdy=15;
                                end
                                
                                x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                                y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                                x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                                y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(rcen,1),centre_pts(rcen,2),bbox2(:,1),bbox2(:,2));
                                
                                if d<=gdy && inp==1
                                    validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                                end
                            end
                            if t<length(res)
                                bbox2=[];
                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                rcen=find(centre_pts(:,3)==c4(cm(g)));
                                d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                                dx1=sqrt((netsections(res(t),2)-netsections(res(t+1),2))^2+(netsections(res(t),3)-netsections(res(t+1),3))^2);
                                
                                ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                                
                                if scounter<=10
                                    gdy=20;
                                else
                                    gdy=15;
                                end
                                
                                x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                x3=netsections(res(t+1),2)+(gdy)*cosd(ndegrees-90);
                                y3=netsections(res(t+1),3)+(gdy)*sind(ndegrees-90);
                                x4=netsections(res(t+1),2)+(gdy)*cosd(ndegrees+90);
                                y4=netsections(res(t+1),3)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(rcen,1),centre_pts(rcen,2),bbox2(:,1),bbox2(:,2));
                                
                                if d<=gdy && inp==1
                                    validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                                end
                            end
                        end
                    end
                    
                end
            end
            
            
            if ~isempty(nsegs)
                [nnsegs nids]=unique(nsegs(:,1),'rows');
                nsegs=nsegs(nids,:);
            end
            
            if ~isempty(segscl)
                [ssegscl sids]=unique(segscl(:,1),'rows');
                segscl=segscl(sids,:);
            end
            
            validids=unique(validids,'rows');
            
            nodes=[];
            if ~isempty(validids)
                for l=1:length(validids(:,1))
                    nodes=vertcat(nodes,validids(l,1));
                end
            end
            if ~isempty(nsegs)
                for l=1:length(nsegs(:,1))
                    m=find(cluster_to_tr(:,3)==nsegs(l,1));
                    if ~isempty(m)
                        r=find(centre_pts(:,3)==cluster_to_tr(m,1));
                        if scounter<=10
                            if cluster_to_tr(sres,5)~=0
                                gdy=cluster_to_tr(sres,5);
                            else
                                gdy=25;
                            end
                            
                        else
                            gdy=20;
                        end
                        for t=1:length(res)
                            if t==1
                                bbox2=[];
                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                d=abs(slope*centre_pts(r,1) + (-1)*centre_pts(r,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(t),2),netsections(res(t),3)]);
                                
                                x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                                y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                                x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                                y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                                x3=netsections(res(1),2)+(gdy)*cosd(ndegrees-90);
                                y3=netsections(res(1),3)+(gdy)*sind(ndegrees-90);
                                x4=netsections(res(1),2)+(gdy)*cosd(ndegrees+90);
                                y4=netsections(res(1),3)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(r,1),centre_pts(r,2),bbox2(:,1),bbox2(:,2));
                                if d<=gdy && inp==1
                                    nodes=vertcat(nodes,r);
                                end
                            end
                            if t==length(res)
                                bbox2=[];
                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                b=centre_pts(c2,2) - slope*centre_pts(c2,1);
                                d=abs(slope*centre_pts(r,1) + (-1)*centre_pts(r,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                
                                x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                                y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                                x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                                y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(r,1),centre_pts(r,2),bbox2(:,1),bbox2(:,2));
                                
                                if d<=gdy && inp==1
                                    nodes=vertcat(nodes,r);
                                end
                            end
                            if t<length(res)
                                bbox2=[];
                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                d=abs(slope*centre_pts(r,1) + (-1)*centre_pts(r,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                                
                                
                                x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                x3=netsections(res(t+1),2)+(gdy)*cosd(ndegrees-90);
                                y3=netsections(res(t+1),3)+(gdy)*sind(ndegrees-90);
                                x4=netsections(res(t+1),2)+(gdy)*cosd(ndegrees+90);
                                y4=netsections(res(t+1),3)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(r,1),centre_pts(r,2),bbox2(:,1),bbox2(:,2));
                                
                                if d<=gdy && inp==1
                                    nodes=vertcat(nodes,r);
                                end
                            end
                        end
                        
                        r=find(centre_pts(:,3)==cluster_to_tr(m,2));
                        
                        for t=1:length(res)
                            
                            if t==1
                                bbox2=[];
                                slope=(netsections(res(t),3)-centre_pts(c1,2))/(netsections(res(t),2)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                d=abs(slope*centre_pts(r,1) + (-1)*centre_pts(r,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(t),2),netsections(res(t),3)]);
                                
                                x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                                y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                                x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                                y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                                x3=netsections(res(1),2)+(gdy)*cosd(ndegrees-90);
                                y3=netsections(res(1),3)+(gdy)*sind(ndegrees-90);
                                x4=netsections(res(1),2)+(gdy)*cosd(ndegrees+90);
                                y4=netsections(res(1),3)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(r,1),centre_pts(r,2),bbox2(:,1),bbox2(:,2));
                                if d<=gdy && inp==1
                                    nodes=vertcat(nodes,r);
                                end
                            end
                            if t==length(res)
                                bbox2=[];
                                slope=(centre_pts(c2,2)-netsections(res(t),3))/(centre_pts(c2,1)-netsections(res(t),2));
                                b=centre_pts(c2,2) - slope*centre_pts(c2,1);
                                d=abs(slope*centre_pts(r,1) + (-1)*centre_pts(r,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                                
                                x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                                y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                                x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                                y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(r,1),centre_pts(r,2),bbox2(:,1),bbox2(:,2));
                                
                                if d<=gdy && inp==1
                                    nodes=vertcat(nodes,r);
                                end
                            end
                            if t<length(res)
                                bbox2=[];
                                slope=(netsections(res(t+1),3)-netsections(res(t),3))/(netsections(res(t+1),2)-netsections(res(t),2));
                                b=netsections(res(t),3) - slope*netsections(res(t),2);
                                d=abs(slope*centre_pts(r,1) + (-1)*centre_pts(r,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                ndegrees=line_angle([netsections(res(t),2),netsections(res(t),3)],[netsections(res(t+1),2),netsections(res(t+1),3)]);
                                
                                x1=netsections(res(t),2)+(gdy)*cosd(ndegrees-90);
                                y1=netsections(res(t),3)+(gdy)*sind(ndegrees-90);
                                x2=netsections(res(t),2)+(gdy)*cosd(ndegrees+90);
                                y2=netsections(res(t),3)+(gdy)*sind(ndegrees+90);
                                x3=netsections(res(t+1),2)+(gdy)*cosd(ndegrees-90);
                                y3=netsections(res(t+1),3)+(gdy)*sind(ndegrees-90);
                                x4=netsections(res(t+1),2)+(gdy)*cosd(ndegrees+90);
                                y4=netsections(res(t+1),3)+(gdy)*sind(ndegrees+90);
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                                
                                inp = inpolygon(centre_pts(r,1),centre_pts(r,2),bbox2(:,1),bbox2(:,2));
                                
                                if d<=gdy && inp==1
                                    nodes=vertcat(nodes,r);
                                end
                            end
                        end
                    end
                end
            end
            
            nodes=unique(nodes,'rows');
            tokeep=[];
            if ~isempty(nsegs)
                for l=1:length(nsegs(:,1))
                    m=find(cluster_to_tr(:,3)==nsegs(l,1));
                    if ~isempty(m)
                        if ~isempty(nodes)
                            r1=find(centre_pts(nodes,3)==cluster_to_tr(m,1));
                            r2=find(centre_pts(nodes,3)==cluster_to_tr(m,2));
                            if ~isempty(r1)&&~isempty(r2)
                                tokeep=vertcat(tokeep,l);
                            end
                        end
                    end
                end
            end
            
            if ~isempty(tokeep)
                nsegs=nsegs(tokeep,:);
            end
            
            idnx=[];
            for l=1:length(nodes)
                if centre_pts(c1,3)~=centre_pts(nodes(l),3) && centre_pts(c2,3)~=centre_pts(nodes(l),3)
                    idnx=vertcat(idnx,l);
                end
            end
            nodes=nodes(idnx);
            
            Cldist=[];
            Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
            Cldist=vertcat(Cldist, [centre_pts(nodes,1), centre_pts(nodes,2)]);
            Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
            Y = pdist(Cldist,'euclid');
            SQ=squareform(Y);
            cclust=zeros(length(Cldist), 1);
            
            for o=1:length(SQ(:,:))
                SQ(o,o)=100000.0;
            end
            
            %finding sequence of centres point cloud
            j=1;
            idxk=1;
            minip=100000.0;
            while idxk<=length(SQ(idxk,:)) & j<=length(Cldist(:,1))
                
                if length(idxk)>1
                    index=0;
                    for g=1:length(idxk)
                        mindist=min(SQ(idxk(g),:));
                        if mindist<=minip
                            minip=mindist;
                            index=g;
                        end
                    end
                    resi=find(SQ(idxk(index),:)==minip);
                    cclust(j)=idxk(index);
                    minip=100000.0;
                    j=j+1;
                else
                    mindist=min(SQ(idxk,:));
                    resi=find(SQ(idxk,:)==mindist);
                    cclust(j)=idxk;
                    j=j+1;
                end
                
                if length(Cldist(:,1))==idxk
                    break;
                end
                
                SQ(idxk,:)=100000;
                SQ(:,resi)=100000;
                
                if idxk==1
                    SQ(:,idxk)=100000;
                end
                
                curr=resi;
                idxk=curr;
            end
            
            tclusters=[];
            tid=1;
            len=length(cclust);
            cl=find(cclust(:)~=0);
            cclust=cclust(cl);
            for n=1:length(cclust)
                if cclust(n)~=1 && cclust(n)~=len
                    tclusters(tid)=cclust(n);
                    tid=tid+1;
                end
            end
            
            cclust=tclusters-1;
            Cldist=[];
            Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
            Cldist=vertcat(Cldist, [centre_pts(nodes(cclust),1) centre_pts(nodes(cclust),2)]);
            Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
            
            
            pointset=[];
            for l=1:length(res)
                pointset=vertcat(pointset,[netsections(res(l),2) netsections(res(l),3) netnodes(k,2)]);
            end
            
            if ~isempty(nsegs)
                for l=1:length(nsegs(:,1))
                    r=find(netsections(:,1)==nsegs(l,1));
                    if ~isempty(r)
                        for m=1:length(r)
                            pointset=vertcat(pointset,[netsections(r(m),2) netsections(r(m),3) nsegs(l,2)]);
                        end
                    end
                end
            end
            
            if ~isempty(intermediate)
                intermediate=unique(intermediate,'rows');
                for l=1:length(intermediate(:,1))
                    pointset=vertcat(pointset,[intermediate(l,1) intermediate(l,2) intermediate(l,3)]);
                end
            end
            
            if ~isempty(pointset)
                circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
                idx=[];
                for l=1:length(pointset(:,1))
                    if isPointInCircle([pointset(l,1), pointset(l,2)], circle)
                        idx=vertcat(idx,l);
                    end
                end
                pointset(idx,:)=[];
                
                circle = [[centre_pts(c2,1) centre_pts(c2,2)] 15];
                idx=[];
                for l=1:length(pointset(:,1))
                    if isPointInCircle([pointset(l,1), pointset(l,2)], circle)
                        idx=vertcat(idx,l);
                    end
                end
                pointset(idx,:)=[];
                for g=1:length(cclust)
                    circle = [[centre_pts(nodes(cclust(g)),1) centre_pts(nodes(cclust(g)),2)] 15];
                    idx=[];
                    for l=1:length(pointset(:,1))
                        if isPointInCircle([pointset(l,1), pointset(l,2)], circle)
                            idx=vertcat(idx,l);
                        end
                    end
                    pointset(idx,:)=[];
                end
            end
            
            if ~isempty(pointset)
                [ps idps]=unique([pointset(:,1) pointset(:,2)],'rows');
                pointset=pointset(idps,:);
            end
            
            pseq=pointset;
            
            ppseq=[];
            ptemp=[];
            if ~isempty(pseq)
                Cldist=[];
                Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
                Cldist=vertcat(Cldist, [pseq(:,1), pseq(:,2)]);
                Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
                Y = pdist(Cldist,'euclid');
                SQ=squareform(Y);
                mclust=zeros(length(Cldist), 1);
                
                for o=1:length(SQ(:,:))
                    SQ(o,o)=100000.0;
                end
                
                %finding sequence of centres point cloud
                j=1;
                idxk=1;
                minip=100000.0;
                while idxk<=length(SQ(idxk,:)) & j<=length(Cldist(:,1))
                    
                    if length(idxk)>1
                        index=0;
                        for g=1:length(idxk)
                            mindist=min(SQ(idxk(g),:));
                            if mindist<=minip
                                minip=mindist;
                                index=g;
                            end
                        end
                        resi=find(SQ(idxk(index),:)==minip);
                        mclust(j)=idxk(index);
                        minip=100000.0;
                        j=j+1;
                    else
                        mindist=min(SQ(idxk,:));
                        resi=find(SQ(idxk,:)==mindist);
                        mclust(j)=idxk;
                        j=j+1;
                    end
                    
                    if length(Cldist(:,1))==idxk
                        break;
                    end
                    
                    SQ(idxk,:)=100000;
                    SQ(:,resi)=100000;
                    
                    if idxk==1
                        SQ(:,idxk)=100000;
                    end
                    
                    curr=resi;
                    idxk=curr;
                end
                
                mc=mclust~=0;
                mclust=mclust(mc);
                pseq=pseq(mclust(2:length(mclust)-1)-1,:);
                ptemp=temp;
                Cldist(:,3)=1;
                temp=Cldist(mclust(2:length(mclust)-1),:);
                ppseq=pseq;
            end
            
            pseq=ppseq;
            
            if ~isempty(pseq)
                rp= pseq(:,1)==centre_pts(c1,1)&pseq(:,2)==centre_pts(c1,2);
                pseq(rp,:)=[];
                rp=pseq(:,1)==centre_pts(c2,1)&pseq(:,2)==centre_pts(c2,2);
                pseq(rp,:)=[];
                for v=1:length(cclust)
                    rp= pseq(:,1)==centre_pts(nodes(cclust(v)),1)&pseq(:,2)==centre_pts(nodes(cclust(v)),2);
                    if ~isempty(rp)
                        pseq(rp,:)=[];
                    end
                end
            end
            
            
            Cldist=[];
            Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
            if ~isempty(pseq)
                PP=vertcat([centre_pts(nodes(cclust),1), centre_pts(nodes(cclust),2)],[pseq(:,1), pseq(:,2)]);
            else
                PP=[centre_pts(nodes(cclust),1), centre_pts(nodes(cclust),2)];
            end
            PP=unique(PP,'rows');
            Cldist=vertcat(Cldist, PP);
            Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
            Y = pdist(Cldist,'euclid');
            SQ=squareform(Y);
            pointseq=[];
            pointseq=zeros(length(Cldist), 1);
            
            for o=1:length(SQ(:,:))
                SQ(o,o)=100000.0;
            end
            
            %finding sequence of centres point cloud
            j=1;
            idxk=1;
            minip=100000.0;
            while idxk<=length(SQ(idxk,:)) & j<=length(Cldist(:,1))
                
                if length(idxk)>1
                    index=0;
                    for g=1:length(idxk)
                        mindist=min(SQ(idxk(g),:));
                        if mindist<=minip
                            minip=mindist;
                            index=g;
                        end
                    end
                    resi=find(SQ(idxk(index),:)==minip);
                    pointseq(j)=idxk(index);
                    minip=100000.0;
                    j=j+1;
                else
                    mindist=min(SQ(idxk,:));
                    resi=find(SQ(idxk,:)==mindist);
                    pointseq(j)=idxk;
                    j=j+1;
                end
                
                if length(Cldist(:,1))==idxk
                    break;
                end
                
                SQ(idxk,:)=100000;
                SQ(:,resi)=100000;
                
                if idxk==1
                    SQ(:,idxk)=100000;
                end
                
                curr=resi;
                idxk=curr;
            end
            
            seq=find(pointseq~=0);
            pointseq=pointseq(seq);
            sequence=[];
            
            for l=1:length(pointseq)
                sequence=vertcat(sequence,[Cldist(pointseq(l),1), Cldist(pointseq(l),2)]);
            end
            
            idx=[];
            for g=1:length(cclust)
                rc=find(sequence(:,1)==centre_pts(nodes(cclust(g)),1)&sequence(:,2)==centre_pts(nodes(cclust(g)),2));
                if ~isempty(rc)
                    idx=vertcat(idx,g);
                end
            end
            
            if ~isempty(segscl)
                ids=[];
                for g=1:length(segscl(:,1))
                    rg=find(cluster_to_tr(:,3)==segscl(g,1));
                    if ~isempty(rg)
                        ri1=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,1));
                        ri2=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,2));
                        if isempty(ri1)&&isempty(ri2)
                            ids=vertcat(ids,g);
                        end
                    end
                end
                if ~isempty(ids)
                    ids=unique(ids);
                    segscl(ids,:)=[];
                end
            end
            
            if ~isempty(nsegs)
                ids=[];
                for g=1:length(nsegs(:,1))
                    rg=find(cluster_to_tr(:,3)==nsegs(g,1));
                    if ~isempty(rg)
                        ri1=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,1));
                        ri2=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,2));
                        if isempty(ri1)||isempty(ri2)
                            ids=vertcat(ids,g);
                        end
                    end
                end
                if ~isempty(ids)
                    ids=unique(ids);
                    nsegs(ids,:)=[];
                end
            end
            
            if ~isempty(idx)
                cclust=cclust(idx);
            end
            
            if ~isempty(pseq)
                idx=[];
                for g=1:length(pseq(:,1))
                    rc=find(sequence(:,1)==pseq(g,1)&sequence(:,2)==pseq(g,2));
                    if isempty(rc)
                        idx=vertcat(idx,g);
                    end
                end
                if ~isempty(idx)
                    pseq(idx,:)=[];
                end
            end
            
            if ~isempty(cclust)
                
                drc=[];
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            if nsegs(g,2)==2
                                drc=vertcat(drc,[centre_pts(c1,3),2]);
                            end
                        end
                    end
                end
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c2,3)||cluster_to_tr(r,2)==centre_pts(c2,3)
                            if nsegs(g,2)==2
                                drc=vertcat(drc,[centre_pts(c2,3),2]);
                            end
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            if segscl(g,2)==2
                                drc=vertcat(drc,[centre_pts(c1,3),2]);
                            end
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c2,3)||cluster_to_tr(r,2)==centre_pts(c2,3)
                            if segscl(g,2)==2
                                drc=vertcat(drc,[centre_pts(c2,3),2]);
                            end
                        end
                    end
                end
                for l=1:length(cclust)
                    if ~isempty(nsegs)
                        for g=1:length(nsegs(:,1))
                            r=find(cluster_to_tr(:,3)==nsegs(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                if nsegs(g,2)==2
                                    drc=vertcat(drc,[centre_pts(nodes(cclust(l)),3),2]);
                                end
                            end
                        end
                    end
                end
                for l=1:length(cclust)
                    if ~isempty(segscl)
                        for g=1:length(segscl(:,1))
                            r=find(cluster_to_tr(:,3)==segscl(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                if segscl(g,2)==2
                                    drc=vertcat(drc,[centre_pts(nodes(cclust(l)),3),2]);
                                end
                            end
                        end
                    end
                end
                
                if ~isempty(drc)
                    [dr drid]=unique(drc(:,1),'rows');
                    drc=drc(drid,:);
                end
                
                w1=netnodes(k,2);
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            rr=find(netnodes(:,1)==nsegs(g,1));
                            w1=w1+netnodes(rr,2);
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            rr=find(netnodes(:,1)==segscl(g,1));
                            w1=w1+netnodes(rr,2);
                        end
                    end
                end
                
                w2=netnodes(k,2);
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(memf,3)||cluster_to_tr(r,2)==centre_pts(memf,3)
                            rr=find(netnodes(:,1)==nsegs(g,1));
                            w2=w2+netnodes(rr,2);
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(memf,3)||cluster_to_tr(r,2)==centre_pts(memf,3)
                            rr=find(netnodes(:,1)==segscl(g,1));
                            w2=w2+netnodes(rr,2);
                        end
                    end
                end
                
                
                wgt=[];
                for l=1:length(cclust)
                    w=0;
                    if ~isempty(nsegs)
                        for g=1:length(nsegs(:,1))
                            r=find(cluster_to_tr(:,3)==nsegs(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                rr=find(netnodes(:,1)==nsegs(g,1));
                                w=w+netnodes(rr,2);
                            end
                        end
                    end
                    if ~isempty(segscl)
                        for g=1:length(segscl(:,1))
                            r=find(cluster_to_tr(:,3)==segscl(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                rr=find(netnodes(:,1)==segscl(g,1));
                                w=w+netnodes(rr,2);
                            end
                        end
                    end
                    wgt=vertcat(wgt,[centre_pts(nodes(cclust(l)),3),w]);
                end
                
                if ~isempty(nsegs)
                    for l=1:length(nsegs(:,1))
                        rr=find(cluster_to_tr(:,3)==nsegs(l,1));
                        if ~isempty(rr)
                            cluster_to_tr(rr,:)=[];
                        end
                        
                        rr=find(netsections(:,1)==nsegs(l,1));
                        rr=unique(rr);
                        h=length(rr);
                        while h>=1
                            netsections(rr(h),:)=[];
                            h=h-1;
                        end
                    end
                end
                
                if ~isempty(segscl)
                    for l=1:length(segscl(:,1))
                        rr=find(cluster_to_tr(:,3)==segscl(l,1));
                        if ~isempty(rr)
                            cluster_to_tr(rr,:)=[];
                        end
                        
                        rr=find(netsections(:,1)==segscl(l,1));
                        rr=unique(rr);
                        h=length(rr);
                        while h>=1
                            netsections(rr(h),:)=[];
                            h=h-1;
                        end
                    end
                end
                
                if ~isempty(prvfl)
                    for v=1:length(prvfl)
                        dx=sqrt((centre_pts(c1,1)-centre_pts(prvfl(v),1))^2+(centre_pts(c1,2)-centre_pts(prvfl(v),2))^2);
                        if dx<=100
                            rch=find(cluster_to_tr(:,1)==centre_pts(prvfl(v),3) & cluster_to_tr(:,2)==centre_pts(c1,3));
                            if isempty(rch)
                                if centre_pts(prvfl(v),3)~=centre_pts(c1,3)
                                    clid=(max(netnodes(:,1))+1);
                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(prvfl(v),3),centre_pts(c1,3), clid, round((centre_pts(c1,9)+centre_pts(prvfl(v),9))/2), round((centre_pts(c1,8)+centre_pts(prvfl(v),8))/2), distancePoints([centre_pts(prvfl(v),1) centre_pts(prvfl(v),2)], [centre_pts(c1,1) centre_pts(c1,2)], 2)]);
                                    if ~isempty(drc)
                                        dir=find(drc(:,1)==centre_pts(prvfl(v),3)|drc(:,1)==centre_pts(c1,3));
                                    end
                                    if ~isempty(dir)
                                        netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                    else
                                        netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                    end
                                end
                            end
                        end
                    end
                end
                
                for t=1:length(cclust)
                    c7=find(centre_pts(:,3)==centre_pts(nodes(cclust(t)),3));
                    if t==1
                        rch=find(cluster_to_tr(:,1)==centre_pts(c1,3) & cluster_to_tr(:,2)==centre_pts(c7,3));
                        if isempty(rch)
                            if centre_pts(c1,3)~=centre_pts(c7,3)
                                clid=(max(netnodes(:,1))+1);
                                cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c1,3), centre_pts(c7,3), clid, round((centre_pts(c1,9)+centre_pts(c7,9))/2), round((centre_pts(c1,8)+centre_pts(c7,8))/2), distancePoints([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c7,1) centre_pts(c7,2)], 2)]);
                                if round((w1+wgt(t,2))/2)==0
                                    w=1;
                                else
                                    w=round((w1+wgt(t,2))/2);
                                end
                                
                                if ~isempty(drc)
                                    dir=find(drc(:,1)==centre_pts(c7,3)|drc(:,1)==centre_pts(c1,3));
                                end
                                if ~isempty(dir)
                                    netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                else
                                    netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c1,1) & sequence(:,2)==centre_pts(c1,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            r3=find(cluster_to_tr(:,3)==clid);
                            dd=round((centre_pts(c1,8)+centre_pts(c7,8))/2);
                            
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c1,1)+dd;
                                                y1=centre_pts(c1,2)+dd;
                                                x2=centre_pts(c1,1)+dd;
                                                y2=centre_pts(c1,2)-dd;
                                                x3=centre_pts(c1,1)-dd;
                                                y3=centre_pts(c1,2)+dd;
                                                x4=centre_pts(c1,1)-dd;
                                                y4=centre_pts(c1,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                                tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                            centre_pts(c1,1)=aa(1,1);
                                                            centre_pts(c1,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c1,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c1,1) centre_pts(c1,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for m=1:length(temp(:,1))
                                                netsections=vertcat(netsections,[clid,temp(m,1),temp(m,2),0,0]);
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c1,1)+dd;
                                    y1=centre_pts(c1,2)+dd;
                                    x2=centre_pts(c1,1)+dd;
                                    y2=centre_pts(c1,2)-dd;
                                    x3=centre_pts(c1,1)-dd;
                                    y3=centre_pts(c1,2)+dd;
                                    x4=centre_pts(c1,1)-dd;
                                    y4=centre_pts(c1,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                    tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                centre_pts(c1,1)=aa(1,1);
                                                centre_pts(c1,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c1,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                end
                            end
                        else
                            for n=1:length(rch)
                                rm=find(netsections(:,1)==cluster_to_tr(rch(n),3));
                                if ~isempty(rm)
                                    netsections(rm,:)=[];
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c1,1) & sequence(:,2)==centre_pts(c1,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            dd=round((centre_pts(c1,8)+centre_pts(c7,8))/2);
                            clid=cluster_to_tr(rch,3);
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c1,1)+dd;
                                                y1=centre_pts(c1,2)+dd;
                                                x2=centre_pts(c1,1)+dd;
                                                y2=centre_pts(c1,2)-dd;
                                                x3=centre_pts(c1,1)-dd;
                                                y3=centre_pts(c1,2)+dd;
                                                x4=centre_pts(c1,1)-dd;
                                                y4=centre_pts(c1,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                                tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                            centre_pts(c1,1)=aa(1,1);
                                                            centre_pts(c1,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c1,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c1,1) centre_pts(c1,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for x=1:length(clid)
                                                for m=1:length(temp(:,1))
                                                    netsections=vertcat(netsections,[clid(x),temp(m,1),temp(m,2),0,0]);
                                                end
                                            end
                                        end
                                    end
                                    
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c1,1)+dd;
                                    y1=centre_pts(c1,2)+dd;
                                    x2=centre_pts(c1,1)+dd;
                                    y2=centre_pts(c1,2)-dd;
                                    x3=centre_pts(c1,1)-dd;
                                    y3=centre_pts(c1,2)+dd;
                                    x4=centre_pts(c1,1)-dd;
                                    y4=centre_pts(c1,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                    tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                centre_pts(c1,1)=aa(1,1);
                                                centre_pts(c1,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c1,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                end
                            end
                        end
                    else
                        c8=find(centre_pts(:,3)==centre_pts(nodes(cclust(t-1)),3));
                        rch=find(cluster_to_tr(:,1)==centre_pts(c8,3) & cluster_to_tr(:,2)== centre_pts(c7,3));
                        if isempty(rch)
                            if centre_pts(c8,3)~=centre_pts(c7,3)
                                clid=(max(netnodes(:,1))+1);
                                cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c8,3), centre_pts(c7,3), clid, round((centre_pts(c8,9)+centre_pts(c7,9))/2), round((centre_pts(c8,8)+centre_pts(c7,8))/2), distancePoints([centre_pts(c8,1) centre_pts(c8,2)], [centre_pts(c7,1) centre_pts(c7,2)], 2)]);
                                if round((w1+wgt(t,2))/2)==0
                                    w=1;
                                else
                                    w=round((w1+wgt(t,2))/2);
                                end
                                
                                if ~isempty(drc)
                                    dir=find(drc(:,1)==centre_pts(c7,3)|drc(:,1)==centre_pts(c8,3));
                                end
                                if ~isempty(dir)
                                    netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                else
                                    netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c8,1) & sequence(:,2)==centre_pts(c8,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            r3=find(cluster_to_tr(:,3)==clid);
                            dd=round((centre_pts(c8,8)+centre_pts(c7,8))/2);
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c8,1)+dd;
                                                y1=centre_pts(c8,2)+dd;
                                                x2=centre_pts(c8,1)+dd;
                                                y2=centre_pts(c8,2)-dd;
                                                x3=centre_pts(c8,1)-dd;
                                                y3=centre_pts(c8,2)+dd;
                                                x4=centre_pts(c8,1)-dd;
                                                y4=centre_pts(c8,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                                tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                            centre_pts(c8,1)=aa(1,1);
                                                            centre_pts(c8,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c8,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c8,1) centre_pts(c8,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c8,1) centre_pts(c8,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for m=1:length(temp(:,1))
                                                netsections=vertcat(netsections,[clid,temp(m,1),temp(m,2),0,0]);
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c8,1)+dd;
                                    y1=centre_pts(c8,2)+dd;
                                    x2=centre_pts(c8,1)+dd;
                                    y2=centre_pts(c8,2)-dd;
                                    x3=centre_pts(c8,1)-dd;
                                    y3=centre_pts(c8,2)+dd;
                                    x4=centre_pts(c8,1)-dd;
                                    y4=centre_pts(c8,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                    tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                centre_pts(c8,1)=aa(1,1);
                                                centre_pts(c8,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c8,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                end
                            end
                        else
                            for n=1:length(rch)
                                rm=find(netsections(:,1)==cluster_to_tr(rch(n),3));
                                if ~isempty(rm)
                                    netsections(rm,:)=[];
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c8,1) & sequence(:,2)==centre_pts(c8,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            dd=round((centre_pts(c8,8)+centre_pts(c7,8))/2);
                            clid=cluster_to_tr(rch,3);
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c8,1)+dd;
                                                y1=centre_pts(c8,2)+dd;
                                                x2=centre_pts(c8,1)+dd;
                                                y2=centre_pts(c8,2)-dd;
                                                x3=centre_pts(c8,1)-dd;
                                                y3=centre_pts(c8,2)+dd;
                                                x4=centre_pts(c8,1)-dd;
                                                y4=centre_pts(c8,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                                tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                            centre_pts(c8,1)=aa(1,1);
                                                            centre_pts(c8,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c8,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c8,1) centre_pts(c8,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c8,1) centre_pts(c8,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for x=1:length(clid)
                                                for m=1:length(temp(:,1))
                                                    netsections=vertcat(netsections,[clid(x),temp(m,1),temp(m,2),0,0]);
                                                end
                                            end
                                        end
                                    end
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c8,1)+dd;
                                    y1=centre_pts(c8,2)+dd;
                                    x2=centre_pts(c8,1)+dd;
                                    y2=centre_pts(c8,2)-dd;
                                    x3=centre_pts(c8,1)-dd;
                                    y3=centre_pts(c8,2)+dd;
                                    x4=centre_pts(c8,1)-dd;
                                    y4=centre_pts(c8,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                    tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                centre_pts(c8,1)=aa(1,1);
                                                centre_pts(c8,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c8,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                end
                            end
                        end
                    end
                end
                
                if cclust(length(cclust))~=0
                    c7=find(centre_pts(:,3)==centre_pts(nodes(cclust(length(cclust))),3));
                    rch=find(cluster_to_tr(:,1)==centre_pts(c7,3) & cluster_to_tr(:,2)== centre_pts(memf,3));
                    if isempty(rch)
                        if centre_pts(c7,3)~=centre_pts(memf,3)
                            clid=(max(netnodes(:,1))+1);
                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c7,3), centre_pts(memf,3), clid, round((centre_pts(c7,9)+centre_pts(memf,9))/2), round((centre_pts(c7,8)+centre_pts(memf,8))/2), distancePoints([centre_pts(c7,1) centre_pts(c7,2)], [centre_pts(memf,1) centre_pts(memf,2)], 2)]);
                            if round((w1+wgt(t,2))/2)==0
                                w=1;
                            else
                                w=round((w1+wgt(t,2))/2);
                            end
                            
                            if ~isempty(drc)
                                dir=find(drc(:,1)==centre_pts(memf,3)|drc(:,1)==centre_pts(c7,3));
                            end
                            if ~isempty(dir)
                                netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                            else
                                netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                            end
                        end
                        r1=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                        r2=find(sequence(:,1)==centre_pts(memf,1) & sequence(:,2)==centre_pts(memf,2));
                        r3=find(cluster_to_tr(:,3)==clid);
                        dd=round((centre_pts(c7,8)+centre_pts(memf,8))/2);
                        
                        if dd<1
                            dd=15;
                        end
                        
                        if ~isempty(r1)&&~isempty(r2)
                            interpts=sequence((r1+1):(r2-1),:);
                            p1=0;
                            p2=0;
                            p3=0;
                            p4=0;
                            if ~isempty(interpts)
                                pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                [rpts ipts]=unique(pts,'rows');
                                ipts=sortrows(ipts,1);
                                pts=pts(ipts,:);
                                
                                if ~isempty(pts)
                                    for b=1:length(pts(:,1))
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [pts(b,1) pts(b,2)]));
                                            
                                            x1=centre_pts(c7,1)+dd;
                                            y1=centre_pts(c7,2)+dd;
                                            x2=centre_pts(c7,1)+dd;
                                            y2=centre_pts(c7,2)-dd;
                                            x3=centre_pts(c7,1)-dd;
                                            y3=centre_pts(c7,2)+dd;
                                            x4=centre_pts(c7,1)-dd;
                                            y4=centre_pts(c7,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                            tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p1=length(vpts(:,1));
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                        centre_pts(c7,1)=aa(1,1);
                                                        centre_pts(c7,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p3=max(SQ(1,:));
                                                        centre_pts(c7,8)=p3;
                                                        
                                                        sequence(r1,1)=aa(1,1);
                                                        sequence(r1,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            
                                            x1=centre_pts(memf,1)+dd;
                                            y1=centre_pts(memf,2)+dd;
                                            x2=centre_pts(memf,1)+dd;
                                            y2=centre_pts(memf,2)-dd;
                                            x3=centre_pts(memf,1)-dd;
                                            y3=centre_pts(memf,2)+dd;
                                            x4=centre_pts(memf,1)-dd;
                                            y4=centre_pts(memf,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            x1=centre_pts(memf,1)+(dd)*cosd(ndegrees-90);
                                            y1=centre_pts(memf,2)+(dd)*sind(ndegrees-90);
                                            x2=centre_pts(memf,1)+(dd)*cosd(ndegrees+90);
                                            y2=centre_pts(memf,2)+(dd)*sind(ndegrees+90);
                                            e1 = createEdge([x1 y1], [x2 y2]);
                                            
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                            tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p2=length(vpts(:,1));
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                                        centre_pts(memf,1)=aa(1,1);
                                                        centre_pts(memf,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p4=max(SQ(1,:));
                                                        centre_pts(memf,8)=p4;
                                                        
                                                        sequence(r2,1)=aa(1,1);
                                                        sequence(r2,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                        end
                                        
                                        x1=pts(b,1)+dd;
                                        y1=pts(b,2)+dd;
                                        x2=pts(b,1)+dd;
                                        y2=pts(b,2)-dd;
                                        x3=pts(b,1)-dd;
                                        y3=pts(b,2)+dd;
                                        x4=pts(b,1)-dd;
                                        y4=pts(b,2)-dd;
                                        
                                        x=[x1 x2 x3 x4];
                                        x=vertcat(x,[y1 y2 y3 y4]);
                                        mb=minBoundingBox(x);
                                        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                        
                                        in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                        in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                        
                                        rs1=find(in1==1);
                                        rs2=find(in2==1);
                                        rss=union(rs1,rs2,'rows');
                                        
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]));
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                        elseif b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                        elseif b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                        end
                                        
                                        e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                        ce1=createEdge(e1,dd);
                                        tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                        tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                        dest1 = transformEdge(ce1,tr1);
                                        dest2 = transformEdge(ce1,tr2);
                                        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                        
                                        vpts=[];
                                        for h=1:length(rss)
                                            if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                point = intersectEdges(ce1, e2);
                                                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                    vpts=vertcat(vpts,point);
                                                end
                                            end
                                        end
                                        
                                        if ~isempty(vpts)
                                            rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                            if isempty(rv)
                                                vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                            end
                                            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                            
                                            if length(vpts(:,1))>1
                                                aa=centroid(vpts);
                                                pts(b,1)=aa(1,1);
                                                pts(b,2)=aa(1,2);
                                            end
                                        end
                                    end
                                    
                                    pseq=pts;
                                    
                                    circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    circle = [[centre_pts(memf,1) centre_pts(memf,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    if ~isempty(pseq)
                                        NP=[centre_pts(c7,1) centre_pts(c7,2)];
                                        [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                        NP=vertcat(NP, MP);
                                        NP=vertcat(NP, [centre_pts(memf,1) centre_pts(memf,2)]);
                                        Mdist=[NP(:,1) NP(:,2)];
                                        Y = pdist(Mdist,'euclid');
                                        SQ=squareform(Y);
                                        mclusters=zeros(length(Mdist), 1);
                                        Mdist(:,3)=1;
                                        for o=1:length(SQ(:,:))
                                            SQ(o,o)=100000.0;
                                        end
                                        
                                        %finding sequence of point cloud
                                        j=1;
                                        idxk=1;
                                        minip=100000.0;
                                        while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                            if length(idxk)>1
                                                index=0;
                                                for g=1:length(idxk)
                                                    mindist=min(SQ(idxk(g),:));
                                                    if mindist<=minip
                                                        minip=mindist;
                                                        index=g;
                                                    end
                                                end
                                                resi=find(SQ(idxk(index),:)==minip);
                                                mclusters(j)=idxk(index);
                                                minip=100000.0;
                                                j=j+1;
                                            else
                                                mindist=min(SQ(idxk,:));
                                                resi=find(SQ(idxk,:)==mindist);
                                                mclusters(j)=idxk;
                                                j=j+1;
                                            end
                                            
                                            if length(NP(:,1))==idxk
                                                break;
                                            end
                                            
                                            SQ(idxk,:)=100000;
                                            SQ(:,resi)=100000;
                                            
                                            if idxk==1
                                                SQ(:,idxk)=100000;
                                            end
                                            
                                            curr=resi;
                                            idxk=curr;
                                        end
                                        
                                        f=mclusters~=0;
                                        tempc=mclusters(f);
                                        clear mclusters;
                                        mclusters=tempc;
                                        clear tempc;
                                        
                                        temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                        for m=1:length(temp(:,1))
                                            netsections=vertcat(netsections,[clid,temp(m,1),temp(m,2),0,0]);
                                        end
                                    end
                                end
                                
                                cluster_to_tr(r3,4)=max(p1,p2);
                                cluster_to_tr(r3,5)=max(p3,p4);
                            else
                                ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                
                                x1=centre_pts(c7,1)+dd;
                                y1=centre_pts(c7,2)+dd;
                                x2=centre_pts(c7,1)+dd;
                                y2=centre_pts(c7,2)-dd;
                                x3=centre_pts(c7,1)-dd;
                                y3=centre_pts(c7,2)+dd;
                                x4=centre_pts(c7,1)-dd;
                                y4=centre_pts(c7,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    
                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p1=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                            centre_pts(c7,1)=aa(1,1);
                                            centre_pts(c7,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p3=max(SQ(1,:));
                                            centre_pts(c7,8)=p3;
                                            
                                            sequence(r1,1)=aa(1,1);
                                            sequence(r1,2)=aa(1,2);
                                            
                                        end
                                    end
                                end
                                
                                x1=centre_pts(memf,1)+dd;
                                y1=centre_pts(memf,2)+dd;
                                x2=centre_pts(memf,1)+dd;
                                y2=centre_pts(memf,2)-dd;
                                x3=centre_pts(memf,1)-dd;
                                y3=centre_pts(memf,2)+dd;
                                x4=centre_pts(memf,1)-dd;
                                y4=centre_pts(memf,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p2=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                            centre_pts(memf,1)=aa(1,1);
                                            centre_pts(memf,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p4=max(SQ(1,:));
                                            centre_pts(memf,8)=p4;
                                            
                                            sequence(r2,1)=aa(1,1);
                                            sequence(r2,2)=aa(1,2);
                                        end
                                    end
                                end
                                
                                cluster_to_tr(r3,4)=max(p1,p2);
                                cluster_to_tr(r3,5)=max(p3,p4);
                            end
                        end
                    else
                        for n=1:length(rch)
                            rm=find(netsections(:,1)==cluster_to_tr(rch(n),3));
                            if ~isempty(rm)
                                netsections(rm,:)=[];
                            end
                        end
                        r1=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                        r2=find(sequence(:,1)==centre_pts(memf,1) & sequence(:,2)==centre_pts(memf,2));
                        dd=round((centre_pts(c7,8)+centre_pts(memf,8))/2);
                        clid=cluster_to_tr(rch,3);
                        
                        if dd<1
                            dd=15;
                        end
                        
                        if ~isempty(r1)&&~isempty(r2)
                            interpts=sequence((r1+1):(r2-1),:);
                            p1=0;
                            p2=0;
                            p3=0;
                            p4=0;
                            if ~isempty(interpts)
                                pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                [rpts ipts]=unique(pts,'rows');
                                ipts=sortrows(ipts,1);
                                pts=pts(ipts,:);
                                
                                if ~isempty(pts)
                                    for b=1:length(pts(:,1))
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [pts(b,1) pts(b,2)]));
                                            
                                            x1=centre_pts(c7,1)+dd;
                                            y1=centre_pts(c7,2)+dd;
                                            x2=centre_pts(c7,1)+dd;
                                            y2=centre_pts(c7,2)-dd;
                                            x3=centre_pts(c7,1)-dd;
                                            y3=centre_pts(c7,2)+dd;
                                            x4=centre_pts(c7,1)-dd;
                                            y4=centre_pts(c7,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                            tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p1=length(vpts(:,1));
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                        centre_pts(c7,1)=aa(1,1);
                                                        centre_pts(c7,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p3=max(SQ(1,:));
                                                        centre_pts(c7,8)=p3;
                                                        
                                                        sequence(r1,1)=aa(1,1);
                                                        sequence(r1,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            
                                            x1=centre_pts(memf,1)+dd;
                                            y1=centre_pts(memf,2)+dd;
                                            x2=centre_pts(memf,1)+dd;
                                            y2=centre_pts(memf,2)-dd;
                                            x3=centre_pts(memf,1)-dd;
                                            y3=centre_pts(memf,2)+dd;
                                            x4=centre_pts(memf,1)-dd;
                                            y4=centre_pts(memf,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            x1=centre_pts(memf,1)+(dd)*cosd(ndegrees-90);
                                            y1=centre_pts(memf,2)+(dd)*sind(ndegrees-90);
                                            x2=centre_pts(memf,1)+(dd)*cosd(ndegrees+90);
                                            y2=centre_pts(memf,2)+(dd)*sind(ndegrees+90);
                                            e1 = createEdge([x1 y1], [x2 y2]);
                                            
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                            tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p2=length(vpts(:,1));
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                                        centre_pts(memf,1)=aa(1,1);
                                                        centre_pts(memf,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p4=max(SQ(1,:));
                                                        centre_pts(memf,8)=p4;
                                                        
                                                        sequence(r2,1)=aa(1,1);
                                                        sequence(r2,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                        end
                                        
                                        x1=pts(b,1)+dd;
                                        y1=pts(b,2)+dd;
                                        x2=pts(b,1)+dd;
                                        y2=pts(b,2)-dd;
                                        x3=pts(b,1)-dd;
                                        y3=pts(b,2)+dd;
                                        x4=pts(b,1)-dd;
                                        y4=pts(b,2)-dd;
                                        
                                        x=[x1 x2 x3 x4];
                                        x=vertcat(x,[y1 y2 y3 y4]);
                                        mb=minBoundingBox(x);
                                        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                        
                                        in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                        in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                        
                                        rs1=find(in1==1);
                                        rs2=find(in2==1);
                                        rss=union(rs1,rs2,'rows');
                                        
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]));
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                        elseif b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                        elseif b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                        end
                                        
                                        e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                        ce1=createEdge(e1,dd);
                                        tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                        tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                        dest1 = transformEdge(ce1,tr1);
                                        dest2 = transformEdge(ce1,tr2);
                                        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                        
                                        vpts=[];
                                        for h=1:length(rss)
                                            if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                point = intersectEdges(ce1, e2);
                                                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                    vpts=vertcat(vpts,point);
                                                end
                                            end
                                        end
                                        
                                        if ~isempty(vpts)
                                            
                                            rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                            if isempty(rv)
                                                vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                            end
                                            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                            
                                            if length(vpts(:,1))>1
                                                aa=centroid(vpts);
                                                pts(b,1)=aa(1,1);
                                                pts(b,2)=aa(1,2);
                                            end
                                        end
                                    end
                                    
                                    pseq=pts;
                                    
                                    circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    circle = [[centre_pts(memf,1) centre_pts(memf,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    if ~isempty(pseq)
                                        NP=[centre_pts(c7,1) centre_pts(c7,2)];
                                        [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                        NP=vertcat(NP, MP);
                                        NP=vertcat(NP, [centre_pts(memf,1) centre_pts(memf,2)]);
                                        Mdist=[NP(:,1) NP(:,2)];
                                        Y = pdist(Mdist,'euclid');
                                        SQ=squareform(Y);
                                        mclusters=zeros(length(Mdist), 1);
                                        Mdist(:,3)=1;
                                        for o=1:length(SQ(:,:))
                                            SQ(o,o)=100000.0;
                                        end
                                        
                                        %finding sequence of point cloud
                                        j=1;
                                        idxk=1;
                                        minip=100000.0;
                                        while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                            if length(idxk)>1
                                                index=0;
                                                for g=1:length(idxk)
                                                    mindist=min(SQ(idxk(g),:));
                                                    if mindist<=minip
                                                        minip=mindist;
                                                        index=g;
                                                    end
                                                end
                                                resi=find(SQ(idxk(index),:)==minip);
                                                mclusters(j)=idxk(index);
                                                minip=100000.0;
                                                j=j+1;
                                            else
                                                mindist=min(SQ(idxk,:));
                                                resi=find(SQ(idxk,:)==mindist);
                                                mclusters(j)=idxk;
                                                j=j+1;
                                            end
                                            
                                            if length(NP(:,1))==idxk
                                                break;
                                            end
                                            
                                            SQ(idxk,:)=100000;
                                            SQ(:,resi)=100000;
                                            
                                            if idxk==1
                                                SQ(:,idxk)=100000;
                                            end
                                            
                                            curr=resi;
                                            idxk=curr;
                                        end
                                        
                                        f=mclusters~=0;
                                        tempc=mclusters(f);
                                        clear mclusters;
                                        mclusters=tempc;
                                        clear tempc;
                                        
                                        temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                        for x=1:length(clid)
                                            for m=1:length(temp(:,1))
                                                netsections=vertcat(netsections,[clid(x),temp(m,1),temp(m,2),0,0]);
                                            end
                                        end
                                    end
                                end
                                for n=1:length(rch)
                                    cluster_to_tr(rch(n),4)=max(p1,p2);
                                    cluster_to_tr(rch(n),5)=max(p3,p4);
                                end
                            else
                                ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                
                                x1=centre_pts(c7,1)+dd;
                                y1=centre_pts(c7,2)+dd;
                                x2=centre_pts(c7,1)+dd;
                                y2=centre_pts(c7,2)-dd;
                                x3=centre_pts(c7,1)-dd;
                                y3=centre_pts(c7,2)+dd;
                                x4=centre_pts(c7,1)-dd;
                                y4=centre_pts(c7,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    
                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p1=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                            centre_pts(c7,1)=aa(1,1);
                                            centre_pts(c7,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p3=max(SQ(1,:));
                                            centre_pts(c7,8)=p3;
                                            
                                            sequence(r1,1)=aa(1,1);
                                            sequence(r1,2)=aa(1,2);
                                            
                                        end
                                    end
                                end
                                
                                x1=centre_pts(memf,1)+dd;
                                y1=centre_pts(memf,2)+dd;
                                x2=centre_pts(memf,1)+dd;
                                y2=centre_pts(memf,2)-dd;
                                x3=centre_pts(memf,1)-dd;
                                y3=centre_pts(memf,2)+dd;
                                x4=centre_pts(memf,1)-dd;
                                y4=centre_pts(memf,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p2=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                            centre_pts(memf,1)=aa(1,1);
                                            centre_pts(memf,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p4=max(SQ(1,:));
                                            centre_pts(memf,8)=p4;
                                            
                                            sequence(r2,1)=aa(1,1);
                                            sequence(r2,2)=aa(1,2);
                                            
                                        end
                                    end
                                end
                                for n=1:length(rch)
                                    cluster_to_tr(rch(n),4)=max(p1,p2);
                                    cluster_to_tr(rch(n),5)=max(p3,p4);
                                end
                            end
                        end
                    end
                end
                
                if ~isempty(nxtfl)
                    for v=1:length(nxtfl)
                        dx=sqrt((centre_pts(memf,1)-centre_pts(nxtfl(v),1))^2+(centre_pts(memf,2)-centre_pts(nxtfl(v),2))^2);
                        if dx<=100
                            rch=find(cluster_to_tr(:,1)==centre_pts(memf,3) & cluster_to_tr(:,2)==centre_pts(nxtfl(v),3));
                            if isempty(rch)
                                if centre_pts(memf,3)~=centre_pts(nxtfl(v),3)
                                    clid=(max(netnodes(:,1))+1);
                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(memf,3),centre_pts(nxtfl(v),3), clid, round((centre_pts(memf,9)+centre_pts(nxtfl(v),9))/2), round((centre_pts(memf,8)+centre_pts(nxtfl(v),8))/2), distancePoints([centre_pts(memf,1) centre_pts(memf,2)], [centre_pts(nxtfl(v),1) centre_pts(nxtfl(v),2)], 2)]);
                                    if ~isempty(drc)
                                        dir=find(drc(:,1)==centre_pts(memf,3)|drc(:,1)==centre_pts(nxtfl(v),3));
                                    end
                                    if ~isempty(dir)
                                        netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                    else
                                        netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                    end
                                end
                            end
                        end
                    end
                end
                
                rr=find(cluster_to_tr(:,1)==centre_pts(c1,3)&cluster_to_tr(:,2)==centre_pts(c2,3));
                if ~isempty(rr)
                    cluster_to_tr(rr,:)=[];
                end
                
                if ~isempty(res)
                    r=find(netsections(:,1)==netnodes(k,1));
                    r=unique(r);
                    h=length(r);
                    while h>=1
                        netsections(r(h),:)=[];
                        h=h-1;
                    end
                end
                
            else
                p1=0;
                p2=0;
                p3=0;
                p4=0;
                
                
                dd=round((centre_pts(c1,8)+centre_pts(c2,8))/2);
                
                if dd<1
                    dd=15;
                end
                
                if ~isempty(res)
                    for v=1:length(res)
                        if v==1
                            ndegrees=rad2deg(angle2Points([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]));
                            
                            x1=centre_pts(c1,1)+dd;
                            y1=centre_pts(c1,2)+dd;
                            x2=centre_pts(c1,1)+dd;
                            y2=centre_pts(c1,2)-dd;
                            x3=centre_pts(c1,1)-dd;
                            y3=centre_pts(c1,2)+dd;
                            x4=centre_pts(c1,1)-dd;
                            y4=centre_pts(c1,2)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]);
                            e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                            tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==centre_pts(c1,1)&pts(:,2)==centre_pts(c1,2));
                                if isempty(rv)
                                    pts=vertcat(pts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                p1=length(pts(:,1));
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                        centre_pts(c1,1)=aa(1,1);
                                        centre_pts(c1,2)=aa(1,2);
                                        
                                        mb=pts;
                                        mb=unique(pts,'rows');
                                        pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                        pd=vertcat(pd,mb);
                                        
                                        Y = pdist(pd,'euclid');
                                        SQ=squareform(Y);
                                        p3=max(SQ(1,:));
                                        centre_pts(c1,8)=p3;
                                    end
                                end
                            end
                            
                            x1=netsections(res(1),2)+dd;
                            y1=netsections(res(1),3)+dd;
                            x2=netsections(res(1),2)+dd;
                            y2=netsections(res(1),3)-dd;
                            x3=netsections(res(1),2)-dd;
                            y3=netsections(res(1),3)+dd;
                            x4=netsections(res(1),2)-dd;
                            y4=netsections(res(1),3)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            ndegrees=rad2deg(angle2Points([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]));
                            in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]);
                            
                            e1 =orthogonalLine(in, [netsections(res(1),2) netsections(res(1),3)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([netsections(res(1),2) netsections(res(1),3)], 0);
                            tr2 = createRotation([netsections(res(1),2) netsections(res(1),3)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=netsections(res(1),2)&elk(rss(h),2)~=netsections(res(1),3)&elk(rss(h),3)~=netsections(res(1),2)&elk(rss(h),4)~=netsections(res(1),3)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==netsections(res(1),2)&pts(:,2)==netsections(res(1),3));
                                if isempty(rv)
                                    pts=vertcat(pts,[netsections(res(1),2) netsections(res(1),3)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([netsections(res(1),2) netsections(res(1),3)], aa, 2)<=dd
                                        netsections(res(1),2)=aa(1,1);
                                        netsections(res(1),3)=aa(1,2);
                                    end
                                    
                                end
                            end
                        end
                        if v==length(res)
                            ndegrees=rad2deg(angle2Points([netsections(res(length(res)),2) netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]));
                            
                            x1=centre_pts(c2,1)+dd;
                            y1=centre_pts(c2,2)+dd;
                            x2=centre_pts(c2,1)+dd;
                            y2=centre_pts(c2,2)-dd;
                            x3=centre_pts(c2,1)-dd;
                            y3=centre_pts(c2,2)+dd;
                            x4=centre_pts(c2,1)-dd;
                            y4=centre_pts(c2,2)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            
                            in = createLine([netsections(res(length(res)),2) netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                            e1 =orthogonalLine(in, [centre_pts(c2,1),centre_pts(c2,2)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([centre_pts(c2,1),centre_pts(c2,2)], 0);
                            tr2 = createRotation([centre_pts(c2,1),centre_pts(c2,2)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=centre_pts(c2,1)&elk(rss(h),2)~=centre_pts(c2,2)&elk(rss(h),3)~=centre_pts(c2,1)&elk(rss(h),4)~=centre_pts(c2,2)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==centre_pts(c2,1)&pts(:,2)==centre_pts(c2,2));
                                if isempty(rv)
                                    pts=vertcat(pts,[centre_pts(c2,1) centre_pts(c2,2)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                p2=length(pts(:,1));
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([centre_pts(c2,1) centre_pts(c2,2)], aa, 2)<=dd
                                        centre_pts(c2,1)=aa(1,1);
                                        centre_pts(c2,2)=aa(1,2);
                                        
                                        mb=pts;
                                        mb=unique(pts,'rows');
                                        pd=[centre_pts(c2,1) centre_pts(c2,2)];
                                        pd=vertcat(pd,mb);
                                        
                                        Y = pdist(pd,'euclid');
                                        SQ=squareform(Y);
                                        p4=max(SQ(1,:));
                                        centre_pts(c2,8)=p4;
                                    end
                                end
                            end
                            
                            
                            x1=netsections(res(length(res)),2)+dd;
                            y1=netsections(res(length(res)),3)+dd;
                            x2=netsections(res(length(res)),2)+dd;
                            y2=netsections(res(length(res)),3)-dd;
                            x3=netsections(res(length(res)),2)-dd;
                            y3=netsections(res(length(res)),3)+dd;
                            x4=netsections(res(length(res)),2)-dd;
                            y4=netsections(res(length(res)),3)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            in = createLine([netsections(res(length(res)),2) netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                            e1 =orthogonalLine(in, [netsections(res(length(res)),2) netsections(res(length(res)),3)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([netsections(res(length(res)),2) netsections(res(length(res)),3)], 0);
                            tr2 = createRotation([netsections(res(length(res)),2) netsections(res(length(res)),3)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=netsections(res(length(res)),2)&elk(rss(h),2)~=netsections(res(length(res)),3)&elk(rss(h),3)~=netsections(res(length(res)),2)&elk(rss(h),4)~=netsections(res(length(res)),3)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            if ~isempty(pts)
                                rv=find(pts(:,1)==netsections(res(length(res)),2)&pts(:,2)==netsections(res(length(res)),3));
                                if isempty(rv)
                                    pts=vertcat(pts,[netsections(res(length(res)),2) netsections(res(length(res)),3)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([netsections(res(length(res)),2) netsections(res(length(res)),3)], aa, 2)<=dd
                                        netsections(res(length(res)),2)=aa(1,1);
                                        netsections(res(length(res)),3)=aa(1,2);
                                    end
                                end
                            end
                        end
                        if v<length(res)
                            ndegrees=rad2deg(angle2Points([netsections(res(v),2) netsections(res(v),3)],[netsections(res(v+1),2) netsections(res(v+1),3)]));
                            x1=netsections(res(v),2)+dd;
                            y1=netsections(res(v),3)+dd;
                            x2=netsections(res(v),2)+dd;
                            y2=netsections(res(v),3)-dd;
                            x3=netsections(res(v),2)-dd;
                            y3=netsections(res(v),3)+dd;
                            x4=netsections(res(v),2)-dd;
                            y4=netsections(res(v),3)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            in = createLine([netsections(res(v),2) netsections(res(v),3)],[netsections(res(v+1),2) netsections(res(v+1),3)]);
                            e1 =orthogonalLine(in, [netsections(res(v),2) netsections(res(v),3)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([netsections(res(v),2) netsections(res(v),3)], 0);
                            tr2 = createRotation([netsections(res(v),2) netsections(res(v),3)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=netsections(res(v),2)&elk(rss(h),2)~=netsections(res(v),3)&elk(rss(h),3)~=netsections(res(v),2)&elk(rss(h),4)~=netsections(res(v),3)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==netsections(res(v),2)&pts(:,2)==netsections(res(v),3));
                                if isempty(rv)
                                    pts=vertcat(pts,[netsections(res(v),2) netsections(res(v),3)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                
                                
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([netsections(res(v),2) netsections(res(v),3)], aa, 2)<=dd
                                        netsections(res(v),2)=aa(1,1);
                                        netsections(res(v),3)=aa(1,2);
                                    end
                                end
                            end
                        end
                    end
                else
                    ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]));
                    
                    x1=centre_pts(c1,1)+dd;
                    y1=centre_pts(c1,2)+dd;
                    x2=centre_pts(c1,1)+dd;
                    y2=centre_pts(c1,2)-dd;
                    x3=centre_pts(c1,1)-dd;
                    y3=centre_pts(c1,2)+dd;
                    x4=centre_pts(c1,1)-dd;
                    y4=centre_pts(c1,2)-dd;
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                    
                    rs1=find(in1==1);
                    rs2=find(in2==1);
                    rss=union(rs1,rs2,'rows');
                    
                    in = createLine([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]);
                    e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                    ce1=createEdge(e1,dd);
                    tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                    tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                    dest1 = transformEdge(ce1,tr1);
                    dest2 = transformEdge(ce1,tr2);
                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                    
                    vpts=[];
                    for h=1:length(rss)
                        if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                            point = intersectEdges(ce1, e2);
                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                vpts=vertcat(vpts,point);
                            end
                        end
                    end
                    
                    
                    if ~isempty(vpts)
                        
                        rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                        if isempty(rv)
                            vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                        end
                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                        p1=length(vpts(:,1));
                        
                        if length(vpts(:,1))>1
                            aa=centroid(vpts);
                            if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                centre_pts(c1,1)=aa(1,1);
                                centre_pts(c1,2)=aa(1,2);
                                
                                mb=vpts;
                                mb=unique(vpts,'rows');
                                pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                pd=vertcat(pd,mb);
                                
                                Y = pdist(pd,'euclid');
                                SQ=squareform(Y);
                                p3=max(SQ(1,:));
                                centre_pts(c1,8)=p3;
                            end
                        end
                    end
                    
                    
                    x1=centre_pts(c2,1)+dd;
                    y1=centre_pts(c2,2)+dd;
                    x2=centre_pts(c2,1)+dd;
                    y2=centre_pts(c2,2)-dd;
                    x3=centre_pts(c2,1)-dd;
                    y3=centre_pts(c2,2)+dd;
                    x4=centre_pts(c2,1)-dd;
                    y4=centre_pts(c2,2)-dd;
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                    
                    rs1=find(in1==1);
                    rs2=find(in2==1);
                    rss=union(rs1,rs2,'rows');
                    
                    e1 =orthogonalLine(in, [centre_pts(c2,1) centre_pts(c2,2)]);
                    ce1=createEdge(e1,dd);
                    tr1 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], 0);
                    tr2 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], pi);
                    dest1 = transformEdge(ce1,tr1);
                    dest2 = transformEdge(ce1,tr2);
                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                    
                    vpts=[];
                    for h=1:length(rss)
                        if elk(rss(h),1)~=centre_pts(c2,1)&elk(rss(h),2)~=centre_pts(c2,2)&elk(rss(h),3)~=centre_pts(c2,1)&elk(rss(h),4)~=centre_pts(c2,2)
                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                            point = intersectEdges(ce1, e2);
                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                vpts=vertcat(vpts,point);
                            end
                        end
                    end
                    
                    if ~isempty(vpts)
                        rv=find(vpts(:,1)==centre_pts(c2,1)&vpts(:,2)==centre_pts(c2,2));
                        if isempty(rv)
                            vpts=vertcat(vpts,[centre_pts(c2,1) centre_pts(c2,2)]);
                        end
                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                        p2=length(vpts(:,1));
                        
                        if length(vpts(:,1))>1
                            aa=centroid(vpts);
                            if distancePoints([centre_pts(c2,1) centre_pts(c2,2)], aa, 2)<=dd
                                centre_pts(c2,1)=aa(1,1);
                                centre_pts(c2,2)=aa(1,2);
                                
                                mb=vpts;
                                mb=unique(vpts,'rows');
                                pd=[centre_pts(c2,1) centre_pts(c2,2)];
                                pd=vertcat(pd,mb);
                                
                                Y = pdist(pd,'euclid');
                                SQ=squareform(Y);
                                p4=max(SQ(1,:));
                                centre_pts(c2,8)=p4;
                            end
                        end
                    end
                    
                    cluster_to_tr(sres,4)=max(p1,p2);
                    cluster_to_tr(sres,5)=max(p3,p4);
                end
            end
            
            
        elseif  isempty(res) && ~isempty(sres)
            
            c1=find(centre_pts(:,3)==cluster_to_tr(sres,1));
            c2=find(centre_pts(:,3)==cluster_to_tr(sres,2));
            st(1,1)=centre_pts(c1,1);
            st(1,2)=centre_pts(c1,2);
            en(1,1)=centre_pts(c2,1);
            en(1,2)=centre_pts(c2,2);
            dx1=sqrt((centre_pts(c1,1)-centre_pts(c2,1))^2+(centre_pts(c1,2)-centre_pts(c2,2))^2);
            gdy=0;
            
            distances1=vertcat(distances1,dx1);
            
            if scounter>10
                dy=20;
                gdy=15;
            elseif scounter<=10
                if cluster_to_tr(sres,5)~=0
                    if cluster_to_tr(sres,5)<=50
                        dy=cluster_to_tr(sres,5)+5;
                        gdy=20;
                    else
                        dy=cluster_to_tr(sres,5);
                        gdy=20;
                    end
                    
                else
                    dy=45;
                    gdy=20;
                end
            end
            
            memf=c2;
            
            validids=[];
            vid=1;
            segment=[];
            sid=1;
            minids=[];
            mid=1;
            
            bbox=[];
            rbbox=[];
            
            ndegrees=rad2deg(angle2Points([centre_pts(c1,1),centre_pts(c1,2)],[centre_pts(c2,1),centre_pts(c2,2)]));
            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
            
            x=[x1 x2 x3 x4];
            x=vertcat(x,[y1 y2 y3 y4]);
            mb=minBoundingBox(x);
            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
            
            bbox=mb';
            poly1=[centre_pts(c1,1) centre_pts(c1,2)];
            poly1=vertcat(poly1,[centre_pts(c2,1) centre_pts(c2,2)]);
            in = inpolygon(centre_pts(:,1),centre_pts(:,2),bbox(:,1),bbox(:,2));
            c4=centre_pts(in,3);
            
            hold on;
            nsegs=[];
            segscl=[];
            validids=[];
            if ~isempty(c4)
                intermediate=[];
                split=[];
                for h=1:length(c4)
                    rc=find(cluster_to_tr(:,1)==c4(h)|cluster_to_tr(:,2)==c4(h));
                    for n=1:length(rc)
                        segment=[];
                        maxd=2000;
                        if cluster_to_tr(rc(n),1)==cluster_to_tr(sres,1)&&cluster_to_tr(rc(n),2)==cluster_to_tr(sres,2)
                            continue;
                        elseif cluster_to_tr(rc(n),1)==cluster_to_tr(sres,2)&&cluster_to_tr(rc(n),2)==cluster_to_tr(sres,1)
                            rw=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                            netnodes(k,2)=netnodes(k,2)+netnodes(rw,2);
                            netnodes(k,4)=2;
                            nsegs=vertcat(nsegs,[cluster_to_tr(rc(n),3),2]);
                            continue;
                        else
                            memcntr=0;
                            rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                            rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                            rn=find(netsections(:,1)==cluster_to_tr(rc(n),3));
                            segment=[centre_pts(rc1,1) centre_pts(rc1,2)];
                            segment=vertcat(segment, [netsections(rn,2) netsections(rn,3)]);
                            segment=vertcat(segment, [centre_pts(rc2,1) centre_pts(rc2,2)]);
                            segment(:,3)=0;
                            dx1=sqrt((centre_pts(c1,1)-centre_pts(c2,1))^2+(centre_pts(c1,2)-centre_pts(c2,2))^2);
                            maxd=dy;
                            ri=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                            if ~isempty(ri)
                                riw=netnodes(ri,2);
                            end
                            
                            if scounter>10
                                dy=20;
                                gdy=15;
                            elseif scounter<=10
                                if cluster_to_tr(sres,5)~=0
                                    if cluster_to_tr(sres,5)<=50
                                        dy=cluster_to_tr(sres,5)+5;
                                        gdy=20;
                                    else
                                        dy=cluster_to_tr(sres,5);
                                        gdy=20;
                                    end
                                    
                                else
                                    dy=45;
                                    gdy=20;
                                end
                            end
                            
                            ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[centre_pts(c2,1),centre_pts(c2,2)]);
                            
                            if ndegrees>=0 && ndegrees<90
                                
                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                slope=(centre_pts(c2,2)-centre_pts(c1,2))/(centre_pts(c2,1)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                if (d(1)<=100||d(2)<=100) && (cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))&&...
                                        (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3))
                                    rd=find(d==max(d));
                                    if d(rd)==0
                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                    else
                                        if d(rd)>dy && d(rd)<100
                                            x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                    end
                                else
                                    if (d(1)<=200||d(2)<=200) && ((cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))||...
                                            (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3)))
                                        cnode=[];
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),1));
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),2));
                                        rcn=find(cnode(:)~=centre_pts(c1,3)&cnode(:)~=centre_pts(c2,3));
                                        if length(rcn)==1
                                            rl=find(cluster_to_tr(:,1)==cnode(rcn)|cluster_to_tr(:,2)==cnode(rcn));
                                            anodes=[];
                                            for g=1:length(rl)
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),1));
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),2));
                                            end
                                            rl1=find(anodes(:)==centre_pts(c1,3));
                                            rl2=find(anodes(:)==centre_pts(c2,3));
                                            if ~isempty(rl1) && ~isempty(rl2)
                                                rd=find(d==max(d));
                                                if d(rd)==0
                                                    x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                else
                                                    x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                end
                                            else
                                                if d(1)<=25&&d(2)<=dd
                                                    rd=find(d==max(d));
                                                    if d(rd)==0
                                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    end
                                                else
                                                    if d(1)==0&&d(2)<=50||d(1)<=50&&d(2)==0
                                                        rd=find(d==max(d));
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                                    end
                                                end
                                            end
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                        
                                    else
                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                    end
                                end
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox=[node(:,1) node(:,2)];
                                if ~isempty(rn)
                                    for o=1:length(rn)
                                        if o==1
                                            [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                            if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                            if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o+1,3)=in;
                                            end
                                            
                                        end
                                        if o==length(rn)
                                            [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+2,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                            if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+1,3)=in;
                                            end
                                        end
                                        [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                        if o<length(rn)
                                            pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                        elseif length(rn)==1
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                        end
                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(o+1,3)=in;
                                        end
                                    end
                                else
                                    [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                    [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                    
                                    
                                    if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                        if d(1)~=0&&d(2)~=0
                                            if d(1)<=20&&d(2)<=20&&in1==1&&in2==1
                                                segment(1,3)=1;
                                                segment(2,3)=1;
                                            elseif d(1)<=20&&d(2)<=20&&(in1==1||in1==0)&&(in2==1||in1==0)
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            else
                                                if d(1)<=20
                                                    memcntr=rc1;
                                                    segment(1,3)=1;
                                                end
                                                if d(2)<=20
                                                    memcntr=rc2;
                                                    segment(2,3)=1;
                                                end
                                            end
                                        else
                                            if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                            if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                        end
                                    else
                                        in1=0;
                                        in2=0;
                                        if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(1,3)=in;
                                            
                                        else
                                            in1=in;
                                        end
                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                        
                                        if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(2,3)=in;
                                            
                                        else
                                            in2=in;
                                        end
                                        
                                        if in1==1&& in2==1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(1,3)=1;
                                            segment(2,3)=1;
                                        end
                                    end
                                end
                            elseif ndegrees>=90 && ndegrees<180
                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                slope=(centre_pts(c2,2)-centre_pts(c1,2))/(centre_pts(c2,1)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                
                                if (d(1)<=100||d(2)<=100) && (cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))&&...
                                        (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3))
                                    rd=find(d==max(d));
                                    if d(rd)==0
                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                    else
                                        if d(rd)>dy && d(rd)<100
                                            x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                    end
                                else
                                    if (d(1)<=200||d(2)<=200) && ((cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))||...
                                            (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3)))
                                        cnode=[];
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),1));
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),2));
                                        rcn=find(cnode(:)~=centre_pts(c1,3)&cnode(:)~=centre_pts(c2,3));
                                        if length(rcn)==1
                                            rl=find(cluster_to_tr(:,1)==cnode(rcn)|cluster_to_tr(:,2)==cnode(rcn));
                                            anodes=[];
                                            for g=1:length(rl)
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),1));
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),2));
                                            end
                                            rl1=find(anodes(:)==centre_pts(c1,3));
                                            rl2=find(anodes(:)==centre_pts(c2,3));
                                            if ~isempty(rl1) && ~isempty(rl2)
                                                rd=find(d==max(d));
                                                if d(rd)==0
                                                    x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                else
                                                    x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                end
                                            else
                                                if d(1)<=25&&d(2)<=dd
                                                    rd=find(d==max(d));
                                                    if d(rd)==0
                                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    end
                                                else
                                                    if d(1)==0&&d(2)<=50||d(1)<=50&&d(2)==0
                                                        rd=find(d==max(d));
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                                    end
                                                end
                                            end
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                        
                                    else
                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                    end
                                end
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox=[node(:,1) node(:,2)];
                                if ~isempty(rn)
                                    for o=1:length(rn)
                                        if o==1
                                            [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                            if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                            if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o+1,3)=in;
                                            end
                                            
                                        end
                                        if o==length(rn)
                                            [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+2,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                            if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+1,3)=in;
                                            end
                                        end
                                        [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                        if o<length(rn)
                                            pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                        elseif length(rn)==1
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                        end
                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(o+1,3)=in;
                                        end
                                    end
                                else
                                    [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                    [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                    
                                    if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                        if d(1)~=0&&d(2)~=0
                                            if d(1)<=20&&d(2)<=20&&in1==1&&in2==1
                                                segment(1,3)=1;
                                                segment(2,3)=1;
                                            elseif d(1)<=20&&d(2)<=20&&(in1==1||in1==0)&&(in2==1||in1==0)
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            else
                                                if d(1)<=20
                                                    memcntr=rc1;
                                                    segment(1,3)=1;
                                                end
                                                if d(2)<=20
                                                    memcntr=rc2;
                                                    segment(2,3)=1;
                                                end
                                            end
                                        else
                                            if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                            if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                        end
                                    else
                                        in1=0;
                                        in2=0;
                                        if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(1,3)=in;
                                            
                                        else
                                            in1=in;
                                        end
                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                        
                                        if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(2,3)=in;
                                            
                                        else
                                            in2=in;
                                        end
                                        
                                        if in1==1&& in2==1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(1,3)=1;
                                            segment(2,3)=1;
                                        end
                                    end
                                end
                            elseif ndegrees>=180 && ndegrees<270
                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                slope=(centre_pts(c2,2)-centre_pts(c1,2))/(centre_pts(c2,1)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                
                                if (d(1)<=100||d(2)<=100) && (cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))&&...
                                        (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3))
                                    rd=find(d==max(d));
                                    if d(rd)==0
                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                    else
                                        if d(rd)>dy && d(rd)<100
                                            x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                    end
                                else
                                    if (d(1)<=200||d(2)<=200) && ((cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))||...
                                            (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3)))
                                        cnode=[];
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),1));
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),2));
                                        rcn=find(cnode(:)~=centre_pts(c1,3)&cnode(:)~=centre_pts(c2,3));
                                        if length(rcn)==1
                                            rl=find(cluster_to_tr(:,1)==cnode(rcn)|cluster_to_tr(:,2)==cnode(rcn));
                                            anodes=[];
                                            for g=1:length(rl)
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),1));
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),2));
                                            end
                                            rl1=find(anodes(:)==centre_pts(c1,3));
                                            rl2=find(anodes(:)==centre_pts(c2,3));
                                            if ~isempty(rl1) && ~isempty(rl2)
                                                rd=find(d==max(d));
                                                if d(rd)==0
                                                    x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                else
                                                    x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                end
                                                
                                            else
                                                if d(1)<=25&&d(2)<=dd
                                                    rd=find(d==max(d));
                                                    if d(rd)==0
                                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    end
                                                else
                                                    if d(1)==0&&d(2)<=50||d(1)<=50&&d(2)==0
                                                        rd=find(d==max(d));
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                                    end
                                                end
                                            end
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                        
                                    else
                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                    end
                                end
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox=[node(:,1) node(:,2)];
                                if ~isempty(rn)
                                    for o=1:length(rn)
                                        if o==1
                                            [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                            if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                            if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o+1,3)=in;
                                            end
                                            
                                        end
                                        if o==length(rn)
                                            [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+2,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                            if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+1,3)=in;
                                            end
                                        end
                                        [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                        if o<length(rn)
                                            pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                        elseif length(rn)==1
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                        end
                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(o+1,3)=in;
                                        end
                                    end
                                else
                                    [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                    [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                    
                                    if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                        if d(1)~=0&&d(2)~=0
                                            if d(1)<=20&&d(2)<=20&&in1==1&&in2==1
                                                segment(1,3)=1;
                                                segment(2,3)=1;
                                            elseif d(1)<=20&&d(2)<=20&&(in1==1||in1==0)&&(in2==1||in1==0)
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            else
                                                if d(1)<=20
                                                    memcntr=rc1;
                                                    segment(1,3)=1;
                                                end
                                                if d(2)<=20
                                                    memcntr=rc2;
                                                    segment(2,3)=1;
                                                end
                                            end
                                        else
                                            if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                            if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                        end
                                    else
                                        in1=0;
                                        in2=0;
                                        if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(1,3)=in;
                                            
                                        else
                                            in1=in;
                                        end
                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                        
                                        if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(2,3)=in;
                                            
                                        else
                                            in2=in;
                                        end
                                        
                                        if in1==1&& in2==1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(1,3)=1;
                                            segment(2,3)=1;
                                        end
                                    end
                                end
                            elseif ndegrees>=270 && ndegrees<=361
                                Ddist=vertcat([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rc2,1) centre_pts(rc2,2)]);
                                slope=(centre_pts(c2,2)-centre_pts(c1,2))/(centre_pts(c2,1)-centre_pts(c1,1));
                                b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                                d=abs(slope*Ddist(:,1) + (-1)*Ddist(:,2) + b)/sqrt(slope^2+(-1)^2);
                                
                                if (d(1)<=100||d(2)<=100) && (cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))&&...
                                        (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3))
                                    rd=find(d==max(d));
                                    if d(rd)==0
                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                    else
                                        if d(rd)>dy && d(rd)<100
                                            x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                    end
                                else
                                    if (d(1)<=200||d(2)<=200) && ((cluster_to_tr(rc(n),1)==centre_pts(c1,3)||cluster_to_tr(rc(n),1)==centre_pts(c2,3))||...
                                            (cluster_to_tr(rc(n),2)==centre_pts(c1,3)||cluster_to_tr(rc(n),2)==centre_pts(c2,3)))
                                        cnode=[];
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),1));
                                        cnode=vertcat(cnode,cluster_to_tr(rc(n),2));
                                        rcn=find(cnode(:)~=centre_pts(c1,3)&cnode(:)~=centre_pts(c2,3));
                                        if length(rcn)==1
                                            rl=find(cluster_to_tr(:,1)==cnode(rcn)|cluster_to_tr(:,2)==cnode(rcn));
                                            anodes=[];
                                            for g=1:length(rl)
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),1));
                                                anodes=vertcat(anodes,cluster_to_tr(rl(g),2));
                                            end
                                            rl1=find(anodes(:)==centre_pts(c1,3));
                                            rl2=find(anodes(:)==centre_pts(c2,3));
                                            if ~isempty(rl1) && ~isempty(rl2)
                                                rd=find(d==max(d));
                                                if d(rd)==0
                                                    x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                else
                                                    x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                    y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                    x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                    y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                    x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                    y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                    x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                    y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                end
                                            else
                                                if d(1)<=25&&d(2)<=dd
                                                    rd=find(d==max(d));
                                                    if d(rd)==0
                                                        x1=centre_pts(c1,1)+5*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+5*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+5*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+5*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+5*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+5*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+5*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+5*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    end
                                                else
                                                    if d(1)==0&&d(2)<=50||d(1)<=50&&d(2)==0
                                                        rd=find(d==max(d));
                                                        x1=centre_pts(c1,1)+d(rd)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+d(rd)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+d(rd)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+d(rd)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+d(rd)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+d(rd)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+d(rd)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+d(rd)*sind(ndegrees+90);
                                                    else
                                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                                    end
                                                end
                                            end
                                        else
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                        end
                                        
                                    else
                                        x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                        y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                        x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                        y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                        x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                        y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                        x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                        y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                    end
                                end
                                
                                node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                bbox=[node(:,1) node(:,2)];
                                if ~isempty(rn)
                                    for o=1:length(rn)
                                        if o==1
                                            [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                            if segment(o,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(1),2),netsections(rn(1),3),bbox(:,1),bbox(:,2));
                                            if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(o+1,3)=in;
                                            end
                                            
                                        end
                                        if o==length(rn)
                                            [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                            pdegrees=line_angle([netsections(rn(length(rn)),2),netsections(rn(length(rn)),3)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            if segment(length(rn)+2,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+2,3)=in;
                                            end
                                            [in,bnd] = inpolygon(netsections(rn(length(rn)),2),netsections(rn(length(rn)),3),bbox(:,1),bbox(:,2));
                                            if segment(length(rn)+1,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                                segment(length(rn)+1,3)=in;
                                            end
                                        end
                                        [in,bnd] = inpolygon(netsections(rn(o),2), netsections(rn(o),3),bbox(:,1),bbox(:,2));
                                        if o<length(rn)
                                            pdegrees=line_angle([netsections(rn(o),2),netsections(rn(o),3)],[netsections(rn(o+1),2),netsections(rn(o+1),3)]);
                                        elseif length(rn)==1
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[netsections(rn(1),2),netsections(rn(1),3)]);
                                        end
                                        if segment(o+1,3)~=1 && (abs(ndegrees-pdegrees)<60||abs(ndegrees-pdegrees)>300 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(o+1,3)=in;
                                        end
                                    end
                                else
                                    [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                    [in,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                    pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                    
                                    if (d(1)<=20||d(2)<=20)&&(abs(ndegrees-pdegrees)<=25||abs(ndegrees-pdegrees)>=345||abs(ndegrees-pdegrees)>=165&&abs(ndegrees-pdegrees)<=195)
                                        if d(1)~=0&&d(2)~=0
                                            if d(1)<=20&&d(2)<=20&&in1==1&&in2==1
                                                segment(1,3)=1;
                                                segment(2,3)=1;
                                            elseif d(1)<=20&&d(2)<=20&&(in1==1||in1==0)&&(in2==1||in1==0)
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            else
                                                if d(1)<=20
                                                    memcntr=rc1;
                                                    segment(1,3)=1;
                                                end
                                                if d(2)<=20
                                                    memcntr=rc2;
                                                    segment(2,3)=1;
                                                end
                                            end
                                        else
                                            if centre_pts(rc1,3)~=centre_pts(c1,3)&&centre_pts(rc1,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                            if centre_pts(rc2,3)~=centre_pts(c1,3)&&centre_pts(rc2,3)~=centre_pts(c2,3)
                                                
                                                if in1==1
                                                    validids=vertcat(validids,[rc1 cluster_to_tr(rc(n),4)]);
                                                elseif in2==1
                                                    validids=vertcat(validids,[rc2 cluster_to_tr(rc(n),4)]);
                                                end
                                                segment(1,3)=in1;
                                                segment(2,3)=in2;
                                            end
                                        end
                                    else
                                        in1=0;
                                        in2=0;
                                        if segment(1,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(1,3)=in;
                                            
                                        else
                                            in1=in;
                                        end
                                        [in,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                        
                                        if segment(2,3)~=1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240) && (d(1)<=100&&d(2)<=100)
                                            segment(2,3)=in;
                                            
                                        else
                                            in2=in;
                                        end
                                        
                                        if in1==1&& in2==1 && (abs(ndegrees-pdegrees)<=80||abs(ndegrees-pdegrees)>=280 || abs(ndegrees-pdegrees)>135 && abs(ndegrees-pdegrees)<240)
                                            segment(1,3)=1;
                                            segment(2,3)=1;
                                        end
                                    end
                                end
                            else
                                disp('mpikes')
                            end
                            
                            nrs=find(segment(:,3)==1);
                            if ~isempty(rn) && ~isempty(nrs)
                                if (length(nrs)/length(segment(:,1)))~=1
                                    if length(nrs)==1 && (centre_pts(rc1,3)==centre_pts(c1,3)||centre_pts(rc1,3)==centre_pts(c2,3)||centre_pts(rc2,3)==centre_pts(c1,3)||centre_pts(rc2,3)==centre_pts(c2,3))
                                    else
                                        if segment(1,3)==0&&segment(length(segment(:,1)),3)==0
                                            g=2;
                                            while g<=(length(segment(:,1))-1)
                                                if segment(g,3)==1
                                                    intermediate=vertcat(intermediate,[segment(g,1) segment(g,2) riw]);
                                                end
                                                g=g+1;
                                            end
                                        elseif segment(1,3)==0||segment(length(segment(:,1)),3)==0
                                            if segment(1,3)==1
                                                validids=vertcat(validids, [rc1 cluster_to_tr(rc(n),4)]);
                                            elseif segment(length(segment(:,1)),3)==1
                                                validids=vertcat(validids, [rc2 cluster_to_tr(rc(n),4)]);
                                            end
                                            
                                            g=2;
                                            while g<=(length(segment(:,1))-1)
                                                if segment(g,3)==1
                                                    intermediate=vertcat(intermediate,[segment(g,1) segment(g,2) riw]);
                                                end
                                                g=g+1;
                                            end
                                            
                                            
                                            if length(nrs)>1
                                                % fix new segment
                                                if segment(1,3)==0
                                                    new=[];
                                                    g=2;
                                                    new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                    g=g+1;
                                                    while segment(g,3)~=1 && g<=length(segment(:,1))
                                                        new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                        g=g+1;
                                                    end
                                                    
                                                    memcen=[segment(g,1) segment(g,2)];
                                                    pdegrees=line_angle([new(length(new(:,1)),1), new(length(new(:,1)),2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                                    
                                                    
                                                    if centre_pts(rc1,1)~=new(length(new(:,1)),1)&&centre_pts(rc1,2)~=new(length(new(:,1)),2)
                                                        rcen=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                        rcenm=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                        if ~isempty(rcen)%centre1_exists
                                                            rl=find(cluster_to_tr(:,1)==centre_pts(rc1,3) & cluster_to_tr(:,2)==centre_pts(rcen,3));
                                                            if isempty(rl)
                                                                if centre_pts(rc1,3)~=centre_pts(rcen,3)
                                                                    maxcl=(max(netnodes(:,1))+1);
                                                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),centre_pts(rcen,3), maxcl, round((centre_pts(rc1,9)+centre_pts(rcen,9))/2), round((centre_pts(rc1,8)+centre_pts(rcen,8))/2), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(rcen,1) centre_pts(rcen,2)], 2)]);
                                                                    wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                    netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    if length(new(:,1))>1
                                                                        g=1;
                                                                        while g<length(new(:,1))
                                                                            netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                            g=g+1;
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                            
                                                            if ~isempty(rcenm)%centre2_exists
                                                                rl2=find(cluster_to_tr(:,1)==centre_pts(rcen,3) & cluster_to_tr(:,2)==centre_pts(rcenm,3));
                                                                if isempty(rl2)
                                                                    if centre_pts(rcen,3)~=centre_pts(rcenm,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcen,3),centre_pts(rcenm,3), maxcl, round((centre_pts(rcen,9)+centre_pts(rcenm,9))/2), round((centre_pts(rcen,8)+centre_pts(rcenm,8))/2), distancePoints([centre_pts(rcen,1) centre_pts(rcen,2)], [centre_pts(rcenm,1) centre_pts(rcenm,2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                end
                                                            else
                                                                x1=memcen(1,1)+10;
                                                                y1=memcen(1,2)+10;
                                                                x2=memcen(1,1)+10;
                                                                y2=memcen(1,2)-10;
                                                                x3=memcen(1,1)-10;
                                                                y3=memcen(1,2)+10;
                                                                x4=memcen(1,1)-10;
                                                                y4=memcen(1,2)-10;
                                                                
                                                                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                inidx=find(in~=0);
                                                                mflag=0;
                                                                if ~isempty(inidx)
                                                                    if length(inidx)>1
                                                                        Pd=[memcen(1,1) memcen(1,2)];
                                                                        Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                        Y = pdist(Pd,'euclid');
                                                                        SQ=squareform(Y);
                                                                        minid=find(SQ(1,:)>0);
                                                                        mindist=min(SQ(minid));
                                                                        rm=find(SQ(1,:)==mindist);
                                                                        if length(rm)>1% two with the same distance
                                                                            maxc=centre_pts(inidx(rm(1)-1),3);
                                                                        else
                                                                            maxc=centre_pts(inidx(rm-1),3);
                                                                        end
                                                                    else
                                                                        maxc=centre_pts(inidx,3);
                                                                    end
                                                                    mflag=1;
                                                                else
                                                                    rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                    if isempty(rxc)
                                                                        maxc=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    end
                                                                end
                                                                
                                                                rl2=find(cluster_to_tr(:,1)==centre_pts(rcen,3) & cluster_to_tr(:,2)==maxc);
                                                                if isempty(rl2)
                                                                    if centre_pts(rcen,3)~=maxc
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcen,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rcen,1) centre_pts(rcen,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                    
                                                                end
                                                                
                                                            end
                                                            
                                                        else%centre_1_not_exists
                                                            x1=new(length(new(:,1)),1)+10;
                                                            y1=new(length(new(:,1)),2)+10;
                                                            x2=new(length(new(:,1)),1)+10;
                                                            y2=new(length(new(:,1)),2)-10;
                                                            x3=new(length(new(:,1)),1)-10;
                                                            y3=new(length(new(:,1)),2)+10;
                                                            x4=new(length(new(:,1)),1)-10;
                                                            y4=new(length(new(:,1)),2)-10;
                                                            
                                                            node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                            in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                            inidx=find(in~=0);
                                                            mflag=0;
                                                            if ~isempty(inidx)
                                                                if length(inidx)>1
                                                                    Pd=[new(length(new(:,1)),1), new(length(new(:,1)),2)];
                                                                    Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                    Y = pdist(Pd,'euclid');
                                                                    SQ=squareform(Y);
                                                                    minid=find(SQ(1,:)>0);
                                                                    mindist=min(SQ(minid));
                                                                    rm=find(SQ(1,:)==mindist);
                                                                    if length(rm)>1% two with the same distance
                                                                        maxc=centre_pts(inidx(rm(1)-1),3);
                                                                    else
                                                                        maxc=centre_pts(inidx(rm-1),3);
                                                                    end
                                                                else
                                                                    maxc=centre_pts(inidx,3);
                                                                end
                                                                mflag=1;
                                                            else
                                                                rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                if isempty(rxc)
                                                                    maxc=(max(centre_pts(:,3))+1);
                                                                    centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                end
                                                            end
                                                            
                                                            rl2=find(cluster_to_tr(:,1)==centre_pts(rc1,3) & cluster_to_tr(:,2)==maxc);
                                                            if isempty(rl2)
                                                                if centre_pts(rc1,3)~=maxc
                                                                    maxcl=(max(netnodes(:,1))+1);
                                                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                    wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                    netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    if length(new(:,1))>1
                                                                        g=1;
                                                                        while g<length(new(:,1))
                                                                            netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                            g=g+1;
                                                                        end
                                                                    end
                                                                elseif centre_pts(rc1,3)~=maxc && mflag==1 && length(new(:,1))==1
                                                                    rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                    if isempty(rxc)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        maxc=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        rcv=find(centre_pts(:,3)==maxc);
                                                                        validids=vertcat(validids, [rcv cluster_to_tr(rc(n),4)]);
                                                                    end
                                                                end
                                                            elseif ~isempty(rl2) && mflag==1 && length(new(:,1))==1
                                                                rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                if isempty(rxc)
                                                                    maxcl=(max(netnodes(:,1))+1);
                                                                    maxc=(max(centre_pts(:,3))+1);
                                                                    centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)], [centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)], 2)]);
                                                                    wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                    netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    rcv=find(centre_pts(:,3)==maxc);
                                                                    validids=vertcat(validids, [rcv cluster_to_tr(rc(n),4)]);
                                                                end
                                                            end
                                                            
                                                            if ~isempty(rcenm)%centre2_exists
                                                                rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==centre_pts(rcenm,3));
                                                                if isempty(rl2)
                                                                    if maxc~=centre_pts(rcenm,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rcenm,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)],[centre_pts(rcenm,1) centre_pts(rcenm,2)] , 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                end
                                                            else
                                                                x1=memcen(1,1)+10;
                                                                y1=memcen(1,2)+10;
                                                                x2=memcen(1,1)+10;
                                                                y2=memcen(1,2)-10;
                                                                x3=memcen(1,1)-10;
                                                                y3=memcen(1,2)+10;
                                                                x4=memcen(1,1)-10;
                                                                y4=memcen(1,2)-10;
                                                                
                                                                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                inidx=find(in~=0);
                                                                mflag=0;
                                                                if ~isempty(inidx)
                                                                    if length(inidx)>1
                                                                        Pd=[memcen(1,1) memcen(1,2)];
                                                                        Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                        Y = pdist(Pd,'euclid');
                                                                        SQ=squareform(Y);
                                                                        minid=find(SQ(1,:)>0);
                                                                        mindist=min(SQ(minid));
                                                                        rm=find(SQ(1,:)==mindist);
                                                                        if length(rm)>1% two with the same distance
                                                                            maxc2=centre_pts(inidx(rm(1)-1),3);
                                                                        else
                                                                            maxc2=centre_pts(inidx(rm-1),3);
                                                                        end
                                                                    else
                                                                        maxc2=centre_pts(inidx,3);
                                                                    end
                                                                    mflag=1;
                                                                else
                                                                    rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                    if isempty(rxc)
                                                                        maxc2=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc2 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    end
                                                                end
                                                                rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==maxc2);
                                                                if isempty(rl2)
                                                                    if maxc~=maxc2
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        rmc1=find(centre_pts(:,3)==maxc);
                                                                        rmc2=find(centre_pts(:,3)==maxc2);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[maxc,maxc2, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rmc1,1) centre_pts(rmc1,2)],[centre_pts(rmc2,1) centre_pts(rmc2,2)] , 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                    
                                                                    nrsp=find(segment(:,3)==0);
                                                                    if length(nrsp)==2 && maxc2~=rc2
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        split=vertcat(split,[maxc2, centre_pts(rc2,3), netnodes(wht,2),cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5)]);
                                                                    end
                                                                end
                                                            end
                                                        end
                                                    end
                                                    
                                                elseif segment(length(segment(:,1)),3)==0
                                                    new=[];
                                                    g=length(segment(:,1))-1;
                                                    new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                    g=g-1;
                                                    while segment(g,3)~=1 && g>0
                                                        new=vertcat(new,[segment(g,1) segment(g,2)]);
                                                        g=g-1;
                                                    end
                                                    
                                                    memcen=[segment(g,1) segment(g,2)];
                                                    pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[new(length(new(:,1)),1), new(length(new(:,1)),2)]);
                                                    
                                                    if centre_pts(rc2,1)~=new(length(new(:,1)),1)&&centre_pts(rc2,2)~=new(length(new(:,1)),2)
                                                        rcen=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                        rcenm=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                        if ~isempty(rcen)%centre_exists
                                                            rl=find(cluster_to_tr(:,2)==centre_pts(rc2,3) & cluster_to_tr(:,1)==centre_pts(rcen,3));
                                                            if isempty(rl)
                                                                if centre_pts(rcen,3)~=centre_pts(rc2,3)
                                                                    maxcl=(max(netnodes(:,1))+1);
                                                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcen,3),centre_pts(rc2,3), maxcl, round((centre_pts(rcen,9)+centre_pts(rc2,9))/2), round((centre_pts(rcen,8)+centre_pts(rc2,8))/2), distancePoints([centre_pts(rcen,1) centre_pts(rcen,2)],[centre_pts(rc2,1) centre_pts(rc2,2)] , 2)]);
                                                                    wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                    netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    if length(new(:,1))>1
                                                                        g=length(new(:,1))-1;
                                                                        while g>0
                                                                            netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                            g=g-1;
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                            
                                                            if ~isempty(rcenm)%centre2_exists
                                                                rl2=find(cluster_to_tr(:,1)==centre_pts(rcenm,3) & cluster_to_tr(:,2)==centre_pts(rcen,3));
                                                                if isempty(rl2)
                                                                    if centre_pts(rcenm,3)~=centre_pts(rcen,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcenm,3),centre_pts(rcen,3), maxcl, round((centre_pts(rcenm,9)+centre_pts(rcen,9))/2), round((centre_pts(rcenm,8)+centre_pts(rcen,8))/2), distancePoints([centre_pts(rcenm,1) centre_pts(rcenm,2)],[centre_pts(rcen,1) centre_pts(rcen,2)] , 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                end
                                                            else
                                                                x1=memcen(1,1)+10;
                                                                y1=memcen(1,2)+10;
                                                                x2=memcen(1,1)+10;
                                                                y2=memcen(1,2)-10;
                                                                x3=memcen(1,1)-10;
                                                                y3=memcen(1,2)+10;
                                                                x4=memcen(1,1)-10;
                                                                y4=memcen(1,2)-10;
                                                                
                                                                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                inidx=find(in~=0);
                                                                if ~isempty(inidx)
                                                                    if length(inidx)>1
                                                                        Pd=[memcen(1,1) memcen(1,2)];
                                                                        Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                        Y = pdist(Pd,'euclid');
                                                                        SQ=squareform(Y);
                                                                        minid=find(SQ(1,:)>0);
                                                                        mindist=min(SQ(minid));
                                                                        rm=find(SQ(1,:)==mindist);
                                                                        if length(rm)>1% two with the same distance
                                                                            maxc=centre_pts(inidx(rm(1)-1),3);
                                                                        else
                                                                            maxc=centre_pts(inidx(rm-1),3);
                                                                        end
                                                                    else
                                                                        maxc=centre_pts(inidx,3);
                                                                    end
                                                                else
                                                                    rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                    if isempty(rxc)
                                                                        maxc=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    end
                                                                end
                                                                rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==centre_pts(rcen,3));
                                                                if isempty(rl2)
                                                                    if maxc~=centre_pts(rcen,3)
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rcen,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)],[centre_pts(rcen,1) centre_pts(rcen,2)] , 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                end
                                                                
                                                            end
                                                        else
                                                            x1=new(length(new(:,1)),1)+10;
                                                            y1=new(length(new(:,1)),2)+10;
                                                            x2=new(length(new(:,1)),1)+10;
                                                            y2=new(length(new(:,1)),2)-10;
                                                            x3=new(length(new(:,1)),1)-10;
                                                            y3=new(length(new(:,1)),2)+10;
                                                            x4=new(length(new(:,1)),1)-10;
                                                            y4=new(length(new(:,1)),2)-10;
                                                            cflag=0;
                                                            
                                                            node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                            in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                            inidx=find(in~=0);
                                                            if ~isempty(inidx)
                                                                if length(inidx)>1
                                                                    Pd=[new(length(new(:,1)),1), new(length(new(:,1)),2)];
                                                                    Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                    Y = pdist(Pd,'euclid');
                                                                    SQ=squareform(Y);
                                                                    minid=find(SQ(1,:)>0);
                                                                    mindist=min(SQ(minid));
                                                                    rm=find(SQ(1,:)==mindist);
                                                                    if length(rm)>1% two with the same distance
                                                                        maxc=centre_pts(inidx(rm(1)-1),3);
                                                                    else
                                                                        maxc=centre_pts(inidx(rm-1),3);
                                                                    end
                                                                    cflag=1;
                                                                else
                                                                    maxc=centre_pts(inidx,3);
                                                                    cflag=1;
                                                                end
                                                            else
                                                                rxc=find(centre_pts(:,1)==new(length(new(:,1)),1)&centre_pts(:,2)==new(length(new(:,1)),2));
                                                                if isempty(rxc)
                                                                    maxc=(max(centre_pts(:,3))+1);
                                                                    centre_pts=vertcat(centre_pts,[new(length(new(:,1)),1) new(length(new(:,1)),2) maxc 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                end
                                                            end
                                                            rl2=find(cluster_to_tr(:,1)==maxc & cluster_to_tr(:,2)==centre_pts(rc2,3));
                                                            if isempty(rl2)
                                                                if maxc~=centre_pts(rc2,3)
                                                                    maxcl=(max(netnodes(:,1))+1);
                                                                    cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rc2,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)],[centre_pts(rc2,1) centre_pts(rc2,2)] , 2)]);
                                                                    wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                    netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    if length(new(:,1))>1
                                                                        g=length(new(:,1))-1;
                                                                        while g>0
                                                                            netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                            g=g-1;
                                                                        end
                                                                    end
                                                                end
                                                            elseif ~isempty(rl2)&&cflag==1 %near to the first node
                                                                if maxc~=centre_pts(rc2,3)
                                                                    maxcl=(max(netnodes(:,1))+1);
                                                                    cluster_to_tr=vertcat(cluster_to_tr,[maxc,centre_pts(rc2,3), maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)],[centre_pts(rc2,1) centre_pts(rc2,2)] , 2)]);
                                                                    wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                    netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    if length(new(:,1))>1
                                                                        g=length(new(:,1))-1;
                                                                        while g>0
                                                                            netsections=vertcat(netsections,[maxcl new(g,1) new(g,2) 0 0]);
                                                                            g=g-1;
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                            if ~isempty(rcenm)%centre2_exists
                                                                rl2=find(cluster_to_tr(:,1)==centre_pts(rcenm(1),3) & cluster_to_tr(:,2)==maxc);
                                                                if isempty(rl2)
                                                                    if centre_pts(rcenm(1),3)~=maxc
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rcenm,3),maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rcenm,1) centre_pts(rcenm,2)],[centre_pts(length(centre_pts(:,1)),1) centre_pts(length(centre_pts(:,1)),2)] , 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                    end
                                                                end
                                                            else
                                                                x1=memcen(1,1)+10;
                                                                y1=memcen(1,2)+10;
                                                                x2=memcen(1,1)+10;
                                                                y2=memcen(1,2)-10;
                                                                x3=memcen(1,1)-10;
                                                                y3=memcen(1,2)+10;
                                                                x4=memcen(1,1)-10;
                                                                y4=memcen(1,2)-10;
                                                                
                                                                node=[x1 y1;x2 y2;x4 y4;x3 y3;x1 y1];
                                                                in = inpolygon(centre_pts(:,1), centre_pts(:,2),node(:,1),node(:,2));
                                                                inidx=find(in~=0);
                                                                cflag=0;
                                                                if ~isempty(inidx)
                                                                    if length(inidx)>1
                                                                        Pd=[memcen(1,1) memcen(1,2)];
                                                                        Pd=vertcat(Pd,[centre_pts(inidx,1) centre_pts(inidx,2)]);
                                                                        Y = pdist(Pd,'euclid');
                                                                        SQ=squareform(Y);
                                                                        minid=find(SQ(1,:)>0);
                                                                        mindist=min(SQ(minid));
                                                                        rm=find(SQ(1,:)==mindist);
                                                                        if length(rm)>1% two with the same distance
                                                                            maxc2=centre_pts(inidx(rm(1)-1),3);
                                                                        else
                                                                            maxc2=centre_pts(inidx(rm-1),3);
                                                                        end
                                                                        cflag=1;
                                                                    else
                                                                        maxc2=centre_pts(inidx,3);
                                                                        cflag=1;
                                                                    end
                                                                else
                                                                    rxc=find(centre_pts(:,1)==memcen(1,1)&centre_pts(:,2)==memcen(1,2));
                                                                    if isempty(rxc)
                                                                        maxc2=(max(centre_pts(:,3))+1);
                                                                        centre_pts=vertcat(centre_pts,[memcen(1,1) memcen(1,2) maxc2 0 0 round((centre_pts(c1,6)+centre_pts(c2,6))/2) round((centre_pts(c1,7)+centre_pts(c2,7))/2) (centre_pts(c1,8)+centre_pts(c2,8))/2 round((centre_pts(c1,9)+centre_pts(c2,9))/2)]);
                                                                    end
                                                                end
                                                                rl2=find(cluster_to_tr(:,1)==maxc2 & cluster_to_tr(:,2)==maxc);
                                                                if isempty(rl2)
                                                                    if maxc2~=maxc
                                                                        maxcl=(max(netnodes(:,1))+1);
                                                                        rmc1=find(centre_pts(:,3)==maxc2);
                                                                        rmc2=find(centre_pts(:,3)==maxc);
                                                                        cluster_to_tr=vertcat(cluster_to_tr,[maxc2,maxc, maxcl, cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5), distancePoints([centre_pts(rmc1,1) centre_pts(rmc1,2)],[centre_pts(rmc2,1) centre_pts(rmc2,2)] , 2)]);
                                                                        wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                        netnodes=vertcat(netnodes,[maxcl,netnodes(wht,2),0,1,1,0,0,0]);
                                                                        
                                                                        nrsp=find(segment(:,3)==0);
                                                                        if length(nrsp)==2 && maxc2~=rc1
                                                                            wht=find(netnodes(:,1)==cluster_to_tr(rc(n),3));
                                                                            split=vertcat(split,[centre_pts(rc1,3), maxc2, netnodes(wht,2),cluster_to_tr(rc(n),4), cluster_to_tr(rc(n),5)]);
                                                                        end
                                                                    end
                                                                end
                                                            end
                                                        end
                                                    end
                                                end
                                                ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                                if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                    segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),2]);
                                                else
                                                    segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),1]);
                                                end
                                                
                                            end
                                        else
                                            validids=vertcat(validids, [rc1 cluster_to_tr(rc(n),4)]);
                                            validids=vertcat(validids, [rc2 cluster_to_tr(rc(n),4)]);
                                            
                                            g=2;
                                            while g<=(length(segment(:,1))-1)
                                                if segment(g,3)==1
                                                    intermediate=vertcat(intermediate,[segment(g,1) segment(g,2) riw]);
                                                end
                                                g=g+1;
                                            end
                                            rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                            rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                            ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),2]);
                                            else
                                                segscl=vertcat(segscl, [cluster_to_tr(rc(n),3),1]);
                                            end
                                        end
                                    end
                                else
                                    rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                    rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                    ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                    pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                    if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                        nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                    else
                                        nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                    end
                                end
                            elseif isempty(rn)&&(length(nrs)/length(segment(:,1)))>=0.5
                                if length(nrs)/length(segment(:,1))>0.5
                                    
                                    cnode=[];
                                    cnode=vertcat(cnode,cluster_to_tr(rc(n),1));
                                    cnode=vertcat(cnode,cluster_to_tr(rc(n),2));
                                    rcn=find(cnode(:)~=centre_pts(c1,3)&cnode(:)~=centre_pts(c2,3));
                                    if length(rcn)==1
                                        rl=find(cluster_to_tr(:,1)==cnode(rcn)|cluster_to_tr(:,2)==cnode(rcn));
                                        anodes=[];
                                        for g=1:length(rl)
                                            anodes=vertcat(anodes,cluster_to_tr(rl(g),1));
                                            anodes=vertcat(anodes,cluster_to_tr(rl(g),2));
                                        end
                                        anodes=unique(anodes,'rows');
                                        rl1=find(anodes(:)==centre_pts(c1,3));
                                        rl2=find(anodes(:)==centre_pts(c2,3));
                                        if ~isempty(rl1)&&~isempty(rl2)
                                            rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                            rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                            ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            rt=find(cluster_to_tr(:,1)==cnode(rcn)&cluster_to_tr(:,2)==centre_pts(c1,3)|cluster_to_tr(:,1)==centre_pts(c1,3)&cluster_to_tr(:,2)==cnode(rcn));
                                            if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                
                                                maxr=max([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                medr=median([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                minr=min([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                if cluster_to_tr(sres,4)==minr
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                                    tcase=vertcat(tcase,[cluster_to_tr(sres,3),cluster_to_tr(sres,4), cluster_to_tr(sres,6), cluster_to_tr(rc(n),3),cluster_to_tr(rc(n),4),cluster_to_tr(rc(n),6),cluster_to_tr(rt(1),3),cluster_to_tr(rt(1),4),cluster_to_tr(rt(1),6),1]);
                                                    ccase=vertcat(ccase,[cluster_to_tr(sres,1) cluster_to_tr(sres,2) cluster_to_tr(rc(n),1) cluster_to_tr(rc(n),2) cluster_to_tr(rt(1),1) cluster_to_tr(rt(1),2)]);
                                                end
                                            else
                                                
                                                maxr=max([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                medr=median([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                minr=min([cluster_to_tr(sres,4) cluster_to_tr(rc(n),4) cluster_to_tr(rt(1),4)]);
                                                if cluster_to_tr(sres,4)==minr
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                                    tcase=vertcat(tcase,[cluster_to_tr(sres,3),cluster_to_tr(sres,4), cluster_to_tr(sres,6), cluster_to_tr(rc(n),3),cluster_to_tr(rc(n),4),cluster_to_tr(rc(n),6),cluster_to_tr(rt(1),3),cluster_to_tr(rt(1),4),cluster_to_tr(rt(1),6),1]);
                                                    ccase=vertcat(ccase,[cluster_to_tr(sres,1) cluster_to_tr(sres,2) cluster_to_tr(rc(n),1) cluster_to_tr(rc(n),2) cluster_to_tr(rt(1),1) cluster_to_tr(rt(1),2)]);
                                                end
                                            end
                                        elseif isempty(rl1)&&~isempty(rl2)||~isempty(rl1)&&isempty(rl2)
                                            rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                            rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                            ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                            pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                            segment(:,3)=0;
                                            rd=find(d==max(d));
                                            
                                            if ~isempty(rd)&d(rd)<=80
                                                x1=centre_pts(c1,1)+(d(rd))*cosd(ndegrees-90);
                                                y1=centre_pts(c1,2)+(d(rd))*sind(ndegrees-90);
                                                x3=centre_pts(c2,1)+(d(rd))*cosd(ndegrees-90);
                                                y3=centre_pts(c2,2)+(d(rd))*sind(ndegrees-90);
                                            else
                                                x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                                y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                                x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                                y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            end
                                            
                                            x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                            y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                            x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                            y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            
                                            [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                            [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                            if in1==1 && in2==1 && ((abs(ndegrees-pdegrees)<=50||abs(ndegrees-pdegrees)>=315)||abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225)
                                                if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                                else
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                                end
                                            end
                                            
                                            segment(:,3)=0;
                                            if ~isempty(rd)&d(rd)<=80
                                                x2=centre_pts(c1,1)+(d(rd))*cosd(ndegrees+90);
                                                y2=centre_pts(c1,2)+(d(rd))*sind(ndegrees+90);
                                                x4=centre_pts(c2,1)+(d(rd))*cosd(ndegrees+90);
                                                y4=centre_pts(c2,2)+(d(rd))*sind(ndegrees+90);
                                            else
                                                x2=centre_pts(c1,1)+(dy)*cosd(ndegrees+90);
                                                y2=centre_pts(c1,2)+(dy)*sind(ndegrees+90);
                                                x4=centre_pts(c2,1)+(dy)*cosd(ndegrees+90);
                                                y4=centre_pts(c2,2)+(dy)*sind(ndegrees+90);
                                            end
                                            
                                            x1=centre_pts(c1,1)+(dy)*cosd(ndegrees-90);
                                            y1=centre_pts(c1,2)+(dy)*sind(ndegrees-90);
                                            x3=centre_pts(c2,1)+(dy)*cosd(ndegrees-90);
                                            y3=centre_pts(c2,2)+(dy)*sind(ndegrees-90);
                                            
                                            node=[x1 y1;x3 y3;x4 y4;x2 y2;x1 y1];
                                            bbox=[node(:,1) node(:,2)];
                                            
                                            [in1,bnd] = inpolygon(centre_pts(rc1,1), centre_pts(rc1,2),bbox(:,1),bbox(:,2));
                                            [in2,bnd] = inpolygon(centre_pts(rc2,1), centre_pts(rc2,2),bbox(:,1),bbox(:,2));
                                            if in1==1 && in2==1 && ((abs(ndegrees-pdegrees)<=50||abs(ndegrees-pdegrees)>=315)||abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225)
                                                if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                                else
                                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                                end
                                            end
                                        end
                                    elseif length(rcn)==2
                                        rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                        rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                        ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                        pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                        if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                            nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                        else
                                            nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                        end
                                    end
                                elseif memcntr~=0
                                    validids=vertcat(validids, [memcntr cluster_to_tr(rc(n),4)]);
                                end
                            elseif isempty(rn)&&(length(nrs)/length(segment(:,1)))>0.5
                                if segment(1,3)==0
                                    dx1=sqrt((centre_pts(c1,1)-centre_pts(rc1,1))^2+(centre_pts(c1,2)-centre_pts(rc1,2))^2);
                                    dx2=sqrt((centre_pts(c2,1)-centre_pts(rc1,1))^2+(centre_pts(c2,2)-centre_pts(rc1,2))^2);
                                    if dx1<dx2
                                        rl=find(cluster_to_tr(:,1)==centre_pts(c1,3)&cluster_to_tr(:,2)==centre_pts(rc1,3)|cluster_to_tr(:,1)==centre_pts(rc1,3)&cluster_to_tr(:,2)==centre_pts(c1,3));
                                        if isempty(rl)
                                            maxcl=(max(netnodes(:,1))+1);
                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),centre_pts(c1,3), maxcl, round((centre_pts(rc1,9)+centre_pts(c1,9))/2), round((centre_pts(rc1,8)+centre_pts(c1,8))/2), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)],[centre_pts(c1,1) centre_pts(c1,2)] , 2)]);
                                            netnodes=vertcat(netnodes,[maxcl,0,0,1,1,0,0,0]);
                                        end
                                    elseif dx2<dx1
                                        rl=find(cluster_to_tr(:,1)==centre_pts(c2,3)&cluster_to_tr(:,2)==centre_pts(rc1,3)|cluster_to_tr(:,1)==centre_pts(rc1,3)&cluster_to_tr(:,2)==centre_pts(c2,3));
                                        if isempty(rl)
                                            maxcl=(max(netnodes(:,1))+1);
                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),centre_pts(c2,3), maxcl, round((centre_pts(rc1,9)+centre_pts(c2,9))/2), round((centre_pts(rc1,8)+centre_pts(c2,8))/2), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)],[centre_pts(c2,1) centre_pts(c2,2)] , 2)]);
                                            netnodes=vertcat(netnodes,[maxcl,0,0,1,1,0,0,0]);
                                        end
                                    end
                                elseif segment(1,3)==1
                                    validids=vertcat(validids, [rc1 cluster_to_tr(rc(n),4)]);
                                end
                                
                                if segment(2,3)==0
                                    dx1=sqrt((centre_pts(c1,1)-centre_pts(rc2,1))^2+(centre_pts(c1,2)-centre_pts(rc2,2))^2);
                                    dx2=sqrt((centre_pts(c2,1)-centre_pts(rc2,1))^2+(centre_pts(c2,2)-centre_pts(rc2,2))^2);
                                    if dx1<dx2
                                        rl=find(cluster_to_tr(:,1)==centre_pts(c1,3)&cluster_to_tr(:,2)==centre_pts(rc2,3)|cluster_to_tr(:,1)==centre_pts(rc2,3)&cluster_to_tr(:,2)==centre_pts(c1,3));
                                        if isempty(rl)
                                            maxcl=(max(netnodes(:,1))+1);
                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c1,3),centre_pts(rc2,3), maxcl, round((centre_pts(c1,9)+centre_pts(rc2,9))/2), round((centre_pts(c1,8)+centre_pts(rc2,8))/2), distancePoints([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(rc2,1) centre_pts(rc2,2)] , 2)]);
                                            netnodes=vertcat(netnodes,[maxcl,0,0,1,1,0,0,0]);
                                        end
                                    elseif dx2<dx1
                                        rl=find(cluster_to_tr(:,1)==centre_pts(c2,3)&cluster_to_tr(:,2)==centre_pts(rc2,3)|cluster_to_tr(:,1)==centre_pts(rc2,3)&cluster_to_tr(:,2)==centre_pts(c2,3));
                                        if isempty(rl)
                                            maxcl=(max(netnodes(:,1))+1);
                                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c2,3),centre_pts(rc2,3), maxcl, round((centre_pts(c2,9)+centre_pts(rc2,9))/2), round((centre_pts(c2,8)+centre_pts(rc2,8))/2), distancePoints([centre_pts(c2,1) centre_pts(c2,2)],[centre_pts(rc2,1) centre_pts(rc2,2)] , 2)]);
                                            netnodes=vertcat(netnodes,[maxcl,0,0,1,1,0,0,0]);
                                        end
                                    end
                                    
                                elseif segment(2,3)==1
                                    validids=vertcat(validids, [rc2 cluster_to_tr(rc(n),4)]);
                                end
                                
                                rc1=find(centre_pts(:,3)==cluster_to_tr(rc(n),1));
                                rc2=find(centre_pts(:,3)==cluster_to_tr(rc(n),2));
                                ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                                pdegrees=line_angle([centre_pts(rc1,1), centre_pts(rc1,2)],[centre_pts(rc2,1), centre_pts(rc2,2)]);
                                if abs(ndegrees-pdegrees)>=135&&abs(ndegrees-pdegrees)<=225
                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),2]);
                                else
                                    nsegs=vertcat(nsegs, [cluster_to_tr(rc(n),3),1]);
                                end
                            end
                        end
                    end
                end
            end
            if ~isempty(intermediate)
                sss=sss+length(intermediate(:,1));
            end
            cm=find(c4(:)~=centre_pts(c1,3)&c4(:)~=centre_pts(c2,3));
            if ~isempty(cm) && scounter>=1
                for g=1:length(cm)
                    if ~isempty(validids)
                        rv=find(centre_pts(validids(:,1),3)==c4(cm(g)));
                        if isempty(rv)%compute vert dist
                            slope=(centre_pts(c2,2)-centre_pts(c1,2))/(centre_pts(c2,1)-centre_pts(c1,1));
                            b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                            rcen=find(centre_pts(:,3)==c4(cm(g)));
                            d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                            
                            if d<=gdy
                                validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                            end
                        end
                    else
                        slope=(centre_pts(c2,2)-centre_pts(c1,2))/(centre_pts(c2,1)-centre_pts(c1,1));
                        b=centre_pts(c1,2) - slope*centre_pts(c1,1);
                        rcen=find(centre_pts(:,3)==c4(cm(g)));
                        d=abs(slope*centre_pts(rcen,1) + (-1)*centre_pts(rcen,2) + b)/sqrt(slope^2+(-1)^2);
                        
                        if d<=gdy
                            validids=vertcat(validids,[rcen centre_pts(rcen,6)]);
                        end
                        
                    end
                    
                end
            end
            
            if ~isempty(nsegs)
                [nnsegs nids]=unique(nsegs(:,1),'rows');
                nsegs=nsegs(nids,:);
            end
            
            if ~isempty(segscl)
                [ssegscl sids]=unique(segscl(:,1),'rows');
                segscl=segscl(sids,:);
            end
            
            validids=unique(validids,'rows');
            
            nodes=[];
            if ~isempty(validids)
                for l=1:length(validids(:,1))
                    nodes=vertcat(nodes,validids(l,1));
                end
            end
            
            if ~isempty(nsegs)
                for l=1:length(nsegs(:,1))
                    m=find(cluster_to_tr(:,3)==nsegs(l,1));
                    if ~isempty(m)
                        r=find(centre_pts(:,3)==cluster_to_tr(m,1));
                        nodes=vertcat(nodes,r);
                        r=find(centre_pts(:,3)==cluster_to_tr(m,2));
                        nodes=vertcat(nodes,r);
                    end
                end
            end
            
            nodes=unique(nodes,'rows');
            tokeep=[];
            if ~isempty(nsegs)
                for l=1:length(nsegs(:,1))
                    m=find(cluster_to_tr(:,3)==nsegs(l,1));
                    if ~isempty(m)
                        if ~isempty(nodes)
                            r1=find(centre_pts(nodes,3)==cluster_to_tr(m,1));
                            r2=find(centre_pts(nodes,3)==cluster_to_tr(m,2));
                            if ~isempty(r1)&&~isempty(r2)
                                tokeep=vertcat(tokeep,l);
                            end
                        end
                    end
                end
            end
            
            if ~isempty(tokeep)
                nsegs=nsegs(tokeep,:);
            end
            
            idnx=[];
            for l=1:length(nodes)
                if centre_pts(c1,3)~=centre_pts(nodes(l),3) && centre_pts(c2,3)~=centre_pts(nodes(l),3)
                    idnx=vertcat(idnx,l);
                end
            end
            nodes=nodes(idnx);
            
            [dsr d] = dsearchn([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(nodes,1) centre_pts(nodes,2)]);
            pts=(d<=200);
            nearest=nodes(pts,:);
            idxp=[];
            prvfl=[];
            for j=1:length(nearest)
                ndegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(c2,1), centre_pts(c2,2)]);
                pdegrees=line_angle([centre_pts(c1,1), centre_pts(c1,2)],[centre_pts(nearest(j),1), centre_pts(nearest(j),2)]);
            end
            
            if ~isempty(prvfl)
                prid=find(prvfl~=0);
                prvfl=prvfl(prid);
            end
            if ~isempty(idxp)
                for m=1:length(idxp)
                    rs=find(nodes(:)==nearest(idxp(m)));
                    if ~isempty(rs)
                        nodes(rs,:)=[];
                    end
                end
            end
            
            
            [dsr d] = dsearchn([centre_pts(c2,1) centre_pts(c2,2)],[centre_pts(nodes,1) centre_pts(nodes,2)]);
            pts=(d<=200);
            nearest=nodes(pts,:);
            idxp=[];
            nxtfl=[];
            for j=1:length(nearest)
                ndegrees=line_angle([centre_pts(c2,1), centre_pts(c2,2)],[centre_pts(c1,1), centre_pts(c1,2)]);
                pdegrees=line_angle([centre_pts(c2,1), centre_pts(c2,2)],[centre_pts(nearest(j),1), centre_pts(nearest(j),2)]);
            end
            if ~isempty(nxtfl)
                nxid=find(nxtfl~=0);
                nxtfl=nxtfl(nxid);
            end
            if ~isempty(idxp)
                for m=1:length(idxp)
                    rs=find(nodes(:)==nearest(idxp(m)));
                    if ~isempty(rs)
                        nodes(rs,:)=[];
                    end
                end
            end
            
            vn=[];
            if ~isempty(nodes)
                lline=createLine([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]);
                for h=1:length(nodes(:,1))
                    if ~isempty(validids)
                        rn=find(validids(:,1)==nodes(h));
                        rnx=find(validids(rn,2)==max(validids(rn,2)));
                        if ~isempty(rnx) && validids(rn(rnx),2)<cluster_to_tr(sres,4)
                            ppj=projPointOnLine([centre_pts(nodes(h),1) centre_pts(nodes(h),2)],lline);
                            if distancePoints([centre_pts(nodes(h),1) centre_pts(nodes(h),2)],[ppj(1,1) ppj(1,2)],2)<=dd
                                centre_pts(nodes(h),1)=(centre_pts(nodes(h),6)*centre_pts(nodes(h),1)+ppj(1,1))/(centre_pts(nodes(h),6)+1);
                                centre_pts(nodes(h),2)=(centre_pts(nodes(h),6)*centre_pts(nodes(h),2)+ppj(1,2))/(centre_pts(nodes(h),6)+1);
                                
                            end
                        end
                    else
                        if centre_pts(nodes(h),6)<cluster_to_tr(sres,4)
                            ppj=projPointOnLine([centre_pts(nodes(h),1) centre_pts(nodes(h),2)],lline);
                            if distancePoints([centre_pts(nodes(h),1) centre_pts(nodes(h),2)],[ppj(1,1) ppj(1,2)],2)<=dd
                                centre_pts(nodes(h),1)=(centre_pts(nodes(h),6)*centre_pts(nodes(h),1)+ppj(1,1))/(centre_pts(nodes(h),6)+1);
                                centre_pts(nodes(h),2)=(centre_pts(nodes(h),6)*centre_pts(nodes(h),2)+ppj(1,2))/(centre_pts(nodes(h),6)+1);
                                
                            end
                        else
                            vn=vertcat(vn,h);
                        end
                    end
                end
            end
            
            if ~isempty(vn)
                nodes(vn,:)=[];
            end
            
            Cldist=[];
            Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
            Cldist=vertcat(Cldist, [centre_pts(nodes,1), centre_pts(nodes,2)]);
            Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
            Y = pdist(Cldist,'euclid');
            SQ=squareform(Y);
            cclust=zeros(length(Cldist), 1);
            
            for o=1:length(SQ(:,:))
                SQ(o,o)=100000.0;
            end
            
            %finding sequence of centres point cloud
            j=1;
            idxk=1;
            minip=100000.0;
            while idxk<=length(SQ(idxk,:)) & j<=length(Cldist(:,1))
                
                if length(idxk)>1
                    index=0;
                    for g=1:length(idxk)
                        mindist=min(SQ(idxk(g),:));
                        if mindist<=minip
                            minip=mindist;
                            index=g;
                        end
                    end
                    resi=find(SQ(idxk(index),:)==minip);
                    cclust(j)=idxk(index);
                    minip=100000.0;
                    j=j+1;
                else
                    mindist=min(SQ(idxk,:));
                    resi=find(SQ(idxk,:)==mindist);
                    cclust(j)=idxk;
                    j=j+1;
                end
                
                if length(Cldist(:,1))==idxk
                    break;
                end
                
                SQ(idxk,:)=100000;
                SQ(:,resi)=100000;
                
                if idxk==1
                    SQ(:,idxk)=100000;
                end
                
                curr=resi;
                idxk=curr;
            end
            
            
            tclusters=[];
            tid=1;
            len=length(cclust);
            cl=find(cclust(:)~=0);
            cclust=cclust(cl);
            for n=1:length(cclust)
                if cclust(n)~=1 && cclust(n)~=len
                    tclusters(tid)=cclust(n);
                    tid=tid+1;
                end
            end
            
            cclust=tclusters-1;
            Cldist=[];
            Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
            Cldist=vertcat(Cldist, [centre_pts(nodes(cclust),1) centre_pts(nodes(cclust),2)]);
            Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
            
            
            idx=[];
            for v=2:length(Cldist(:,1))-2
                mdegrees1=line_angle([Cldist(v,1), Cldist(v,2)],[Cldist(v+1,1), Cldist(v+1,2)]);
                mdegrees2=line_angle([Cldist(v,1), Cldist(v,2)],[Cldist(v+2,1), Cldist(v+2,2)]);
                
                if abs(mdegrees1-mdegrees2)>45
                    
                    r=find(cluster_to_tr(:,1)==centre_pts(nodes(cclust(v)),3)|cluster_to_tr(:,2)==centre_pts(nodes(cclust(v)),3));
                    
                end
            end
            
            if ~isempty(idx)
                cclust(idx-1)=[];
            end
            
            
            bbox2=[];
            rbbox2=[];
            if ~isempty(cclust)
                for t=1:length(cclust)
                    if t==1
                        ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[centre_pts(nodes(cclust(t)),1),centre_pts(nodes(cclust(t)),2)]);
                        x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                        y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                        x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                        y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                        x3=centre_pts(nodes(cclust(t)),1)+(gdy)*cosd(ndegrees-90);
                        y3=centre_pts(nodes(cclust(t)),2)+(gdy)*sind(ndegrees-90);
                        x4=centre_pts(nodes(cclust(t)),1)+(gdy)*cosd(ndegrees+90);
                        y4=centre_pts(nodes(cclust(t)),2)+(gdy)*sind(ndegrees+90);
                        
                        node=[x1 y1;x3 y3];
                        rbbox2=vertcat(rbbox2,[x2 y2]);
                        rbbox2=vertcat(rbbox2,[x4 y4]);
                        bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                        
                    elseif t==length(cclust)
                        ndegrees=line_angle([centre_pts(nodes(cclust(t)),1),centre_pts(nodes(cclust(t)),2)],[centre_pts(c2,1),centre_pts(c2,2)]);
                        x1=centre_pts(nodes(cclust(t)),1)+(gdy)*cosd(ndegrees-90);
                        y1=centre_pts(nodes(cclust(t)),2)+(gdy)*sind(ndegrees-90);
                        x2=centre_pts(nodes(cclust(t)),1)+(gdy)*cosd(ndegrees+90);
                        y2=centre_pts(nodes(cclust(t)),2)+(gdy)*sind(ndegrees+90);
                        x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                        y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                        x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                        y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                        
                        node=[x1 y1;x3 y3];
                        rbbox2=vertcat(rbbox2,[x2 y2]);
                        rbbox2=vertcat(rbbox2,[x4 y4]);
                        bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                        
                    elseif t<length(cclust)
                        ndegrees=line_angle([centre_pts(nodes(cclust(t)),1),centre_pts(nodes(cclust(t)),2)],[centre_pts(nodes(cclust(t+1)),1),centre_pts(nodes(cclust(t+1)),2)]);
                        x1=centre_pts(nodes(cclust(t)),1)+(gdy)*cosd(ndegrees-90);
                        y1=centre_pts(nodes(cclust(t)),2)+(gdy)*sind(ndegrees-90);
                        x2=centre_pts(nodes(cclust(t)),1)+(gdy)*cosd(ndegrees+90);
                        y2=centre_pts(nodes(cclust(t)),2)+(gdy)*sind(ndegrees+90);
                        x3=centre_pts(nodes(cclust(t+1)),1)+(gdy)*cosd(ndegrees-90);
                        y3=centre_pts(nodes(cclust(t+1)),2)+(gdy)*sind(ndegrees-90);
                        x4=centre_pts(nodes(cclust(t+1)),1)+(gdy)*cosd(ndegrees+90);
                        y4=centre_pts(nodes(cclust(t+1)),2)+(gdy)*sind(ndegrees+90);
                        
                        node=[x3 y3];
                        rbbox2=vertcat(rbbox2,[x4 y4]);
                        bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
                    end
                end
            else
                ndegrees=line_angle([centre_pts(c1,1),centre_pts(c1,2)],[centre_pts(c2,1),centre_pts(c2,2)]);
                x1=centre_pts(c1,1)+(gdy)*cosd(ndegrees-90);
                y1=centre_pts(c1,2)+(gdy)*sind(ndegrees-90);
                x2=centre_pts(c1,1)+(gdy)*cosd(ndegrees+90);
                y2=centre_pts(c1,2)+(gdy)*sind(ndegrees+90);
                x3=centre_pts(c2,1)+(gdy)*cosd(ndegrees-90);
                y3=centre_pts(c2,2)+(gdy)*sind(ndegrees-90);
                x4=centre_pts(c2,1)+(gdy)*cosd(ndegrees+90);
                y4=centre_pts(c2,2)+(gdy)*sind(ndegrees+90);
                
                node=[x1 y1;x3 y3];
                rbbox2=vertcat(rbbox2,[x2 y2]);
                rbbox2=vertcat(rbbox2,[x4 y4]);
                bbox2=vertcat(bbox2,[node(:,1) node(:,2)]);
            end
            
            intermediate2=[];
            if ~isempty(rbbox2)
                ni=length(rbbox2(:,1));
                
                while ni>=1
                    bbox2=vertcat(bbox2,[rbbox2(ni,1) rbbox2(ni,2)]);
                    ni=ni-1;
                end
                bbox2=vertcat(bbox2,[bbox2(1,1) bbox2(1,2)]);
                in = inpolygon(pts_ln.pts_ln(:,1),pts_ln.pts_ln(:,2),bbox2(:,1),bbox2(:,2));
                
                intermediate2=[pts_ln.pts_ln(in,1),pts_ln.pts_ln(in,2)];
                intermediate2(:,3)=1;
            end
            
            if ~isempty(split)
                for g=1:length(split(:,1))
                    rc1=find(centre_pts(:,3)==split(g,1));
                    rc2=find(centre_pts(:,3)==split(g,2));
                    in1 = inpolygon(centre_pts(rc1,1),centre_pts(rc1,2),bbox2(:,1),bbox2(:,2));
                    in2 = inpolygon(centre_pts(rc2,1),centre_pts(rc2,2),bbox2(:,1),bbox2(:,2));
                    ds=sqrt((centre_pts(rc1,1)-centre_pts(rc2,1))^2+(centre_pts(rc1,2)-centre_pts(rc2,2))^2);
                    if (in1==0||in2==0)&&(centre_pts(rc1,3)~=centre_pts(rc2,3))
                        maxcl=(max(netnodes(:,1))+1);
                        cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(rc1,3),centre_pts(rc2,3), maxcl, round((centre_pts(rc1,9)+centre_pts(rc2,9))/2), round((centre_pts(rc1,8)+centre_pts(rc2,8))/2), distancePoints([centre_pts(rc1,1) centre_pts(rc1,2)],[centre_pts(rc2,1) centre_pts(rc2,2)] , 2)]);
                        netnodes=vertcat(netnodes,[maxcl,split(g,3),0,1,1,0,0,0]);
                    end
                end
            end
            
            
            pointset=[];
            if ~isempty(nsegs)
                for l=1:length(nsegs(:,1))
                    r=find(netsections(:,1)==nsegs(l,1));
                    if ~isempty(r)
                        for m=1:length(r)
                            pointset=vertcat(pointset,[netsections(r(m),2) netsections(r(m),3) nsegs(l,2)]);
                        end
                    end
                end
            end
            
            if ~isempty(intermediate)
                intermediate=unique(intermediate,'rows');
                for l=1:length(intermediate(:,1))
                    pointset=vertcat(pointset,[intermediate(l,1) intermediate(l,2) intermediate(l,3)]);
                end
            end
            
            if ~isempty(pointset)
                lline=createLine([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]);
                for h=1:length(pointset(:,1))
                    if pointset(h,3)<cluster_to_tr(sres,4)
                        ppj=projPointOnLine([pointset(h,1) pointset(h,2)],lline);
                        if distancePoints([pointset(h,1) pointset(h,2)],[ppj(1,1) ppj(1,2)],2)<=cluster_to_tr(sres,5)
                            pointset(h,1)=(pointset(h,3)*pointset(h,1)+ppj(1,1))/(pointset(h,3)+1);
                            pointset(h,2)=(pointset(h,3)*pointset(h,2)+ppj(1,2))/(pointset(h,3)+1);
                            
                        end
                    end
                end
            end
            
            if ~isempty(pointset)
                circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
                idx=[];
                for l=1:length(pointset(:,1))
                    if isPointInCircle([pointset(l,1), pointset(l,2)], circle)
                        idx=vertcat(idx,l);
                    end
                end
                pointset(idx,:)=[];
                
                circle = [[centre_pts(c2,1) centre_pts(c2,2)] 15];
                idx=[];
                for l=1:length(pointset(:,1))
                    if isPointInCircle([pointset(l,1), pointset(l,2)], circle)
                        idx=vertcat(idx,l);
                    end
                end
                pointset(idx,:)=[];
                for g=1:length(cclust)
                    circle = [[centre_pts(nodes(cclust(g)),1) centre_pts(nodes(cclust(g)),2)] 15];
                    idx=[];
                    for l=1:length(pointset(:,1))
                        if isPointInCircle([pointset(l,1), pointset(l,2)], circle)
                            idx=vertcat(idx,l);
                        end
                    end
                    pointset(idx,:)=[];
                end
            end
            
            if ~isempty(pointset)
                [ps idps]=unique([pointset(:,1) pointset(:,2)],'rows');
                pointset=pointset(idps,:);
            end
            
            
            pseq=pointset;
            
            ppseq=[];
            ptemp=[];
            
            if ~isempty(pseq)
                Cldist=[];
                Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
                Cldist=vertcat(Cldist, [pseq(:,1), pseq(:,2)]);
                Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
                Y = pdist(Cldist,'euclid');
                SQ=squareform(Y);
                mclust=zeros(length(Cldist), 1);
                
                for o=1:length(SQ(:,:))
                    SQ(o,o)=100000.0;
                end
                
                %finding sequence of centres point cloud
                j=1;
                idxk=1;
                minip=100000.0;
                while idxk<=length(SQ(idxk,:)) & j<=length(Cldist(:,1))
                    
                    if length(idxk)>1
                        index=0;
                        for g=1:length(idxk)
                            mindist=min(SQ(idxk(g),:));
                            if mindist<=minip
                                minip=mindist;
                                index=g;
                            end
                        end
                        resi=find(SQ(idxk(index),:)==minip);
                        mclust(j)=idxk(index);
                        minip=100000.0;
                        j=j+1;
                    else
                        mindist=min(SQ(idxk,:));
                        resi=find(SQ(idxk,:)==mindist);
                        mclust(j)=idxk;
                        j=j+1;
                    end
                    
                    if length(Cldist(:,1))==idxk
                        break;
                    end
                    
                    SQ(idxk,:)=100000;
                    SQ(:,resi)=100000;
                    
                    if idxk==1
                        SQ(:,idxk)=100000;
                    end
                    
                    curr=resi;
                    idxk=curr;
                end
                
                mc=mclust~=0;
                mclust=mclust(mc);
                pseq=pseq(mclust(2:length(mclust)-1)-1,:);
                ptemp=temp;
                
                Cldist(:,3)=1;
                temp=Cldist(mclust(2:length(mclust)-1),:);
                
                ppseq=pseq;
            end
            
            pseq=ppseq;
            if ~isempty(pseq)
                rp= pseq(:,1)==centre_pts(c1,1)&pseq(:,2)==centre_pts(c1,2);
                pseq(rp,:)=[];
                rp=pseq(:,1)==centre_pts(c2,1)&pseq(:,2)==centre_pts(c2,2);
                pseq(rp,:)=[];
                for v=1:length(cclust)
                    rp= pseq(:,1)==centre_pts(nodes(cclust(v)),1)&pseq(:,2)==centre_pts(nodes(cclust(v)),2);
                    if ~isempty(rp)
                        pseq(rp,:)=[];
                    end
                end
            end
            
            Cldist=[];
            Cldist=[centre_pts(c1,1), centre_pts(c1,2)];
            if ~isempty(pseq)
                PP=vertcat([centre_pts(nodes(cclust),1), centre_pts(nodes(cclust),2)],[pseq(:,1), pseq(:,2)]);
            else
                PP=[centre_pts(nodes(cclust),1), centre_pts(nodes(cclust),2)];
            end
            PP=unique(PP,'rows');
            Cldist=vertcat(Cldist, PP);
            Cldist=vertcat(Cldist, [centre_pts(c2,1), centre_pts(c2,2)]);
            Y = pdist(Cldist,'euclid');
            SQ=squareform(Y);
            pointseq=[];
            pointseq=zeros(length(Cldist), 1);
            
            for o=1:length(SQ(:,:))
                SQ(o,o)=100000.0;
            end
            
            %finding sequence of centres point cloud
            j=1;
            idxk=1;
            minip=100000.0;
            while idxk<=length(SQ(idxk,:)) & j<=length(Cldist(:,1))
                
                if length(idxk)>1
                    index=0;
                    for g=1:length(idxk)
                        mindist=min(SQ(idxk(g),:));
                        if mindist<=minip
                            minip=mindist;
                            index=g;
                        end
                    end
                    resi=find(SQ(idxk(index),:)==minip);
                    pointseq(j)=idxk(index);
                    minip=100000.0;
                    j=j+1;
                else
                    mindist=min(SQ(idxk,:));
                    resi=find(SQ(idxk,:)==mindist);
                    pointseq(j)=idxk;
                    j=j+1;
                end
                
                if length(Cldist(:,1))==idxk
                    break;
                end
                
                SQ(idxk,:)=100000;
                SQ(:,resi)=100000;
                
                if idxk==1
                    SQ(:,idxk)=100000;
                end
                curr=resi;
                idxk=curr;
            end
            
            seq=find(pointseq~=0);
            pointseq=pointseq(seq);
            sequence=[];
            
            for l=1:length(pointseq)
                sequence=vertcat(sequence,[Cldist(pointseq(l),1), Cldist(pointseq(l),2)]);
            end
            
            idx=[];
            for g=1:length(cclust)
                rc=find(sequence(:,1)==centre_pts(nodes(cclust(g)),1)&sequence(:,2)==centre_pts(nodes(cclust(g)),2));
                if ~isempty(rc)
                    idx=vertcat(idx,g);
                end
            end
            
            if ~isempty(segscl)
                ids=[];
                for g=1:length(segscl(:,1))
                    rg=find(cluster_to_tr(:,3)==segscl(g,1));
                    if ~isempty(rg)
                        ri1=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,1));
                        ri2=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,2));
                        if isempty(ri1)&&isempty(ri2)
                            ids=vertcat(ids,g);
                        end
                    end
                end
                if ~isempty(ids)
                    ids=unique(ids);
                    segscl(ids,:)=[];
                end
            end
            
            if ~isempty(nsegs)
                ids=[];
                for g=1:length(nsegs(:,1))
                    rg=find(cluster_to_tr(:,3)==nsegs(g,1));
                    if ~isempty(rg)
                        ri1=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,1));
                        ri2=find(centre_pts(nodes(cclust(idx)),3)==cluster_to_tr(rg,2));
                        if isempty(ri1)||isempty(ri2)
                            ids=vertcat(ids,g);
                        end
                    end
                end
                if ~isempty(ids)
                    ids=unique(ids);
                    nsegs(ids,:)=[];
                end
            end
            
            if ~isempty(idx)
                cclust=cclust(idx);
            end
            
            if ~isempty(pseq)
                idx=[];
                for g=1:length(pseq(:,1))
                    rc=find(sequence(:,1)==pseq(g,1)&sequence(:,2)==pseq(g,2));
                    if isempty(rc)
                        idx=vertcat(idx,g);
                    end
                end
                if ~isempty(idx)
                    pseq(idx,:)=[];
                    
                end
            end
            
            if ~isempty(cclust)
                
                drc=[];
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            if nsegs(g,2)==2
                                drc=vertcat(drc,[centre_pts(c1,3),2]);
                            end
                        end
                    end
                end
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c2,3)||cluster_to_tr(r,2)==centre_pts(c2,3)
                            if nsegs(g,2)==2
                                drc=vertcat(drc,[centre_pts(c2,3),2]);
                            end
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            if segscl(g,2)==2
                                drc=vertcat(drc,[centre_pts(c1,3),2]);
                            end
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c2,3)||cluster_to_tr(r,2)==centre_pts(c2,3)
                            if segscl(g,2)==2
                                drc=vertcat(drc,[centre_pts(c2,3),2]);
                            end
                        end
                    end
                end
                for l=1:length(cclust)
                    if ~isempty(nsegs)
                        for g=1:length(nsegs(:,1))
                            r=find(cluster_to_tr(:,3)==nsegs(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                if nsegs(g,2)==2
                                    drc=vertcat(drc,[centre_pts(nodes(cclust(l)),3),2]);
                                end
                            end
                        end
                    end
                end
                for l=1:length(cclust)
                    if ~isempty(segscl)
                        for g=1:length(segscl(:,1))
                            r=find(cluster_to_tr(:,3)==segscl(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                if segscl(g,2)==2
                                    drc=vertcat(drc,[centre_pts(nodes(cclust(l)),3),2]);
                                end
                            end
                        end
                    end
                end
                
                if ~isempty(drc)
                    [dr drid]=unique(drc(:,1),'rows');
                    drc=drc(drid,:);
                end
                
                w1=netnodes(k,2);
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            rr=find(netnodes(:,1)==nsegs(g,1));
                            w1=w1+netnodes(rr,2);
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(c1,3)||cluster_to_tr(r,2)==centre_pts(c1,3)
                            rr=find(netnodes(:,1)==segscl(g,1));
                            w1=w1+netnodes(rr,2);
                        end
                    end
                end
                
                w2=netnodes(k,2);
                if ~isempty(nsegs)
                    for g=1:length(nsegs(:,1))
                        r=find(cluster_to_tr(:,3)==nsegs(g,1));
                        if cluster_to_tr(r,1)==centre_pts(memf,3)||cluster_to_tr(r,2)==centre_pts(memf,3)
                            rr=find(netnodes(:,1)==nsegs(g,1));
                            w2=w2+netnodes(rr,2);
                        end
                    end
                end
                if ~isempty(segscl)
                    for g=1:length(segscl(:,1))
                        r=find(cluster_to_tr(:,3)==segscl(g,1));
                        if cluster_to_tr(r,1)==centre_pts(memf,3)||cluster_to_tr(r,2)==centre_pts(memf,3)
                            rr=find(netnodes(:,1)==segscl(g,1));
                            w2=w2+netnodes(rr,2);
                        end
                    end
                end
                
                
                wgt=[];
                for l=1:length(cclust)
                    w=0;
                    if ~isempty(nsegs)
                        for g=1:length(nsegs(:,1))
                            r=find(cluster_to_tr(:,3)==nsegs(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                rr=find(netnodes(:,1)==nsegs(g,1));
                                w=w+netnodes(rr,2);
                            end
                        end
                    end
                    if ~isempty(segscl)
                        for g=1:length(segscl(:,1))
                            r=find(cluster_to_tr(:,3)==segscl(g,1));
                            if cluster_to_tr(r,1)==centre_pts(nodes(cclust(l)),3)||cluster_to_tr(r,2)==centre_pts(nodes(cclust(l)),3)
                                rr=find(netnodes(:,1)==segscl(g,1));
                                w=w+netnodes(rr,2);
                            end
                        end
                    end
                    wgt=vertcat(wgt,[centre_pts(nodes(cclust(l)),3),w]);
                end
                
                if ~isempty(nsegs)
                    for l=1:length(nsegs(:,1))
                        rr=find(cluster_to_tr(:,3)==nsegs(l,1));
                        if ~isempty(rr)
                            cluster_to_tr(rr,:)=[];
                        end
                        
                        rr=find(netsections(:,1)==nsegs(l,1));
                        rr=unique(rr);
                        h=length(rr);
                        while h>=1
                            netsections(rr(h),:)=[];
                            h=h-1;
                        end
                    end
                end
                
                if ~isempty(segscl)
                    for l=1:length(segscl(:,1))
                        rr=find(cluster_to_tr(:,3)==segscl(l,1));
                        if ~isempty(rr)
                            cluster_to_tr(rr,:)=[];
                        end
                        
                        rr=find(netsections(:,1)==segscl(l,1));
                        rr=unique(rr);
                        h=length(rr);
                        while h>=1
                            netsections(rr(h),:)=[];
                            h=h-1;
                        end
                    end
                end
                
                if ~isempty(prvfl)
                    for v=1:length(prvfl)
                        dx=sqrt((centre_pts(c1,1)-centre_pts(prvfl(v),1))^2+(centre_pts(c1,2)-centre_pts(prvfl(v),2))^2);
                        if dx<=100
                            rch=find(cluster_to_tr(:,1)==centre_pts(prvfl(v),3) & cluster_to_tr(:,2)==centre_pts(c1,3));
                            if isempty(rch)
                                if centre_pts(prvfl(v),3)~=centre_pts(c1,3)
                                    clid=(max(netnodes(:,1))+1);
                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(prvfl(v),3),centre_pts(c1,3), clid, round((centre_pts(c1,9)+centre_pts(prvfl(v),9))/2), round((centre_pts(c1,8)+centre_pts(prvfl(v),8))/2), distancePoints([centre_pts(prvfl(v),1) centre_pts(prvfl(v),2)], [centre_pts(c1,1) centre_pts(c1,2)], 2)]);
                                    if ~isempty(drc)
                                        dir=find(drc(:,1)==centre_pts(prvfl(v),3)|drc(:,1)==centre_pts(c1,3));
                                    end
                                    if ~isempty(dir)
                                        netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                    else
                                        netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                    end
                                end
                            end
                        end
                    end
                end
                
                for t=1:length(cclust)
                    c7=find(centre_pts(:,3)==centre_pts(nodes(cclust(t)),3));
                    if t==1
                        rch=find(cluster_to_tr(:,1)==centre_pts(c1,3) & cluster_to_tr(:,2)==centre_pts(c7,3));
                        if isempty(rch)
                            if centre_pts(c1,3)~=centre_pts(c7,3)
                                clid=(max(netnodes(:,1))+1);
                                cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c1,3), centre_pts(c7,3), clid, round((centre_pts(c1,9)+centre_pts(c7,9))/2), round((centre_pts(c1,8)+centre_pts(c7,8))/2), distancePoints([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c7,1) centre_pts(c7,2)], 2)]);
                                if round((w1+wgt(t,2))/2)==0
                                    w=1;
                                else
                                    w=round((w1+wgt(t,2))/2);
                                end
                                
                                if ~isempty(drc)
                                    dir=find(drc(:,1)==centre_pts(c7,3)|drc(:,1)==centre_pts(c1,3));
                                end
                                if ~isempty(dir)
                                    netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                else
                                    netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c1,1) & sequence(:,2)==centre_pts(c1,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            r3=find(cluster_to_tr(:,3)==clid);
                            dd=round((centre_pts(c1,8)+centre_pts(c7,8))/2);
                            
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c1,1)+dd;
                                                y1=centre_pts(c1,2)+dd;
                                                x2=centre_pts(c1,1)+dd;
                                                y2=centre_pts(c1,2)-dd;
                                                x3=centre_pts(c1,1)-dd;
                                                y3=centre_pts(c1,2)+dd;
                                                x4=centre_pts(c1,1)-dd;
                                                y4=centre_pts(c1,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                                tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                            centre_pts(c1,1)=aa(1,1);
                                                            centre_pts(c1,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c1,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c1,1) centre_pts(c1,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for m=1:length(temp(:,1))
                                                netsections=vertcat(netsections,[clid,temp(m,1),temp(m,2),0,0]);
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c1,1)+dd;
                                    y1=centre_pts(c1,2)+dd;
                                    x2=centre_pts(c1,1)+dd;
                                    y2=centre_pts(c1,2)-dd;
                                    x3=centre_pts(c1,1)-dd;
                                    y3=centre_pts(c1,2)+dd;
                                    x4=centre_pts(c1,1)-dd;
                                    y4=centre_pts(c1,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                    tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                centre_pts(c1,1)=aa(1,1);
                                                centre_pts(c1,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c1,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                end
                            end
                        else
                            for n=1:length(rch)
                                rm=find(netsections(:,1)==cluster_to_tr(rch(n),3));
                                if ~isempty(rm)
                                    netsections(rm,:)=[];
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c1,1) & sequence(:,2)==centre_pts(c1,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            dd=round((centre_pts(c1,8)+centre_pts(c7,8))/2);
                            clid=cluster_to_tr(rch,3);
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c1,1)+dd;
                                                y1=centre_pts(c1,2)+dd;
                                                x2=centre_pts(c1,1)+dd;
                                                y2=centre_pts(c1,2)-dd;
                                                x3=centre_pts(c1,1)-dd;
                                                y3=centre_pts(c1,2)+dd;
                                                x4=centre_pts(c1,1)-dd;
                                                y4=centre_pts(c1,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                                tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                            centre_pts(c1,1)=aa(1,1);
                                                            centre_pts(c1,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c1,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c1,1) centre_pts(c1,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for x=1:length(clid)
                                                for m=1:length(temp(:,1))
                                                    netsections=vertcat(netsections,[clid(x),temp(m,1),temp(m,2),0,0]);
                                                end
                                            end
                                        end
                                    end
                                    
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c1,1)+dd;
                                    y1=centre_pts(c1,2)+dd;
                                    x2=centre_pts(c1,1)+dd;
                                    y2=centre_pts(c1,2)-dd;
                                    x3=centre_pts(c1,1)-dd;
                                    y3=centre_pts(c1,2)+dd;
                                    x4=centre_pts(c1,1)-dd;
                                    y4=centre_pts(c1,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                                    tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                                centre_pts(c1,1)=aa(1,1);
                                                centre_pts(c1,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c1,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                end
                            end
                        end
                    else
                        c8=find(centre_pts(:,3)==centre_pts(nodes(cclust(t-1)),3));
                        rch=find(cluster_to_tr(:,1)==centre_pts(c8,3) & cluster_to_tr(:,2)== centre_pts(c7,3));
                        if isempty(rch)
                            if centre_pts(c8,3)~=centre_pts(c7,3)
                                clid=(max(netnodes(:,1))+1);
                                cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c8,3), centre_pts(c7,3), clid, round((centre_pts(c8,9)+centre_pts(c7,9))/2), round((centre_pts(c8,8)+centre_pts(c7,8))/2), distancePoints([centre_pts(c8,1) centre_pts(c8,2)], [centre_pts(c7,1) centre_pts(c7,2)], 2)]);
                                if round((w1+wgt(t,2))/2)==0
                                    w=1;
                                else
                                    w=round((w1+wgt(t,2))/2);
                                end
                                
                                if ~isempty(drc)
                                    dir=find(drc(:,1)==centre_pts(c7,3)|drc(:,1)==centre_pts(c8,3));
                                end
                                if ~isempty(dir)
                                    netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                else
                                    netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c8,1) & sequence(:,2)==centre_pts(c8,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            r3=find(cluster_to_tr(:,3)==clid);
                            dd=round((centre_pts(c8,8)+centre_pts(c7,8))/2);
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c8,1)+dd;
                                                y1=centre_pts(c8,2)+dd;
                                                x2=centre_pts(c8,1)+dd;
                                                y2=centre_pts(c8,2)-dd;
                                                x3=centre_pts(c8,1)-dd;
                                                y3=centre_pts(c8,2)+dd;
                                                x4=centre_pts(c8,1)-dd;
                                                y4=centre_pts(c8,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                                tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                            centre_pts(c8,1)=aa(1,1);
                                                            centre_pts(c8,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c8,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c8,1) centre_pts(c8,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c8,1) centre_pts(c8,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for m=1:length(temp(:,1))
                                                netsections=vertcat(netsections,[clid,temp(m,1),temp(m,2),0,0]);
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c8,1)+dd;
                                    y1=centre_pts(c8,2)+dd;
                                    x2=centre_pts(c8,1)+dd;
                                    y2=centre_pts(c8,2)-dd;
                                    x3=centre_pts(c8,1)-dd;
                                    y3=centre_pts(c8,2)+dd;
                                    x4=centre_pts(c8,1)-dd;
                                    y4=centre_pts(c8,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                    tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                centre_pts(c8,1)=aa(1,1);
                                                centre_pts(c8,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c8,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    cluster_to_tr(r3,4)=max(p1,p2);
                                    cluster_to_tr(r3,5)=max(p3,p4);
                                end
                            end
                        else
                            for n=1:length(rch)
                                rm=find(netsections(:,1)==cluster_to_tr(rch(n),3));
                                if ~isempty(rm)
                                    netsections(rm,:)=[];
                                end
                            end
                            r1=find(sequence(:,1)==centre_pts(c8,1) & sequence(:,2)==centre_pts(c8,2));
                            r2=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                            dd=round((centre_pts(c8,8)+centre_pts(c7,8))/2);
                            clid=cluster_to_tr(rch,3);
                            
                            if dd<1
                                dd=15;
                            end
                            
                            if ~isempty(r1)&&~isempty(r2)
                                interpts=sequence((r1+1):(r2-1),:);
                                p1=0;
                                p2=0;
                                p3=0;
                                p4=0;
                                if ~isempty(interpts)
                                    pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                    [rpts ipts]=unique(pts,'rows');
                                    ipts=sortrows(ipts,1);
                                    pts=pts(ipts,:);
                                    
                                    if ~isempty(pts)
                                        for b=1:length(pts(:,1))
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [pts(b,1) pts(b,2)]));
                                                
                                                x1=centre_pts(c8,1)+dd;
                                                y1=centre_pts(c8,2)+dd;
                                                x2=centre_pts(c8,1)+dd;
                                                y2=centre_pts(c8,2)-dd;
                                                x3=centre_pts(c8,1)-dd;
                                                y3=centre_pts(c8,2)+dd;
                                                x4=centre_pts(c8,1)-dd;
                                                y4=centre_pts(c8,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                                tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p1=length(vpts(:,1));
                                                    
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                            centre_pts(c8,1)=aa(1,1);
                                                            centre_pts(c8,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p3=max(SQ(1,:));
                                                            centre_pts(c8,8)=p3;
                                                            
                                                            sequence(r1,1)=aa(1,1);
                                                            sequence(r1,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                
                                                x1=centre_pts(c7,1)+dd;
                                                y1=centre_pts(c7,2)+dd;
                                                x2=centre_pts(c7,1)+dd;
                                                y2=centre_pts(c7,2)-dd;
                                                x3=centre_pts(c7,1)-dd;
                                                y3=centre_pts(c7,2)+dd;
                                                x4=centre_pts(c7,1)-dd;
                                                y4=centre_pts(c7,2)-dd;
                                                
                                                x=[x1 x2 x3 x4];
                                                x=vertcat(x,[y1 y2 y3 y4]);
                                                mb=minBoundingBox(x);
                                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                                
                                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                                
                                                rs1=find(in1==1);
                                                rs2=find(in2==1);
                                                rss=union(rs1,rs2,'rows');
                                                
                                                x1=centre_pts(c7,1)+(dd)*cosd(ndegrees-90);
                                                y1=centre_pts(c7,2)+(dd)*sind(ndegrees-90);
                                                x2=centre_pts(c7,1)+(dd)*cosd(ndegrees+90);
                                                y2=centre_pts(c7,2)+(dd)*sind(ndegrees+90);
                                                e1 = createEdge([x1 y1], [x2 y2]);
                                                
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                                ce1=createEdge(e1,dd);
                                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                                dest1 = transformEdge(ce1,tr1);
                                                dest2 = transformEdge(ce1,tr2);
                                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                                
                                                vpts=[];
                                                for h=1:length(rss)
                                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                        point = intersectEdges(ce1, e2);
                                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                            vpts=vertcat(vpts,point);
                                                        end
                                                    end
                                                end
                                                
                                                if ~isempty(vpts)
                                                    
                                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                    if isempty(rv)
                                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                    end
                                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                    p2=length(vpts(:,1));
                                                    if length(vpts(:,1))>1
                                                        aa=centroid(vpts);
                                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                            centre_pts(c7,1)=aa(1,1);
                                                            centre_pts(c7,2)=aa(1,2);
                                                            
                                                            mb=vpts;
                                                            mb=unique(vpts,'rows');
                                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                            pd=vertcat(pd,mb);
                                                            
                                                            Y = pdist(pd,'euclid');
                                                            SQ=squareform(Y);
                                                            p4=max(SQ(1,:));
                                                            centre_pts(c7,8)=p4;
                                                            
                                                            sequence(r2,1)=aa(1,1);
                                                            sequence(r2,2)=aa(1,2);
                                                            
                                                        end
                                                    end
                                                end
                                            end
                                            if b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            end
                                            
                                            x1=pts(b,1)+dd;
                                            y1=pts(b,2)+dd;
                                            x2=pts(b,1)+dd;
                                            y2=pts(b,2)-dd;
                                            x3=pts(b,1)-dd;
                                            y3=pts(b,2)+dd;
                                            x4=pts(b,1)-dd;
                                            y4=pts(b,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            if b==1
                                                ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]));
                                                in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[pts(b,1) pts(b,2)]);
                                            elseif b==length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                            elseif b<length(pts(:,1))
                                                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                            end
                                            
                                            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    pts(b,1)=aa(1,1);
                                                    pts(b,2)=aa(1,2);
                                                end
                                            end
                                        end
                                        
                                        pseq=pts;
                                        
                                        circle = [[centre_pts(c8,1) centre_pts(c8,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                        idx=[];
                                        for l=1:length(pseq(:,1))
                                            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                                idx=vertcat(idx,l);
                                            end
                                        end
                                        pseq(idx,:)=[];
                                        
                                        if ~isempty(pseq)
                                            NP=[centre_pts(c8,1) centre_pts(c8,2)];
                                            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                            NP=vertcat(NP, MP);
                                            NP=vertcat(NP, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            Mdist=[NP(:,1) NP(:,2)];
                                            Y = pdist(Mdist,'euclid');
                                            SQ=squareform(Y);
                                            mclusters=zeros(length(Mdist), 1);
                                            Mdist(:,3)=1;
                                            for o=1:length(SQ(:,:))
                                                SQ(o,o)=100000.0;
                                            end
                                            
                                            %finding sequence of point cloud
                                            j=1;
                                            idxk=1;
                                            minip=100000.0;
                                            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                                if length(idxk)>1
                                                    index=0;
                                                    for g=1:length(idxk)
                                                        mindist=min(SQ(idxk(g),:));
                                                        if mindist<=minip
                                                            minip=mindist;
                                                            index=g;
                                                        end
                                                    end
                                                    resi=find(SQ(idxk(index),:)==minip);
                                                    mclusters(j)=idxk(index);
                                                    minip=100000.0;
                                                    j=j+1;
                                                else
                                                    mindist=min(SQ(idxk,:));
                                                    resi=find(SQ(idxk,:)==mindist);
                                                    mclusters(j)=idxk;
                                                    j=j+1;
                                                end
                                                
                                                if length(NP(:,1))==idxk
                                                    break;
                                                end
                                                
                                                SQ(idxk,:)=100000;
                                                SQ(:,resi)=100000;
                                                
                                                if idxk==1
                                                    SQ(:,idxk)=100000;
                                                end
                                                
                                                curr=resi;
                                                idxk=curr;
                                            end
                                            
                                            f=mclusters~=0;
                                            tempc=mclusters(f);
                                            clear mclusters;
                                            mclusters=tempc;
                                            clear tempc;
                                            
                                            temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                            for x=1:length(clid)
                                                for m=1:length(temp(:,1))
                                                    netsections=vertcat(netsections,[clid(x),temp(m,1),temp(m,2),0,0]);
                                                end
                                            end
                                        end
                                    end
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                else
                                    ndegrees=rad2deg(angle2Points([centre_pts(c8,1) centre_pts(c8,2)], [centre_pts(c7,1) centre_pts(c7,2)]));
                                    
                                    x1=centre_pts(c8,1)+dd;
                                    y1=centre_pts(c8,2)+dd;
                                    x2=centre_pts(c8,1)+dd;
                                    y2=centre_pts(c8,2)-dd;
                                    x3=centre_pts(c8,1)-dd;
                                    y3=centre_pts(c8,2)+dd;
                                    x4=centre_pts(c8,1)-dd;
                                    y4=centre_pts(c8,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    in = createLine([centre_pts(c8,1) centre_pts(c8,2)],[centre_pts(c7,1) centre_pts(c7,2)]);
                                    e1 =orthogonalLine(in, [centre_pts(c8,1) centre_pts(c8,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], 0);
                                    tr2 = createRotation([centre_pts(c8,1) centre_pts(c8,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c8,1)&elk(rss(h),2)~=centre_pts(c8,2)&elk(rss(h),3)~=centre_pts(c8,1)&elk(rss(h),4)~=centre_pts(c8,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    
                                    if ~isempty(vpts)
                                        
                                        rv=find(vpts(:,1)==centre_pts(c8,1)&vpts(:,2)==centre_pts(c8,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c8,1) centre_pts(c8,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p1=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c8,1) centre_pts(c8,2)], aa, 2)<=dd
                                                centre_pts(c8,1)=aa(1,1);
                                                centre_pts(c8,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c8,1) centre_pts(c8,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p3=max(SQ(1,:));
                                                centre_pts(c8,8)=p3;
                                                
                                                sequence(r1,1)=aa(1,1);
                                                sequence(r1,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    
                                    x1=centre_pts(c7,1)+dd;
                                    y1=centre_pts(c7,2)+dd;
                                    x2=centre_pts(c7,1)+dd;
                                    y2=centre_pts(c7,2)-dd;
                                    x3=centre_pts(c7,1)-dd;
                                    y3=centre_pts(c7,2)+dd;
                                    x4=centre_pts(c7,1)-dd;
                                    y4=centre_pts(c7,2)-dd;
                                    
                                    x=[x1 x2 x3 x4];
                                    x=vertcat(x,[y1 y2 y3 y4]);
                                    mb=minBoundingBox(x);
                                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                    
                                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                    
                                    rs1=find(in1==1);
                                    rs2=find(in2==1);
                                    rss=union(rs1,rs2,'rows');
                                    
                                    e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                    ce1=createEdge(e1,dd);
                                    tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                    tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                    dest1 = transformEdge(ce1,tr1);
                                    dest2 = transformEdge(ce1,tr2);
                                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                    
                                    vpts=[];
                                    for h=1:length(rss)
                                        if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                            point = intersectEdges(ce1, e2);
                                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                vpts=vertcat(vpts,point);
                                            end
                                        end
                                    end
                                    
                                    if ~isempty(vpts)
                                        rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                        if isempty(rv)
                                            vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                        end
                                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                        p2=length(vpts(:,1));
                                        
                                        if length(vpts(:,1))>1
                                            aa=centroid(vpts);
                                            if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                centre_pts(c7,1)=aa(1,1);
                                                centre_pts(c7,2)=aa(1,2);
                                                
                                                mb=vpts;
                                                mb=unique(vpts,'rows');
                                                pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                pd=vertcat(pd,mb);
                                                
                                                Y = pdist(pd,'euclid');
                                                SQ=squareform(Y);
                                                p4=max(SQ(1,:));
                                                centre_pts(c7,8)=p4;
                                                
                                                sequence(r2,1)=aa(1,1);
                                                sequence(r2,2)=aa(1,2);
                                                
                                            end
                                        end
                                    end
                                    for n=1:length(rch)
                                        cluster_to_tr(rch(n),4)=max(p1,p2);
                                        cluster_to_tr(rch(n),5)=max(p3,p4);
                                    end
                                end
                            end
                        end
                    end
                end
                
                if cclust(length(cclust))~=0
                    c7=find(centre_pts(:,3)==centre_pts(nodes(cclust(length(cclust))),3));
                    rch=find(cluster_to_tr(:,1)==centre_pts(c7,3) & cluster_to_tr(:,2)== centre_pts(memf,3));
                    if isempty(rch)
                        if centre_pts(c7,3)~=centre_pts(memf,3)
                            clid=(max(netnodes(:,1))+1);
                            cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(c7,3), centre_pts(memf,3), clid, round((centre_pts(c7,9)+centre_pts(memf,9))/2), round((centre_pts(c7,8)+centre_pts(memf,8))/2), distancePoints([centre_pts(c7,1) centre_pts(c7,2)], [centre_pts(memf,1) centre_pts(memf,2)], 2)]);
                            if round((w1+wgt(t,2))/2)==0
                                w=1;
                            else
                                w=round((w1+wgt(t,2))/2);
                            end
                            
                            if ~isempty(drc)
                                dir=find(drc(:,1)==centre_pts(memf,3)|drc(:,1)==centre_pts(c7,3));
                            end
                            if ~isempty(dir)
                                netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                            else
                                netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                            end
                        end
                        r1=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                        r2=find(sequence(:,1)==centre_pts(memf,1) & sequence(:,2)==centre_pts(memf,2));
                        r3=find(cluster_to_tr(:,3)==clid);
                        dd=round((centre_pts(c7,8)+centre_pts(memf,8))/2);
                        
                        if dd<1
                            dd=15;
                        end
                        
                        if ~isempty(r1)&&~isempty(r2)
                            interpts=sequence((r1+1):(r2-1),:);
                            p1=0;
                            p2=0;
                            p3=0;
                            p4=0;
                            if ~isempty(interpts)
                                pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                [rpts ipts]=unique(pts,'rows');
                                ipts=sortrows(ipts,1);
                                pts=pts(ipts,:);
                                
                                if ~isempty(pts)
                                    for b=1:length(pts(:,1))
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [pts(b,1) pts(b,2)]));
                                            
                                            x1=centre_pts(c7,1)+dd;
                                            y1=centre_pts(c7,2)+dd;
                                            x2=centre_pts(c7,1)+dd;
                                            y2=centre_pts(c7,2)-dd;
                                            x3=centre_pts(c7,1)-dd;
                                            y3=centre_pts(c7,2)+dd;
                                            x4=centre_pts(c7,1)-dd;
                                            y4=centre_pts(c7,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                            tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p1=length(vpts(:,1));
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                        centre_pts(c7,1)=aa(1,1);
                                                        centre_pts(c7,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p3=max(SQ(1,:));
                                                        centre_pts(c7,8)=p3;
                                                        
                                                        sequence(r1,1)=aa(1,1);
                                                        sequence(r1,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            
                                            x1=centre_pts(memf,1)+dd;
                                            y1=centre_pts(memf,2)+dd;
                                            x2=centre_pts(memf,1)+dd;
                                            y2=centre_pts(memf,2)-dd;
                                            x3=centre_pts(memf,1)-dd;
                                            y3=centre_pts(memf,2)+dd;
                                            x4=centre_pts(memf,1)-dd;
                                            y4=centre_pts(memf,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            x1=centre_pts(memf,1)+(dd)*cosd(ndegrees-90);
                                            y1=centre_pts(memf,2)+(dd)*sind(ndegrees-90);
                                            x2=centre_pts(memf,1)+(dd)*cosd(ndegrees+90);
                                            y2=centre_pts(memf,2)+(dd)*sind(ndegrees+90);
                                            e1 = createEdge([x1 y1], [x2 y2]);
                                            
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                            tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p2=length(vpts(:,1));
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                                        centre_pts(memf,1)=aa(1,1);
                                                        centre_pts(memf,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p4=max(SQ(1,:));
                                                        centre_pts(memf,8)=p4;
                                                        
                                                        sequence(r2,1)=aa(1,1);
                                                        sequence(r2,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                        end
                                        
                                        x1=pts(b,1)+dd;
                                        y1=pts(b,2)+dd;
                                        x2=pts(b,1)+dd;
                                        y2=pts(b,2)-dd;
                                        x3=pts(b,1)-dd;
                                        y3=pts(b,2)+dd;
                                        x4=pts(b,1)-dd;
                                        y4=pts(b,2)-dd;
                                        
                                        x=[x1 x2 x3 x4];
                                        x=vertcat(x,[y1 y2 y3 y4]);
                                        mb=minBoundingBox(x);
                                        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                        
                                        in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                        in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                        
                                        rs1=find(in1==1);
                                        rs2=find(in2==1);
                                        rss=union(rs1,rs2,'rows');
                                        
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]));
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                        elseif b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                        elseif b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                        end
                                        
                                        e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                        ce1=createEdge(e1,dd);
                                        tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                        tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                        dest1 = transformEdge(ce1,tr1);
                                        dest2 = transformEdge(ce1,tr2);
                                        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                        
                                        vpts=[];
                                        for h=1:length(rss)
                                            if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                point = intersectEdges(ce1, e2);
                                                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                    vpts=vertcat(vpts,point);
                                                end
                                            end
                                        end
                                        
                                        if ~isempty(vpts)
                                            rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                            if isempty(rv)
                                                vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                            end
                                            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                            
                                            if length(vpts(:,1))>1
                                                aa=centroid(vpts);
                                                pts(b,1)=aa(1,1);
                                                pts(b,2)=aa(1,2);
                                            end
                                        end
                                    end
                                    
                                    pseq=pts;
                                    
                                    circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    circle = [[centre_pts(memf,1) centre_pts(memf,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    if ~isempty(pseq)
                                        NP=[centre_pts(c7,1) centre_pts(c7,2)];
                                        [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                        NP=vertcat(NP, MP);
                                        NP=vertcat(NP, [centre_pts(memf,1) centre_pts(memf,2)]);
                                        Mdist=[NP(:,1) NP(:,2)];
                                        Y = pdist(Mdist,'euclid');
                                        SQ=squareform(Y);
                                        mclusters=zeros(length(Mdist), 1);
                                        Mdist(:,3)=1;
                                        for o=1:length(SQ(:,:))
                                            SQ(o,o)=100000.0;
                                        end
                                        
                                        %finding sequence of point cloud
                                        j=1;
                                        idxk=1;
                                        minip=100000.0;
                                        while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                            if length(idxk)>1
                                                index=0;
                                                for g=1:length(idxk)
                                                    mindist=min(SQ(idxk(g),:));
                                                    if mindist<=minip
                                                        minip=mindist;
                                                        index=g;
                                                    end
                                                end
                                                resi=find(SQ(idxk(index),:)==minip);
                                                mclusters(j)=idxk(index);
                                                minip=100000.0;
                                                j=j+1;
                                            else
                                                mindist=min(SQ(idxk,:));
                                                resi=find(SQ(idxk,:)==mindist);
                                                mclusters(j)=idxk;
                                                j=j+1;
                                            end
                                            
                                            if length(NP(:,1))==idxk
                                                break;
                                            end
                                            
                                            SQ(idxk,:)=100000;
                                            SQ(:,resi)=100000;
                                            
                                            if idxk==1
                                                SQ(:,idxk)=100000;
                                            end
                                            
                                            curr=resi;
                                            idxk=curr;
                                        end
                                        
                                        f=mclusters~=0;
                                        tempc=mclusters(f);
                                        clear mclusters;
                                        mclusters=tempc;
                                        clear tempc;
                                        
                                        temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                        for m=1:length(temp(:,1))
                                            netsections=vertcat(netsections,[clid,temp(m,1),temp(m,2),0,0]);
                                        end
                                    end
                                end
                                
                                cluster_to_tr(r3,4)=max(p1,p2);
                                cluster_to_tr(r3,5)=max(p3,p4);
                            else
                                ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                
                                x1=centre_pts(c7,1)+dd;
                                y1=centre_pts(c7,2)+dd;
                                x2=centre_pts(c7,1)+dd;
                                y2=centre_pts(c7,2)-dd;
                                x3=centre_pts(c7,1)-dd;
                                y3=centre_pts(c7,2)+dd;
                                x4=centre_pts(c7,1)-dd;
                                y4=centre_pts(c7,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    
                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p1=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                            centre_pts(c7,1)=aa(1,1);
                                            centre_pts(c7,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p3=max(SQ(1,:));
                                            centre_pts(c7,8)=p3;
                                            
                                            sequence(r1,1)=aa(1,1);
                                            sequence(r1,2)=aa(1,2);
                                            
                                        end
                                    end
                                end
                                
                                x1=centre_pts(memf,1)+dd;
                                y1=centre_pts(memf,2)+dd;
                                x2=centre_pts(memf,1)+dd;
                                y2=centre_pts(memf,2)-dd;
                                x3=centre_pts(memf,1)-dd;
                                y3=centre_pts(memf,2)+dd;
                                x4=centre_pts(memf,1)-dd;
                                y4=centre_pts(memf,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p2=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                            centre_pts(memf,1)=aa(1,1);
                                            centre_pts(memf,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p4=max(SQ(1,:));
                                            centre_pts(memf,8)=p4;
                                            
                                            sequence(r2,1)=aa(1,1);
                                            sequence(r2,2)=aa(1,2);
                                        end
                                    end
                                end
                                
                                cluster_to_tr(r3,4)=max(p1,p2);
                                cluster_to_tr(r3,5)=max(p3,p4);
                            end
                        end
                    else
                        for n=1:length(rch)
                            rm=find(netsections(:,1)==cluster_to_tr(rch(n),3));
                            if ~isempty(rm)
                                netsections(rm,:)=[];
                            end
                        end
                        r1=find(sequence(:,1)==centre_pts(c7,1) & sequence(:,2)==centre_pts(c7,2));
                        r2=find(sequence(:,1)==centre_pts(memf,1) & sequence(:,2)==centre_pts(memf,2));
                        dd=round((centre_pts(c7,8)+centre_pts(memf,8))/2);
                        clid=cluster_to_tr(rch,3);
                        
                        if dd<1
                            dd=15;
                        end
                        
                        if ~isempty(r1)&&~isempty(r2)
                            interpts=sequence((r1+1):(r2-1),:);
                            p1=0;
                            p2=0;
                            p3=0;
                            p4=0;
                            if ~isempty(interpts)
                                pts=[round(interpts(:,1)*100000)/100000 round(interpts(:,2)*100000)/100000];
                                [rpts ipts]=unique(pts,'rows');
                                ipts=sortrows(ipts,1);
                                pts=pts(ipts,:);
                                
                                if ~isempty(pts)
                                    for b=1:length(pts(:,1))
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [pts(b,1) pts(b,2)]));
                                            
                                            x1=centre_pts(c7,1)+dd;
                                            y1=centre_pts(c7,2)+dd;
                                            x2=centre_pts(c7,1)+dd;
                                            y2=centre_pts(c7,2)-dd;
                                            x3=centre_pts(c7,1)-dd;
                                            y3=centre_pts(c7,2)+dd;
                                            x4=centre_pts(c7,1)-dd;
                                            y4=centre_pts(c7,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                            tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p1=length(vpts(:,1));
                                                
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                                        centre_pts(c7,1)=aa(1,1);
                                                        centre_pts(c7,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p3=max(SQ(1,:));
                                                        centre_pts(c7,8)=p3;
                                                        
                                                        sequence(r1,1)=aa(1,1);
                                                        sequence(r1,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            
                                            x1=centre_pts(memf,1)+dd;
                                            y1=centre_pts(memf,2)+dd;
                                            x2=centre_pts(memf,1)+dd;
                                            y2=centre_pts(memf,2)-dd;
                                            x3=centre_pts(memf,1)-dd;
                                            y3=centre_pts(memf,2)+dd;
                                            x4=centre_pts(memf,1)-dd;
                                            y4=centre_pts(memf,2)-dd;
                                            
                                            x=[x1 x2 x3 x4];
                                            x=vertcat(x,[y1 y2 y3 y4]);
                                            mb=minBoundingBox(x);
                                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                            
                                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                            
                                            rs1=find(in1==1);
                                            rs2=find(in2==1);
                                            rss=union(rs1,rs2,'rows');
                                            
                                            x1=centre_pts(memf,1)+(dd)*cosd(ndegrees-90);
                                            y1=centre_pts(memf,2)+(dd)*sind(ndegrees-90);
                                            x2=centre_pts(memf,1)+(dd)*cosd(ndegrees+90);
                                            y2=centre_pts(memf,2)+(dd)*sind(ndegrees+90);
                                            e1 = createEdge([x1 y1], [x2 y2]);
                                            
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                            e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                            ce1=createEdge(e1,dd);
                                            tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                            tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                            dest1 = transformEdge(ce1,tr1);
                                            dest2 = transformEdge(ce1,tr2);
                                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                            
                                            vpts=[];
                                            for h=1:length(rss)
                                                if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                    point = intersectEdges(ce1, e2);
                                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                        vpts=vertcat(vpts,point);
                                                    end
                                                end
                                            end
                                            
                                            if ~isempty(vpts)
                                                
                                                rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                                if isempty(rv)
                                                    vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                                end
                                                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                                p2=length(vpts(:,1));
                                                if length(vpts(:,1))>1
                                                    aa=centroid(vpts);
                                                    if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                                        centre_pts(memf,1)=aa(1,1);
                                                        centre_pts(memf,2)=aa(1,2);
                                                        
                                                        mb=vpts;
                                                        mb=unique(vpts,'rows');
                                                        pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                                        pd=vertcat(pd,mb);
                                                        
                                                        Y = pdist(pd,'euclid');
                                                        SQ=squareform(Y);
                                                        p4=max(SQ(1,:));
                                                        centre_pts(memf,8)=p4;
                                                        
                                                        sequence(r2,1)=aa(1,1);
                                                        sequence(r2,2)=aa(1,2);
                                                        
                                                    end
                                                end
                                            end
                                        end
                                        if b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                        end
                                        
                                        x1=pts(b,1)+dd;
                                        y1=pts(b,2)+dd;
                                        x2=pts(b,1)+dd;
                                        y2=pts(b,2)-dd;
                                        x3=pts(b,1)-dd;
                                        y3=pts(b,2)+dd;
                                        x4=pts(b,1)-dd;
                                        y4=pts(b,2)-dd;
                                        
                                        x=[x1 x2 x3 x4];
                                        x=vertcat(x,[y1 y2 y3 y4]);
                                        mb=minBoundingBox(x);
                                        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                        
                                        in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                        in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                        
                                        rs1=find(in1==1);
                                        rs2=find(in2==1);
                                        rss=union(rs1,rs2,'rows');
                                        
                                        if b==1
                                            ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]));
                                            in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[pts(b,1) pts(b,2)]);
                                        elseif b==length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                        elseif b<length(pts(:,1))
                                            ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                                            in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
                                        end
                                        
                                        e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
                                        ce1=createEdge(e1,dd);
                                        tr1 = createRotation([pts(b,1) pts(b,2)], 0);
                                        tr2 = createRotation([pts(b,1) pts(b,2)], pi);
                                        dest1 = transformEdge(ce1,tr1);
                                        dest2 = transformEdge(ce1,tr2);
                                        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                        
                                        vpts=[];
                                        for h=1:length(rss)
                                            if elk(rss(h),1)~=pts(b,1)&elk(rss(h),2)~=pts(b,2)&elk(rss(h),3)~=pts(b,1)&elk(rss(h),4)~=pts(b,2)
                                                e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                                point = intersectEdges(ce1, e2);
                                                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                                    vpts=vertcat(vpts,point);
                                                end
                                            end
                                        end
                                        
                                        if ~isempty(vpts)
                                            
                                            rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                                            if isempty(rv)
                                                vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                                            end
                                            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                            
                                            if length(vpts(:,1))>1
                                                aa=centroid(vpts);
                                                pts(b,1)=aa(1,1);
                                                pts(b,2)=aa(1,2);
                                            end
                                        end
                                    end
                                    
                                    pseq=pts;
                                    
                                    circle = [[centre_pts(c7,1) centre_pts(c7,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    circle = [[centre_pts(memf,1) centre_pts(memf,2)] 15];
                                    idx=[];
                                    for l=1:length(pseq(:,1))
                                        if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                                            idx=vertcat(idx,l);
                                        end
                                    end
                                    pseq(idx,:)=[];
                                    
                                    if ~isempty(pseq)
                                        NP=[centre_pts(c7,1) centre_pts(c7,2)];
                                        [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                                        NP=vertcat(NP, MP);
                                        NP=vertcat(NP, [centre_pts(memf,1) centre_pts(memf,2)]);
                                        Mdist=[NP(:,1) NP(:,2)];
                                        Y = pdist(Mdist,'euclid');
                                        SQ=squareform(Y);
                                        mclusters=zeros(length(Mdist), 1);
                                        Mdist(:,3)=1;
                                        for o=1:length(SQ(:,:))
                                            SQ(o,o)=100000.0;
                                        end
                                        
                                        %finding sequence of point cloud
                                        j=1;
                                        idxk=1;
                                        minip=100000.0;
                                        while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                                            if length(idxk)>1
                                                index=0;
                                                for g=1:length(idxk)
                                                    mindist=min(SQ(idxk(g),:));
                                                    if mindist<=minip
                                                        minip=mindist;
                                                        index=g;
                                                    end
                                                end
                                                resi=find(SQ(idxk(index),:)==minip);
                                                mclusters(j)=idxk(index);
                                                minip=100000.0;
                                                j=j+1;
                                            else
                                                mindist=min(SQ(idxk,:));
                                                resi=find(SQ(idxk,:)==mindist);
                                                mclusters(j)=idxk;
                                                j=j+1;
                                            end
                                            
                                            if length(NP(:,1))==idxk
                                                break;
                                            end
                                            
                                            SQ(idxk,:)=100000;
                                            SQ(:,resi)=100000;
                                            
                                            if idxk==1
                                                SQ(:,idxk)=100000;
                                            end
                                            
                                            curr=resi;
                                            idxk=curr;
                                        end
                                        
                                        f=mclusters~=0;
                                        tempc=mclusters(f);
                                        clear mclusters;
                                        mclusters=tempc;
                                        clear tempc;
                                        
                                        temp=Mdist(mclusters(2:length(mclusters)-1),:);
                                        for x=1:length(clid)
                                            for m=1:length(temp(:,1))
                                                netsections=vertcat(netsections,[clid(x),temp(m,1),temp(m,2),0,0]);
                                            end
                                        end
                                    end
                                end
                                for n=1:length(rch)
                                    cluster_to_tr(rch(n),4)=max(p1,p2);
                                    cluster_to_tr(rch(n),5)=max(p3,p4);
                                end
                            else
                                ndegrees=rad2deg(angle2Points([centre_pts(c7,1) centre_pts(c7,2)], [centre_pts(memf,1) centre_pts(memf,2)]));
                                
                                x1=centre_pts(c7,1)+dd;
                                y1=centre_pts(c7,2)+dd;
                                x2=centre_pts(c7,1)+dd;
                                y2=centre_pts(c7,2)-dd;
                                x3=centre_pts(c7,1)-dd;
                                y3=centre_pts(c7,2)+dd;
                                x4=centre_pts(c7,1)-dd;
                                y4=centre_pts(c7,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                in = createLine([centre_pts(c7,1) centre_pts(c7,2)],[centre_pts(memf,1) centre_pts(memf,2)]);
                                e1 =orthogonalLine(in, [centre_pts(c7,1) centre_pts(c7,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], 0);
                                tr2 = createRotation([centre_pts(c7,1) centre_pts(c7,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(c7,1)&elk(rss(h),2)~=centre_pts(c7,2)&elk(rss(h),3)~=centre_pts(c7,1)&elk(rss(h),4)~=centre_pts(c7,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    
                                    rv=find(vpts(:,1)==centre_pts(c7,1)&vpts(:,2)==centre_pts(c7,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(c7,1) centre_pts(c7,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p1=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(c7,1) centre_pts(c7,2)], aa, 2)<=dd
                                            centre_pts(c7,1)=aa(1,1);
                                            centre_pts(c7,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(c7,1) centre_pts(c7,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p3=max(SQ(1,:));
                                            centre_pts(c7,8)=p3;
                                            
                                            sequence(r1,1)=aa(1,1);
                                            sequence(r1,2)=aa(1,2);
                                            
                                        end
                                    end
                                end
                                
                                x1=centre_pts(memf,1)+dd;
                                y1=centre_pts(memf,2)+dd;
                                x2=centre_pts(memf,1)+dd;
                                y2=centre_pts(memf,2)-dd;
                                x3=centre_pts(memf,1)-dd;
                                y3=centre_pts(memf,2)+dd;
                                x4=centre_pts(memf,1)-dd;
                                y4=centre_pts(memf,2)-dd;
                                
                                x=[x1 x2 x3 x4];
                                x=vertcat(x,[y1 y2 y3 y4]);
                                mb=minBoundingBox(x);
                                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                                
                                in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                                in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                                
                                rs1=find(in1==1);
                                rs2=find(in2==1);
                                rss=union(rs1,rs2,'rows');
                                
                                e1 =orthogonalLine(in, [centre_pts(memf,1) centre_pts(memf,2)]);
                                ce1=createEdge(e1,dd);
                                tr1 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], 0);
                                tr2 = createRotation([centre_pts(memf,1) centre_pts(memf,2)], pi);
                                dest1 = transformEdge(ce1,tr1);
                                dest2 = transformEdge(ce1,tr2);
                                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                                
                                vpts=[];
                                for h=1:length(rss)
                                    if elk(rss(h),1)~=centre_pts(memf,1)&elk(rss(h),2)~=centre_pts(memf,2)&elk(rss(h),3)~=centre_pts(memf,1)&elk(rss(h),4)~=centre_pts(memf,2)
                                        e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                        point = intersectEdges(ce1, e2);
                                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                            vpts=vertcat(vpts,point);
                                        end
                                    end
                                end
                                
                                if ~isempty(vpts)
                                    rv=find(vpts(:,1)==centre_pts(memf,1)&vpts(:,2)==centre_pts(memf,2));
                                    if isempty(rv)
                                        vpts=vertcat(vpts,[centre_pts(memf,1) centre_pts(memf,2)]);
                                    end
                                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                                    p2=length(vpts(:,1));
                                    
                                    if length(vpts(:,1))>1
                                        aa=centroid(vpts);
                                        if distancePoints([centre_pts(memf,1) centre_pts(memf,2)], aa, 2)<=dd
                                            centre_pts(memf,1)=aa(1,1);
                                            centre_pts(memf,2)=aa(1,2);
                                            
                                            mb=vpts;
                                            mb=unique(vpts,'rows');
                                            pd=[centre_pts(memf,1) centre_pts(memf,2)];
                                            pd=vertcat(pd,mb);
                                            
                                            Y = pdist(pd,'euclid');
                                            SQ=squareform(Y);
                                            p4=max(SQ(1,:));
                                            centre_pts(memf,8)=p4;
                                            
                                            sequence(r2,1)=aa(1,1);
                                            sequence(r2,2)=aa(1,2);
                                            
                                        end
                                    end
                                end
                                for n=1:length(rch)
                                    cluster_to_tr(rch(n),4)=max(p1,p2);
                                    cluster_to_tr(rch(n),5)=max(p3,p4);
                                end
                            end
                        end
                    end
                end
                
                if ~isempty(nxtfl)
                    for v=1:length(nxtfl)
                        dx=sqrt((centre_pts(memf,1)-centre_pts(nxtfl(v),1))^2+(centre_pts(memf,2)-centre_pts(nxtfl(v),2))^2);
                        if dx<=100
                            rch=find(cluster_to_tr(:,1)==centre_pts(memf,3) & cluster_to_tr(:,2)==centre_pts(nxtfl(v),3));
                            if isempty(rch)
                                if centre_pts(memf,3)~=centre_pts(nxtfl(v),3)
                                    clid=(max(netnodes(:,1))+1);
                                    cluster_to_tr=vertcat(cluster_to_tr,[centre_pts(memf,3),centre_pts(nxtfl(v),3), clid, round((centre_pts(memf,9)+centre_pts(nxtfl(v),9))/2), round((centre_pts(memf,8)+centre_pts(nxtfl(v),8))/2), distancePoints([centre_pts(memf,1) centre_pts(memf,2)], [centre_pts(nxtfl(v),1) centre_pts(nxtfl(v),2)], 2)]);
                                    if ~isempty(drc)
                                        dir=find(drc(:,1)==centre_pts(memf,3)|drc(:,1)==centre_pts(nxtfl(v),3));
                                    end
                                    if ~isempty(dir)
                                        netnodes=vertcat(netnodes,[clid,w,0,2,1,0,0,0]);
                                    else
                                        netnodes=vertcat(netnodes,[clid,w,0,1,1,0,0,0]);
                                    end
                                end
                            end
                        end
                    end
                end
                
                rr=find(cluster_to_tr(:,1)==centre_pts(c1,3)&cluster_to_tr(:,2)==centre_pts(c2,3));
                if ~isempty(rr)
                    cluster_to_tr(rr,:)=[];
                end
                
                if ~isempty(res)
                    r=find(netsections(:,1)==netnodes(k,1));
                    r=unique(r);
                    h=length(r);
                    while h>=1
                        netsections(r(h),:)=[];
                        h=h-1;
                    end
                end
                
            else
                p1=0;
                p2=0;
                p3=0;
                p4=0;
                
                
                dd=round((centre_pts(c1,8)+centre_pts(c2,8))/2);
                
                if dd<1
                    dd=15;
                end
                
                if ~isempty(res)
                    for v=1:length(res)
                        if v==1
                            ndegrees=rad2deg(angle2Points([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]));
                            
                            x1=centre_pts(c1,1)+dd;
                            y1=centre_pts(c1,2)+dd;
                            x2=centre_pts(c1,1)+dd;
                            y2=centre_pts(c1,2)-dd;
                            x3=centre_pts(c1,1)-dd;
                            y3=centre_pts(c1,2)+dd;
                            x4=centre_pts(c1,1)-dd;
                            y4=centre_pts(c1,2)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]);
                            e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                            tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==centre_pts(c1,1)&pts(:,2)==centre_pts(c1,2));
                                if isempty(rv)
                                    pts=vertcat(pts,[centre_pts(c1,1) centre_pts(c1,2)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                p1=length(pts(:,1));
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                        centre_pts(c1,1)=aa(1,1);
                                        centre_pts(c1,2)=aa(1,2);
                                        
                                        mb=pts;
                                        mb=unique(pts,'rows');
                                        pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                        pd=vertcat(pd,mb);
                                        
                                        Y = pdist(pd,'euclid');
                                        SQ=squareform(Y);
                                        p3=max(SQ(1,:));
                                        centre_pts(c1,8)=p3;
                                    end
                                end
                            end
                            
                            x1=netsections(res(1),2)+dd;
                            y1=netsections(res(1),3)+dd;
                            x2=netsections(res(1),2)+dd;
                            y2=netsections(res(1),3)-dd;
                            x3=netsections(res(1),2)-dd;
                            y3=netsections(res(1),3)+dd;
                            x4=netsections(res(1),2)-dd;
                            y4=netsections(res(1),3)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            ndegrees=rad2deg(angle2Points([centre_pts(c1,1),centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]));
                            in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[netsections(res(1),2) netsections(res(1),3)]);
                            
                            e1 =orthogonalLine(in, [netsections(res(1),2) netsections(res(1),3)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([netsections(res(1),2) netsections(res(1),3)], 0);
                            tr2 = createRotation([netsections(res(1),2) netsections(res(1),3)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=netsections(res(1),2)&elk(rss(h),2)~=netsections(res(1),3)&elk(rss(h),3)~=netsections(res(1),2)&elk(rss(h),4)~=netsections(res(1),3)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==netsections(res(1),2)&pts(:,2)==netsections(res(1),3));
                                if isempty(rv)
                                    pts=vertcat(pts,[netsections(res(1),2) netsections(res(1),3)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([netsections(res(1),2) netsections(res(1),3)], aa, 2)<=dd
                                        netsections(res(1),2)=aa(1,1);
                                        netsections(res(1),3)=aa(1,2);
                                    end
                                    
                                end
                            end
                        end
                        if v==length(res)
                            ndegrees=rad2deg(angle2Points([netsections(res(length(res)),2) netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]));
                            
                            x1=centre_pts(c2,1)+dd;
                            y1=centre_pts(c2,2)+dd;
                            x2=centre_pts(c2,1)+dd;
                            y2=centre_pts(c2,2)-dd;
                            x3=centre_pts(c2,1)-dd;
                            y3=centre_pts(c2,2)+dd;
                            x4=centre_pts(c2,1)-dd;
                            y4=centre_pts(c2,2)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            
                            in = createLine([netsections(res(length(res)),2) netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                            e1 =orthogonalLine(in, [centre_pts(c2,1),centre_pts(c2,2)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([centre_pts(c2,1),centre_pts(c2,2)], 0);
                            tr2 = createRotation([centre_pts(c2,1),centre_pts(c2,2)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=centre_pts(c2,1)&elk(rss(h),2)~=centre_pts(c2,2)&elk(rss(h),3)~=centre_pts(c2,1)&elk(rss(h),4)~=centre_pts(c2,2)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==centre_pts(c2,1)&pts(:,2)==centre_pts(c2,2));
                                if isempty(rv)
                                    pts=vertcat(pts,[centre_pts(c2,1) centre_pts(c2,2)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                p2=length(pts(:,1));
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([centre_pts(c2,1) centre_pts(c2,2)], aa, 2)<=dd
                                        centre_pts(c2,1)=aa(1,1);
                                        centre_pts(c2,2)=aa(1,2);
                                        
                                        mb=pts;
                                        mb=unique(pts,'rows');
                                        pd=[centre_pts(c2,1) centre_pts(c2,2)];
                                        pd=vertcat(pd,mb);
                                        
                                        Y = pdist(pd,'euclid');
                                        SQ=squareform(Y);
                                        p4=max(SQ(1,:));
                                        centre_pts(c2,8)=p4;
                                    end
                                end
                            end
                            
                            
                            x1=netsections(res(length(res)),2)+dd;
                            y1=netsections(res(length(res)),3)+dd;
                            x2=netsections(res(length(res)),2)+dd;
                            y2=netsections(res(length(res)),3)-dd;
                            x3=netsections(res(length(res)),2)-dd;
                            y3=netsections(res(length(res)),3)+dd;
                            x4=netsections(res(length(res)),2)-dd;
                            y4=netsections(res(length(res)),3)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            in = createLine([netsections(res(length(res)),2) netsections(res(length(res)),3)],[centre_pts(c2,1),centre_pts(c2,2)]);
                            e1 =orthogonalLine(in, [netsections(res(length(res)),2) netsections(res(length(res)),3)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([netsections(res(length(res)),2) netsections(res(length(res)),3)], 0);
                            tr2 = createRotation([netsections(res(length(res)),2) netsections(res(length(res)),3)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=netsections(res(length(res)),2)&elk(rss(h),2)~=netsections(res(length(res)),3)&elk(rss(h),3)~=netsections(res(length(res)),2)&elk(rss(h),4)~=netsections(res(length(res)),3)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            if ~isempty(pts)
                                rv=find(pts(:,1)==netsections(res(length(res)),2)&pts(:,2)==netsections(res(length(res)),3));
                                if isempty(rv)
                                    pts=vertcat(pts,[netsections(res(length(res)),2) netsections(res(length(res)),3)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([netsections(res(length(res)),2) netsections(res(length(res)),3)], aa, 2)<=dd
                                        netsections(res(length(res)),2)=aa(1,1);
                                        netsections(res(length(res)),3)=aa(1,2);
                                    end
                                end
                            end
                        end
                        if v<length(res)
                            ndegrees=rad2deg(angle2Points([netsections(res(v),2) netsections(res(v),3)],[netsections(res(v+1),2) netsections(res(v+1),3)]));
                            x1=netsections(res(v),2)+dd;
                            y1=netsections(res(v),3)+dd;
                            x2=netsections(res(v),2)+dd;
                            y2=netsections(res(v),3)-dd;
                            x3=netsections(res(v),2)-dd;
                            y3=netsections(res(v),3)+dd;
                            x4=netsections(res(v),2)-dd;
                            y4=netsections(res(v),3)-dd;
                            
                            x=[x1 x2 x3 x4];
                            x=vertcat(x,[y1 y2 y3 y4]);
                            mb=minBoundingBox(x);
                            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                            
                            in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                            in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                            
                            rs1=find(in1==1);
                            rs2=find(in2==1);
                            rss=union(rs1,rs2,'rows');
                            
                            in = createLine([netsections(res(v),2) netsections(res(v),3)],[netsections(res(v+1),2) netsections(res(v+1),3)]);
                            e1 =orthogonalLine(in, [netsections(res(v),2) netsections(res(v),3)]);
                            ce1=createEdge(e1,dd);
                            tr1 = createRotation([netsections(res(v),2) netsections(res(v),3)], 0);
                            tr2 = createRotation([netsections(res(v),2) netsections(res(v),3)], pi);
                            dest1 = transformEdge(ce1,tr1);
                            dest2 = transformEdge(ce1,tr2);
                            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                            
                            pts=[];
                            for h=1:length(rss)
                                if elk(rss(h),1)~=netsections(res(v),2)&elk(rss(h),2)~=netsections(res(v),3)&elk(rss(h),3)~=netsections(res(v),2)&elk(rss(h),4)~=netsections(res(v),3)
                                    e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                                    point = intersectEdges(ce1, e2);
                                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                        pts=vertcat(vpts,point);
                                    end
                                end
                            end
                            
                            
                            if ~isempty(pts)
                                
                                rv=find(pts(:,1)==netsections(res(v),2)&pts(:,2)==netsections(res(v),3));
                                if isempty(rv)
                                    pts=vertcat(pts,[netsections(res(v),2) netsections(res(v),3)]);
                                end
                                pts=unique([pts(:,1) pts(:,2)],'rows');
                                
                                
                                if length(pts(:,1))>1
                                    aa=centroid(pts);
                                    if distancePoints([netsections(res(v),2) netsections(res(v),3)], aa, 2)<=dd
                                        netsections(res(v),2)=aa(1,1);
                                        netsections(res(v),3)=aa(1,2);
                                    end
                                end
                            end
                        end
                    end
                else
                    ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]));
                    
                    x1=centre_pts(c1,1)+dd;
                    y1=centre_pts(c1,2)+dd;
                    x2=centre_pts(c1,1)+dd;
                    y2=centre_pts(c1,2)-dd;
                    x3=centre_pts(c1,1)-dd;
                    y3=centre_pts(c1,2)+dd;
                    x4=centre_pts(c1,1)-dd;
                    y4=centre_pts(c1,2)-dd;
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                    
                    rs1=find(in1==1);
                    rs2=find(in2==1);
                    rss=union(rs1,rs2,'rows');
                    
                    in = createLine([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]);
                    e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                    ce1=createEdge(e1,dd);
                    tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                    tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                    dest1 = transformEdge(ce1,tr1);
                    dest2 = transformEdge(ce1,tr2);
                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                    
                    vpts=[];
                    for h=1:length(rss)
                        if elk(rss(h),1)~=centre_pts(c1,1)&elk(rss(h),2)~=centre_pts(c1,2)&elk(rss(h),3)~=centre_pts(c1,1)&elk(rss(h),4)~=centre_pts(c1,2)
                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                            point = intersectEdges(ce1, e2);
                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                vpts=vertcat(vpts,point);
                            end
                        end
                    end
                    
                    
                    if ~isempty(vpts)
                        
                        rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                        if isempty(rv)
                            vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                        end
                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                        p1=length(vpts(:,1));
                        
                        if length(vpts(:,1))>1
                            aa=centroid(vpts);
                            if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                                centre_pts(c1,1)=aa(1,1);
                                centre_pts(c1,2)=aa(1,2);
                                
                                mb=vpts;
                                mb=unique(vpts,'rows');
                                pd=[centre_pts(c1,1) centre_pts(c1,2)];
                                pd=vertcat(pd,mb);
                                
                                Y = pdist(pd,'euclid');
                                SQ=squareform(Y);
                                p3=max(SQ(1,:));
                                centre_pts(c1,8)=p3;
                            end
                        end
                    end
                    
                    
                    x1=centre_pts(c2,1)+dd;
                    y1=centre_pts(c2,2)+dd;
                    x2=centre_pts(c2,1)+dd;
                    y2=centre_pts(c2,2)-dd;
                    x3=centre_pts(c2,1)-dd;
                    y3=centre_pts(c2,2)+dd;
                    x4=centre_pts(c2,1)-dd;
                    y4=centre_pts(c2,2)-dd;
                    
                    x=[x1 x2 x3 x4];
                    x=vertcat(x,[y1 y2 y3 y4]);
                    mb=minBoundingBox(x);
                    mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                    
                    in1 = inpolygon(elk(:,1), elk(:,2),mb(1,:), mb(2,:));
                    in2 = inpolygon(elk(:,3), elk(:,4),mb(1,:), mb(2,:));
                    
                    rs1=find(in1==1);
                    rs2=find(in2==1);
                    rss=union(rs1,rs2,'rows');
                    
                    e1 =orthogonalLine(in, [centre_pts(c2,1) centre_pts(c2,2)]);
                    ce1=createEdge(e1,dd);
                    tr1 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], 0);
                    tr2 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], pi);
                    dest1 = transformEdge(ce1,tr1);
                    dest2 = transformEdge(ce1,tr2);
                    ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                    
                    vpts=[];
                    for h=1:length(rss)
                        if elk(rss(h),1)~=centre_pts(c2,1)&elk(rss(h),2)~=centre_pts(c2,2)&elk(rss(h),3)~=centre_pts(c2,1)&elk(rss(h),4)~=centre_pts(c2,2)
                            e2 = createEdge([elk(rss(h),1) elk(rss(h),2)], [elk(rss(h),3) elk(rss(h),4)]);
                            point = intersectEdges(ce1, e2);
                            if ~isnan(point(1,1)) && ~isinf(point(1,1))
                                vpts=vertcat(vpts,point);
                            end
                        end
                    end
                    
                    if ~isempty(vpts)
                        rv=find(vpts(:,1)==centre_pts(c2,1)&vpts(:,2)==centre_pts(c2,2));
                        if isempty(rv)
                            vpts=vertcat(vpts,[centre_pts(c2,1) centre_pts(c2,2)]);
                        end
                        vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                        p2=length(vpts(:,1));
                        
                        if length(vpts(:,1))>1
                            aa=centroid(vpts);
                            if distancePoints([centre_pts(c2,1) centre_pts(c2,2)], aa, 2)<=dd
                                centre_pts(c2,1)=aa(1,1);
                                centre_pts(c2,2)=aa(1,2);
                                
                                mb=vpts;
                                mb=unique(vpts,'rows');
                                pd=[centre_pts(c2,1) centre_pts(c2,2)];
                                pd=vertcat(pd,mb);
                                
                                Y = pdist(pd,'euclid');
                                SQ=squareform(Y);
                                p4=max(SQ(1,:));
                                centre_pts(c2,8)=p4;
                            end
                        end
                    end
                    
                    cluster_to_tr(sres,4)=max(p1,p2);
                    cluster_to_tr(sres,5)=max(p3,p4);
                end
            end
        end
        k=k+1;
    end
    
    
    if scounter>=1&&scounter<=20
        temp_centre_pts=sortrows(centre_pts,-8);
        centre_pts=temp_centre_pts;
        
        g=1;
        while g<=length(centre_pts(:,1))
            
            p1=0;
            if centre_pts(g,8)~=0
                if centre_pts(g,8)>1
                    p1=centre_pts(g,8);
                else
                    p1=15;
                end
            else
                p1=15;
            end
            
            x1=centre_pts(g,1)+p1;
            y1=centre_pts(g,2)+p1;
            x2=centre_pts(g,1)+p1;
            y2=centre_pts(g,2)-p1;
            x3=centre_pts(g,1)-p1;
            y3=centre_pts(g,2)+p1;
            x4=centre_pts(g,1)-p1;
            y4=centre_pts(g,2)-p1;
            
            x=[x1 x2 x3 x4];
            x=vertcat(x,[y1 y2 y3 y4]);
            mb=minBoundingBox(x);
            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
            
            in = inpolygon(centre_pts(:,1), centre_pts(:,2),mb(1,:), mb(2,:));
            rs=find(in==1);
            rc=find(centre_pts(rs,3)~=centre_pts(g,3));
            rs=rs(rc);
            
            xy=[centre_pts(g,1) centre_pts(g,2)];
            for l=1:length(rs)
                xy=vertcat(xy,[centre_pts(rs(l),1), centre_pts(rs(l),2)]);
            end
            
            if length(xy(:,1))>1
                
                aa=centroid(xy);
                
                centre_pts(g,1) = aa(1,1);
                centre_pts(g,2) = aa(1,2);
                
                merged=[];
                if length(rs)>=1
                    for m=1:length(rs)
                        merged=vertcat(merged,centre_pts(rs(m),3));
                    end
                end
                
                if ~isempty(merged)
                    keptid=centre_pts(g,3);
                    for m=1:length(merged(:,1))
                        rc=find(centre_pts(:,3)==merged(m,1));
                        centre_pts(rc,:)=0;
                    end
                    
                    for m=1:length(merged(:,1))
                        res=find(cluster_to_tr(:,1)==merged(m,1));
                        if ~isempty(res)
                            cluster_to_tr(res,1)=keptid;
                        end
                        
                        res=find(cluster_to_tr(:,2)==merged(m,1));
                        if ~isempty(res)
                            cluster_to_tr(res,2)=keptid;
                        end
                        
                        resp1=find(pts_ln.pts_ln(:,14)==merged(m,1));
                        resp2=find(pts_ln.pts_ln(:,15)==merged(m,1));
                        if ~isempty(resp1)
                            pts_ln.pts_ln(resp1,14)=keptid;
                        end
                        if ~isempty(resp2)
                            pts_ln.pts_ln(resp2,15)=keptid;
                        end
                    end
                    
                    mres= (centre_pts(:,1)~=0);
                    newcentre_pts=centre_pts(mres,:);
                    clear centre_pts;
                    centre_pts=newcentre_pts;
                    clear newcentre_pts;
                end
            end
            g=g+1;
        end
    end
    
    % merge opposite sites
    % ndegrees
    for g=1:length(netnodes(:,1))
        res=find(netsections(:,1)==netnodes(g,1));
        sres=find(cluster_to_tr(:,3)==netnodes(g,1));
        if ~isempty(res) && ~isempty(sres)
            
            resc1=find(centre_pts(:,3)==cluster_to_tr(sres,1));
            resc2=find(centre_pts(:,3)==cluster_to_tr(sres,2));
            
            st(1,1)=centre_pts(resc1,1);
            st(1,2)=centre_pts(resc1,2);
            en(1,1)=centre_pts(resc2,1);
            en(1,2)=centre_pts(resc2,2);
            
            mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(1),2), netsections(res(1),3)]));
            netsections(res(1),4)=mdegrees1;
            if length(res)>1
                for m=1:(length(res)-1)
                    if m==1 % outgoing direction
                        mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                        if length(res)>1
                            mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                            netsections(res(m),5)=mdegrees2;
                        else
                            mdegrees2=rad2deg(angle2Points([netsections(res(m),2),netsections(res(m),3)],[en(1,1), en(1,2)]));
                            netsections(res(m),5)=mdegrees2;
                        end
                    end
                    if m==(length(res)-1)
                        if m>1
                            mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                            netsections(res(m),4)=mdegrees1;
                        else
                            mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                            netsections(res(m),4)=mdegrees1;
                        end
                        
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                        netsections(res(m),5)=mdegrees2;
                        
                        mdegrees1=mdegrees2;
                        netsections(res(m+1),4)=mdegrees1;
                    end
                    if m<length(res)&&m>1
                        mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                        netsections(res(m),5)=mdegrees2;
                    end
                end
            end
            mdegrees2=rad2deg(angle2Points([netsections(res(length(res)),2),netsections(res(length(res)),3)],[en(1,1), en(1,2)]));
            netsections(res(length(res)),5)=mdegrees2;
        end
    end
    
    ntoremove=[];
    nchecked=[];
    tnetnodes=netnodes;
    tcluster_to_tr=cluster_to_tr;
    for i=1:length(netnodes(:,1))
        r=find(cluster_to_tr(:,3)==netnodes(i,1));
        if ~isempty(r)
            r1=find(cluster_to_tr(:,1)==cluster_to_tr(r,2) & cluster_to_tr(:,2)==cluster_to_tr(r,1));
            if ~isempty(r1)
                netnodes(r,3)=2;
                rc=find(nchecked==cluster_to_tr(r,3));
                if isempty(rc)
                    for h=1:length(r1)
                        nchecked=vertcat(nchecked,[cluster_to_tr(r,3), cluster_to_tr(r1(h),3)]);
                        rn=find(netnodes(:,1)==cluster_to_tr(r1(h),3));
                        if ~isempty(rn)
                            ntoremove=vertcat(ntoremove,cluster_to_tr(r1(h),3));
                        end
                    end
                end
            end
        end
    end
    
    if ~isempty(nchecked)
        for i=1:length(nchecked(:,1))
            nn1=find(netsections(:,1)==nchecked(i,1));
            nn2=find(netsections(:,1)==nchecked(i,2));
            r=find(cluster_to_tr(:,3)==nchecked(i,1));
            c1=find(centre_pts(:,3)==cluster_to_tr(r,1));
            c2=find(centre_pts(:,3)==cluster_to_tr(r,2));
            respts=[];
            memid=nchecked(i,1);
            dids=[];
            if ~isempty(nn1)
                respts=vertcat(respts, [netsections(nn1,2) netsections(nn1,3) netsections(nn1,4)]);
                dids=vertcat(dids,nn1);
            end
            
            if ~isempty(nn2)
                respts=vertcat(respts, [netsections(nn2,2) netsections(nn2,3) netsections(nn2,4)]);
                dids=vertcat(dids,nn2);
            end
            
            rrespts=respts;
            
            if ~isempty(dids)
                dids=unique(dids);
                h=length(dids);
                while h>=1
                    netsections(dids(h),:)=[];
                    h=h-1;
                end
            end
            
            if ~isempty(respts)
                respts=unique([respts(:,1) respts(:,2)], 'rows');
                
                pts=respts;
                
                circle = [[centre_pts(c1,1) centre_pts(c1,2)] 10];
                idx=[];
                for l=1:length(pts(:,1))
                    if isPointInCircle([pts(l,1), pts(l,2)], circle)
                        idx=vertcat(idx,l);
                    end
                end
                pts(idx,:)=[];
                
                circle = [[centre_pts(c2,1) centre_pts(c2,2)] 10];
                idx=[];
                for l=1:length(pts(:,1))
                    if isPointInCircle([pts(l,1), pts(l,2)], circle)
                        idx=vertcat(idx,l);
                    end
                end
                pts(idx,:)=[];
                
                pseq=[];
                
                if ~isempty(pts)
                    cl=[];
                    for b=1:length(pts(:,1))
                        inr = find(elk(:,1)==pts(b,1)&elk(:,2)==pts(b,2)|elk(:,3)==pts(b,1)&elk(:,4)==pts(b,2));
                        if ~isempty(inr)
                            cl=vertcat(cl,inr);
                        end
                        if b==1
                            inr = find(elk(:,1)==centre_pts(c1,1)&elk(:,2)==centre_pts(c1,2)|elk(:,3)==centre_pts(c1,1)&elk(:,4)==centre_pts(c1,2));
                            if ~isempty(inr)
                                cl=vertcat(cl,inr);
                            end
                            inr = find(elk(:,1)==centre_pts(c2,1)&elk(:,2)==centre_pts(c2,2)|elk(:,3)==centre_pts(c2,1)&elk(:,4)==centre_pts(c2,2));
                            if ~isempty(inr)
                                cl=vertcat(cl,inr);
                            end
                        end
                    end
                    
                    cl=unique(cl,'rows');
                    
                    for b=1:length(pts(:,1))
                        rb=find(rrespts(:,1)==pts(b,1)&rrespts(:,2)==pts(b,2));
                        ndegrees=max(rrespts(rb,3));
                        
                        x1=pts(b,1)+(45)*cosd(ndegrees-90);
                        y1=pts(b,2)+(45)*sind(ndegrees-90);
                        x2=pts(b,1)+(45)*cosd(ndegrees+90);
                        y2=pts(b,2)+(45)*sind(ndegrees+90);
                        e1 = createEdge([x1 y1], [x2 y2]);
                        
                        vpts=[];
                        for h=1:length(cl)
                            if elk(cl(h),1)~=pts(b,1)&elk(cl(h),2)~=pts(b,2)&elk(cl(h),3)~=pts(b,1)&elk(cl(h),4)~=pts(b,2)
                                e2 = createEdge([elk(cl(h),1) elk(cl(h),2)], [elk(cl(h),3) elk(cl(h),4)]);
                                point = intersectEdges(e1, e2);
                                if ~isnan(point(1,1)) && ~isinf(point(1,1)) && (abs(ndegrees-rad2deg(angle2Points([elk(cl(h),1) elk(cl(h),2)], [elk(cl(h),3) elk(cl(h),4)])))<=20||abs(ndegrees-rad2deg(angle2Points([elk(cl(h),1) elk(cl(h),2)], [elk(cl(h),3) elk(cl(h),4)])))>=340||abs(ndegrees-rad2deg(angle2Points([elk(cl(h),1) elk(cl(h),2)], [elk(cl(h),3) elk(cl(h),4)])))>=160&&abs(ndegrees-rad2deg(angle2Points([elk(cl(h),1) elk(cl(h),2)], [elk(cl(h),3) elk(cl(h),4)])))<=200)
                                    vpts=vertcat(vpts,point);
                                end
                            end
                        end
                        
                        if ~isempty(vpts)
                            rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                            if isempty(rv)
                                vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                            end
                            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                            
                            if length(vpts(:,1))>1
                                aa=centroid(vpts);
                                pts(b,1)=aa(1,1);
                                pts(b,2)=aa(1,2);
                            end
                        end
                    end
                end
                
                pseq=pts;
                if ~isempty(pseq)
                    NP=[centre_pts(c1,1) centre_pts(c1,2)];
                    [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
                    NP=vertcat(NP, MP);
                    NP=vertcat(NP, [centre_pts(c2,1) centre_pts(c2,2)]);
                    Mdist=[NP(:,1) NP(:,2)];
                    Y = pdist(Mdist,'euclid');
                    SQ=squareform(Y);
                    mclusters=zeros(length(Mdist), 1);
                    Mdist(:,3)=1;
                    for k=1:length(SQ(:,:))
                        SQ(k,k)=100000.0;
                    end
                    
                    %finding sequence of point cloud
                    j=1;
                    idxk=1;
                    minip=100000.0;
                    while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                        if length(idxk)>1
                            index=0;
                            for h=1:length(idxk)
                                mindist=min(SQ(idxk(h),:));
                                if mindist<=minip
                                    minip=mindist;
                                    index=h;
                                end
                            end
                            resi=find(SQ(idxk(index),:)==minip);
                            mclusters(j)=idxk(index);
                            minip=100000.0;
                            j=j+1;
                        else
                            mindist=min(SQ(idxk,:));
                            resi=find(SQ(idxk,:)==mindist);
                            mclusters(j)=idxk;
                            j=j+1;
                        end
                        
                        if length(NP(:,1))==idxk
                            break;
                        end
                        
                        SQ(idxk,:)=100000;
                        SQ(:,resi)=100000;
                        
                        if idxk==1
                            SQ(:,idxk)=100000;
                        end
                        
                        curr=resi;
                        idxk=curr;
                    end
                    
                    f=mclusters~=0;
                    tempc=mclusters(f);
                    clear mclusters;
                    mclusters=tempc;
                    clear tempc;
                    
                    temp=Mdist(mclusters(2:length(mclusters)-1),:);
                    ppseq=temp;
                    
                    if ~isempty(ppseq)
                        for h=1:length(ppseq(:,1))
                            netsections=vertcat(netsections,[memid ppseq(h,1) ppseq(h,2) 0 0]);
                            
                        end
                    end
                    
                    
                end
            end
        end
    end
    
    if~isempty(ntoremove)
        for i=1:length(ntoremove)
            r=find(netnodes(:,1)==ntoremove(i));
            if ~isempty(r)
                netnodes(r,:)=[];
            end
            r=find(cluster_to_tr(:,3)==ntoremove(i));
            if ~isempty(r)
                cluster_to_tr(r,:)=[];
            end
        end
    end
    
    % clean the same starting and ending nodes
    ntoremove=[];
    nid=1;
    
    for i=1:length(netnodes(:,1))
        r=find(cluster_to_tr(:,3)==netnodes(i,1));
        if cluster_to_tr(r,1)==cluster_to_tr(r,2)
            ntoremove(nid)=netnodes(i,1);
            nid=nid+1;
        end
    end
    
    for i=1:length(ntoremove)
        r=find(netnodes(:,1)==ntoremove(i));
        if ~isempty(r)
            netnodes(r,:)=[];
        end
        r=find(cluster_to_tr(:,3)==ntoremove(i));
        if ~isempty(r)
            cluster_to_tr(r,:)=[];
        end
        r=find(netsections(:,1)==ntoremove(i));
        r=unique(r);
        h=length(r);
        while h>=1
            netsections(r(h),:)=[];
            h=h-1;
        end
    end
    
    tt=cluster_to_tr;
    [Ys id]=unique([cluster_to_tr(:,1) cluster_to_tr(:,2)],'rows','first');
    [Ys ii] = setdiff(Ys(:,:),[0 0], 'rows');
    clcluster=[cluster_to_tr(id(ii),1) cluster_to_tr(id(ii),2) cluster_to_tr(id(ii),3) cluster_to_tr(id(ii),4) cluster_to_tr(id(ii),5) cluster_to_tr(id(ii),6)] ;
    clear cluster_to_tr;
    cluster_to_tr = [clcluster(:,1) clcluster(:,2) clcluster(:,3) clcluster(:,4) clcluster(:,5) clcluster(:,6)] ;
    clear clcluster;
    
    % merge and remove the same
    for i=1:length(cluster_to_tr(:,1))
        r=find(tt(:,1)==cluster_to_tr(i,1) & tt(:,2)==cluster_to_tr(i,2));
        r1=find(netnodes(:,1)==cluster_to_tr(i,3));
        if length(r)>1
            netnodes(r1,2)=netnodes(r1,2)+length(r);
        end
        memid=cluster_to_tr(i,3);
        c1=find(centre_pts(:,3)==cluster_to_tr(i,1));
        c2=find(centre_pts(:,3)==cluster_to_tr(i,2));
        
        respts=[];
        
        for k=1:length(r)
            n1=find(netsections(:,1)==tt(r(k),3));
            respts=vertcat(respts, [netsections(n1,2) netsections(n1,3)]);
            netsections(n1,:)=[];
        end
        
        respts=unique(respts, 'rows');
        NP=[centre_pts(c1,1) centre_pts(c1,2)];
        NP=vertcat(NP, [respts(:,1) respts(:,2)]);
        NP=vertcat(NP, [centre_pts(c2,1) centre_pts(c2,2)]);
        Mdist=[NP(:,1) NP(:,2)];
        Y = pdist(Mdist,'euclid');
        SQ=squareform(Y);
        mclusters=zeros(length(Mdist), 1);
        
        Mdist(:,3)=1;
        for k=1:length(SQ(:,:))
            SQ(k,k)=100000.0;
        end
        
        %finding sequence of point cloud
        j=1;
        idxk=1;
        minip=100000.0;
        while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
            if length(idxk)>1
                index=0;
                for g=1:length(idxk)
                    mindist=min(SQ(idxk(g),:));
                    if mindist<=minip
                        minip=mindist;
                        index=g;
                    end
                end
                resi=find(SQ(idxk(index),:)==minip);
                mclusters(j)=idxk(index);
                minip=100000.0;
                j=j+1;
            else
                mindist=min(SQ(idxk,:));
                resi=find(SQ(idxk,:)==mindist);
                mclusters(j)=idxk;
                j=j+1;
            end
            
            if length(NP(:,1))==idxk
                break;
            end
            
            SQ(idxk,:)=100000;
            SQ(:,resi)=100000;
            
            if idxk==1
                SQ(:,idxk)=100000;
            end
            
            curr=resi;
            idxk=curr;
        end
        
        f=mclusters~=0;
        tempc=mclusters(f);
        clear mclusters;
        mclusters=tempc;
        clear tempc;
        
        clusters=zeros(length(mclusters)-2, length(mclusters)-2);
        Mdist(:,3)=1;
        temp=Mdist(mclusters(2:length(mclusters)-1),:);
        sequence=[temp(:,1) temp(:,2)];
        
        if ~isempty(sequence)
            for m=1:length(sequence(:,1))
                netsections=vertcat(netsections,[memid sequence(m,1) sequence(m,2) 0 0]);
            end
        end
    end
    
    for g=1:length(netnodes)
        r=find(cluster_to_tr(:,3)==netnodes(g,1));
        rs=find(netsections(:,1)==netnodes(g,1));
        if ~isempty(rs)&&~isempty(r)
            c1=find(centre_pts(:,3)==cluster_to_tr(r,1));
            c2=find(centre_pts(:,3)==cluster_to_tr(r,2));
            ds1=sqrt((centre_pts(c1,1)-netsections(rs(1),2))^2+(centre_pts(c1,2)-netsections(rs(1),3))^2);
            if ds1<=20
                netsections(rs(1),:)=[];
            end
        end
        rs=find(netsections(:,1)==netnodes(g,1));
        if ~isempty(rs)&&~isempty(r)
            c1=find(centre_pts(:,3)==cluster_to_tr(r,1));
            c2=find(centre_pts(:,3)==cluster_to_tr(r,2));
            ds2=sqrt((centre_pts(c2,1)-netsections(rs(length(rs)),2))^2+(centre_pts(c2,2)-netsections(rs(length(rs)),3))^2);
            if ds2<=20
                netsections(rs(length(rs)),:)=[];
            end
        end
    end
    
    % calculate ndegrees
    for g=1:length(netnodes(:,1))
        res=find(netsections(:,1)==netnodes(g,1));
        sres=find(cluster_to_tr(:,3)==netnodes(g,1));
        if ~isempty(res) && ~isempty(sres)
            
            resc1=find(centre_pts(:,3)==cluster_to_tr(sres,1));
            resc2=find(centre_pts(:,3)==cluster_to_tr(sres,2));
            
            st(1,1)=centre_pts(resc1,1);
            st(1,2)=centre_pts(resc1,2);
            en(1,1)=centre_pts(resc2,1);
            en(1,2)=centre_pts(resc2,2);
            
            mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(1),2), netsections(res(1),3)]));
            netsections(res(1),4)=mdegrees1;
            if length(res)>1
                for m=1:(length(res)-1)
                    if m==1 % outgoing direction
                        mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                        if length(res)>1
                            mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                            netsections(res(m),5)=mdegrees2;
                        else
                            mdegrees2=rad2deg(angle2Points([netsections(res(m),2),netsections(res(m),3)],[en(1,1), en(1,2)]));
                            netsections(res(m),5)=mdegrees2;
                        end
                    end
                    if m==(length(res)-1)
                        if m>1
                            mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                            netsections(res(m),4)=mdegrees1;
                        else
                            mdegrees1=rad2deg(angle2Points([st(1,1), st(1,2)],[netsections(res(m),2), netsections(res(m),3)]));
                            netsections(res(m),4)=mdegrees1;
                        end
                        
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                        netsections(res(m),5)=mdegrees2;
                        
                        mdegrees1=mdegrees2;
                        netsections(res(m+1),4)=mdegrees1;
                    end
                    if m<length(res)&&m>1
                        mdegrees1=rad2deg(angle2Points([netsections(res(m-1),2), netsections(res(m-1),3)],[netsections(res(m),2), netsections(res(m),3)]));
                        netsections(res(m),4)=mdegrees1;
                        mdegrees2=rad2deg(angle2Points([netsections(res(m),2), netsections(res(m),3)],[netsections(res(m+1),2), netsections(res(m+1),3)]));
                        netsections(res(m),5)=mdegrees2;
                    end
                end
            end
            mdegrees2=rad2deg(angle2Points([netsections(res(length(res)),2),netsections(res(length(res)),3)],[en(1,1), en(1,2)]));
            netsections(res(length(res)),5)=mdegrees2;
        end
    end
    
    toremove=[];
    rid=1;
    for q=1:length(netnodes)
        sres=find(cluster_to_tr(:,3)==netnodes(q,1));
        if isempty(sres)
            toremove(rid)=netnodes(q,1);
            rid=rid+1;
        end
    end
    
    for q=1:length(toremove)
        r=find(netnodes(:,1)==toremove(q));
        if ~isempty(r)
            netnodes(r,:)=[];
        end
    end
    
    toremove=[];
    rid=1;
    for q=1:length(cluster_to_tr(:,1))
        sres=find(netnodes(:,1)==cluster_to_tr(q,3));
        if isempty(sres)
            toremove(rid)=cluster_to_tr(q,3);
            rid=rid+1;
        end
    end
    
    for q=1:length(toremove)
        r=find(cluster_to_tr(:,3)==toremove(q));
        if ~isempty(r)
            cluster_to_tr(r,:)=[];
        end
    end
    
    toremove=[];
    rid=1;
    for q=1:length(netnodes)
        sres=find(cluster_to_tr(:,3)==netnodes(q,1));
        if isempty(sres)
            toremove(rid)=netnodes(q,1);
            rid=rid+1;
        end
    end
    
    for q=1:length(toremove)
        r=find(netnodes(:,1)==toremove(q));
        if ~isempty(r)
            netnodes(r,:)=[];
        end
    end
    
    % calculate polyline dist
    for g=1:length(cluster_to_tr(:,1))
        rx=find(netsections(:,1)==cluster_to_tr(g,3));
        rc=find(netnodes(:,1)==cluster_to_tr(g,3));
        c1=find(centre_pts(:,3)==cluster_to_tr(g,1));
        c2=find(centre_pts(:,3)==cluster_to_tr(g,2));
        d=0;
        if isempty(rx)
            xy=[centre_pts(c1,1) centre_pts(c1,2)];
            xy=vertcat(xy,[centre_pts(c2,1) centre_pts(c2,2)]);
            d = polylineLength(xy,'open');
            cluster_to_tr(g,6)=d;
            netnodes(rc,4)=d;
        else
            xy=[centre_pts(c1,1) centre_pts(c1,2)];
            xy=vertcat(xy,[netsections(rx,2) netsections(rx,3)]);
            xy=vertcat(xy,[centre_pts(c2,1) centre_pts(c2,2)]);
            d = polylineLength(xy,'open');
            cluster_to_tr(g,6)=d;
            netnodes(rc,4)=d;
        end
    end
    
    tempnet=sortrows(netnodes,-4);
    netnodes=tempnet;
    rlen=length(netnodes(:,1));
    k=1;
    
    scounter=scounter+1;
end


dd=40;

for g=1:length(cluster_to_tr(:,1))
    
    c1=find(centre_pts(:,3)==cluster_to_tr(g,1));
    c2=find(centre_pts(:,3)==cluster_to_tr(g,2));
    res=find(netsections(:,1)==cluster_to_tr(g,3));
    
    pts=[netsections(res,2) netsections(res,3)];
    if ~isempty(pts)
        
        for b=1:length(pts(:,1))
            if b==1
                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [pts(b,1) pts(b,2)]));
                
                x1=centre_pts(c1,1)+dd;
                y1=centre_pts(c1,2)+dd;
                x2=centre_pts(c1,1)+dd;
                y2=centre_pts(c1,2)-dd;
                x3=centre_pts(c1,1)-dd;
                y3=centre_pts(c1,2)+dd;
                x4=centre_pts(c1,1)-dd;
                y4=centre_pts(c1,2)-dd;
                
                x=[x1 x2 x3 x4];
                x=vertcat(x,[y1 y2 y3 y4]);
                mb=minBoundingBox(x);
                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                
                in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
                in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
                
                rs1=find(in1==1);
                rs2=find(in2==1);
                rss=union(rs1,rs2,'rows');
                
                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
                e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
                ce1=createEdge(e1,dd);
                tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
                tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
                dest1 = transformEdge(ce1,tr1);
                dest2 = transformEdge(ce1,tr2);
                
                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                
                vpts=[];
                for h=1:length(rss)
                    if slk(rss(h),1)~=centre_pts(c1,1)&slk(rss(h),2)~=centre_pts(c1,2)&slk(rss(h),3)~=centre_pts(c1,1)&slk(rss(h),4)~=centre_pts(c1,2)
                        e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                        point = intersectEdges(ce1, e2);
                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                            vpts=vertcat(vpts,point);
                        end
                    end
                end
                
                if ~isempty(vpts)
                    
                    rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
                    if isempty(rv)
                        vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
                    end
                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                    p1=length(vpts(:,1));
                    
                    if length(vpts(:,1))>1
                        aa=centroid(vpts);
                        if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                            centre_pts(c1,1)=aa(1,1);
                            centre_pts(c1,2)=aa(1,2);
                            
                            mb=vpts;
                            mb=unique(vpts,'rows');
                            pd=[centre_pts(c1,1) centre_pts(c1,2)];
                            pd=vertcat(pd,mb);
                            
                            Y = pdist(pd,'euclid');
                            SQ=squareform(Y);
                            p3=max(SQ(1,:));
                            centre_pts(c1,8)=p3;
                        end
                    end
                end
            end
            if b==length(pts(:,1))
                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c2,1) centre_pts(c2,2)]));
                
                x1=centre_pts(c2,1)+dd;
                y1=centre_pts(c2,2)+dd;
                x2=centre_pts(c2,1)+dd;
                y2=centre_pts(c2,2)-dd;
                x3=centre_pts(c2,1)-dd;
                y3=centre_pts(c2,2)+dd;
                x4=centre_pts(c2,1)-dd;
                y4=centre_pts(c2,2)-dd;
                
                x=[x1 x2 x3 x4];
                x=vertcat(x,[y1 y2 y3 y4]);
                mb=minBoundingBox(x);
                mb=horzcat(mb,[mb(1,1); mb(2,1)]);
                
                in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
                in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
                
                rs1=find(in1==1);
                rs2=find(in2==1);
                rss=union(rs1,rs2,'rows');
                
                x1=centre_pts(c2,1)+(dd)*cosd(ndegrees-90);
                y1=centre_pts(c2,2)+(dd)*sind(ndegrees-90);
                x2=centre_pts(c2,1)+(dd)*cosd(ndegrees+90);
                y2=centre_pts(c2,2)+(dd)*sind(ndegrees+90);
                e1 = createEdge([x1 y1], [x2 y2]);
                
                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c2,1) centre_pts(c2,2)]);
                e1 =orthogonalLine(in, [centre_pts(c2,1) centre_pts(c2,2)]);
                ce1=createEdge(e1,dd);
                tr1 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], 0);
                tr2 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], pi);
                dest1 = transformEdge(ce1,tr1);
                dest2 = transformEdge(ce1,tr2);
                
                ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
                
                vpts=[];
                for h=1:length(rss)
                    if slk(rss(h),1)~=centre_pts(c2,1)&slk(rss(h),2)~=centre_pts(c2,2)&slk(rss(h),3)~=centre_pts(c2,1)&slk(rss(h),4)~=centre_pts(c2,2)
                        e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                        point = intersectEdges(ce1, e2);
                        if ~isnan(point(1,1)) && ~isinf(point(1,1))
                            vpts=vertcat(vpts,point);
                        end
                    end
                end
                
                if ~isempty(vpts)
                    
                    rv=find(vpts(:,1)==centre_pts(c2,1)&vpts(:,2)==centre_pts(c2,2));
                    if isempty(rv)
                        vpts=vertcat(vpts,[centre_pts(c2,1) centre_pts(c2,2)]);
                    end
                    vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                    p2=length(vpts(:,1));
                    if length(vpts(:,1))>1
                        aa=centroid(vpts);
                        if distancePoints([centre_pts(c2,1) centre_pts(c2,2)], aa, 2)<=dd
                            centre_pts(c2,1)=aa(1,1);
                            centre_pts(c2,2)=aa(1,2);
                            
                            mb=vpts;
                            mb=unique(vpts,'rows');
                            pd=[centre_pts(c2,1) centre_pts(c2,2)];
                            pd=vertcat(pd,mb);
                            
                            Y = pdist(pd,'euclid');
                            SQ=squareform(Y);
                            p4=max(SQ(1,:));
                            centre_pts(c2,8)=p4;
                        end
                    end
                end
            end
            if b<length(pts(:,1))
                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
            end
            
            x1=pts(b,1)+dd;
            y1=pts(b,2)+dd;
            x2=pts(b,1)+dd;
            y2=pts(b,2)-dd;
            x3=pts(b,1)-dd;
            y3=pts(b,2)+dd;
            x4=pts(b,1)-dd;
            y4=pts(b,2)-dd;
            
            x=[x1 x2 x3 x4];
            x=vertcat(x,[y1 y2 y3 y4]);
            mb=minBoundingBox(x);
            mb=horzcat(mb,[mb(1,1); mb(2,1)]);
            
            in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
            in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
            
            rs1=find(in1==1);
            rs2=find(in2==1);
            rss=union(rs1,rs2,'rows');
            
            if b==1
                ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]));
                in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[pts(b,1) pts(b,2)]);
            elseif b==length(pts(:,1))
                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [centre_pts(c2,1) centre_pts(c2,2)]));
                in = createLine([pts(b,1) pts(b,2)],[centre_pts(c2,1) centre_pts(c2,2)]);
            elseif b<length(pts(:,1))
                ndegrees=rad2deg(angle2Points([pts(b,1) pts(b,2)], [pts(b+1,1) pts(b+1,2)]));
                in = createLine([pts(b,1) pts(b,2)],[pts(b+1,1) pts(b+1,2)]);
            end
            
            e1 =orthogonalLine(in, [pts(b,1) pts(b,2)]);
            ce1=createEdge(e1,dd);
            tr1 = createRotation([pts(b,1) pts(b,2)], 0);
            tr2 = createRotation([pts(b,1) pts(b,2)], pi);
            dest1 = transformEdge(ce1,tr1);
            dest2 = transformEdge(ce1,tr2);
            
            ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
            
            vpts=[];
            for h=1:length(rss)
                if slk(rss(h),1)~=pts(b,1)&slk(rss(h),2)~=pts(b,2)&slk(rss(h),3)~=pts(b,1)&slk(rss(h),4)~=pts(b,2)
                    e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                    point = intersectEdges(ce1, e2);
                    if ~isnan(point(1,1)) && ~isinf(point(1,1))
                        vpts=vertcat(vpts,point);
                    end
                end
            end
            
            if ~isempty(vpts)
                
                rv=find(vpts(:,1)==pts(b,1)&vpts(:,2)==pts(b,2));
                if isempty(rv)
                    vpts=vertcat(vpts,[pts(b,1) pts(b,2)]);
                end
                vpts=unique([vpts(:,1) vpts(:,2)],'rows');
                
                if length(vpts(:,1))>1
                    aa=centroid(vpts);
                    pts(b,1)=aa(1,1);
                    pts(b,2)=aa(1,2);
                end
            end
        end
        
        pseq=pts;
        
        circle = [[centre_pts(c1,1) centre_pts(c1,2)] 15];
        idx=[];
        for l=1:length(pseq(:,1))
            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                idx=vertcat(idx,l);
            end
        end
        pseq(idx,:)=[];
        
        circle = [[centre_pts(c2,1) centre_pts(c2,2)] 15];
        idx=[];
        for l=1:length(pseq(:,1))
            if isPointInCircle([pseq(l,1), pseq(l,2)], circle)
                idx=vertcat(idx,l);
            end
        end
        pseq(idx,:)=[];
        
        if ~isempty(pseq)
            NP=[centre_pts(c1,1) centre_pts(c1,2)];
            [MP, n]=unique([pseq(:,1) pseq(:,2)], 'rows');
            NP=vertcat(NP, MP);
            NP=vertcat(NP, [centre_pts(c2,1) centre_pts(c2,2)]);
            Mdist=[NP(:,1) NP(:,2)];
            Y = pdist(Mdist,'euclid');
            SQ=squareform(Y);
            mclusters=zeros(length(Mdist), 1);
            Mdist(:,3)=1;
            for o=1:length(SQ(:,:))
                SQ(o,o)=100000.0;
            end
            
            %finding sequence of point cloud
            j=1;
            idxk=1;
            minip=100000.0;
            while idxk<=length(SQ(idxk,:)) & j<=length(Mdist(:,1))
                if length(idxk)>1
                    index=0;
                    for g=1:length(idxk)
                        mindist=min(SQ(idxk(g),:));
                        if mindist<=minip
                            minip=mindist;
                            index=g;
                        end
                    end
                    resi=find(SQ(idxk(index),:)==minip);
                    mclusters(j)=idxk(index);
                    minip=100000.0;
                    j=j+1;
                else
                    mindist=min(SQ(idxk,:));
                    resi=find(SQ(idxk,:)==mindist);
                    mclusters(j)=idxk;
                    j=j+1;
                end
                
                if length(NP(:,1))==idxk
                    break;
                end
                
                SQ(idxk,:)=100000;
                SQ(:,resi)=100000;
                
                if idxk==1
                    SQ(:,idxk)=100000;
                end
                
                curr=resi;
                idxk=curr;
            end
            
            f=mclusters~=0;
            tempc=mclusters(f);
            clear mclusters;
            mclusters=tempc;
            clear tempc;
            
            temp=Mdist(mclusters(2:length(mclusters)-1),:);
            
            if ~isempty(res)
                netsections(res,:)=[];
            end
            
            for m=1:length(temp(:,1))
                netsections=vertcat(netsections,[cluster_to_tr(g,3),temp(m,1),temp(m,2),0,0]);
            end
        end
    else
        
        ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]));
        
        x1=centre_pts(c1,1)+dd;
        y1=centre_pts(c1,2)+dd;
        x2=centre_pts(c1,1)+dd;
        y2=centre_pts(c1,2)-dd;
        x3=centre_pts(c1,1)-dd;
        y3=centre_pts(c1,2)+dd;
        x4=centre_pts(c1,1)-dd;
        y4=centre_pts(c1,2)-dd;
        
        x=[x1 x2 x3 x4];
        x=vertcat(x,[y1 y2 y3 y4]);
        mb=minBoundingBox(x);
        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
        
        in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
        in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
        
        rs1=find(in1==1);
        rs2=find(in2==1);
        rss=union(rs1,rs2,'rows');
        
        in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(c2,1) centre_pts(c2,2)]);
        e1 =orthogonalLine(in, [centre_pts(c1,1) centre_pts(c1,2)]);
        ce1=createEdge(e1,dd);
        tr1 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], 0);
        tr2 = createRotation([centre_pts(c1,1) centre_pts(c1,2)], pi);
        dest1 = transformEdge(ce1,tr1);
        dest2 = transformEdge(ce1,tr2);
        
        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
        
        vpts=[];
        for h=1:length(rss)
            if slk(rss(h),1)~=centre_pts(c1,1)&slk(rss(h),2)~=centre_pts(c1,2)&slk(rss(h),3)~=centre_pts(c1,1)&slk(rss(h),4)~=centre_pts(c1,2)
                e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                point = intersectEdges(ce1, e2);
                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                    vpts=vertcat(vpts,point);
                end
            end
        end
        
        if ~isempty(vpts)
            
            rv=find(vpts(:,1)==centre_pts(c1,1)&vpts(:,2)==centre_pts(c1,2));
            if isempty(rv)
                vpts=vertcat(vpts,[centre_pts(c1,1) centre_pts(c1,2)]);
            end
            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
            p1=length(vpts(:,1));
            
            if length(vpts(:,1))>1
                aa=centroid(vpts);
                if distancePoints([centre_pts(c1,1) centre_pts(c1,2)], aa, 2)<=dd
                    centre_pts(c1,1)=aa(1,1);
                    centre_pts(c1,2)=aa(1,2);
                    
                    mb=vpts;
                    mb=unique(vpts,'rows');
                    pd=[centre_pts(c1,1) centre_pts(c1,2)];
                    pd=vertcat(pd,mb);
                    
                    Y = pdist(pd,'euclid');
                    SQ=squareform(Y);
                    p3=max(SQ(1,:));
                    centre_pts(c1,8)=p3;
                end
            end
        end
        
        ndegrees=rad2deg(angle2Points([centre_pts(c1,1) centre_pts(c1,2)], [centre_pts(c2,1) centre_pts(c2,2)]));
        
        x1=centre_pts(c2,1)+dd;
        y1=centre_pts(c2,2)+dd;
        x2=centre_pts(c2,1)+dd;
        y2=centre_pts(c2,2)-dd;
        x3=centre_pts(c2,1)-dd;
        y3=centre_pts(c2,2)+dd;
        x4=centre_pts(c2,1)-dd;
        y4=centre_pts(c2,2)-dd;
        
        x=[x1 x2 x3 x4];
        x=vertcat(x,[y1 y2 y3 y4]);
        mb=minBoundingBox(x);
        mb=horzcat(mb,[mb(1,1); mb(2,1)]);
        
        in1 = inpolygon(slk(:,1), slk(:,2),mb(1,:), mb(2,:));
        in2 = inpolygon(slk(:,3), slk(:,4),mb(1,:), mb(2,:));
        
        rs1=find(in1==1);
        rs2=find(in2==1);
        rss=union(rs1,rs2,'rows');
        
        x1=centre_pts(c2,1)+(dd)*cosd(ndegrees-90);
        y1=centre_pts(c2,2)+(dd)*sind(ndegrees-90);
        x2=centre_pts(c2,1)+(dd)*cosd(ndegrees+90);
        y2=centre_pts(c2,2)+(dd)*sind(ndegrees+90);
        e1 = createEdge([x1 y1], [x2 y2]);
        
        in = createLine([centre_pts(c1,1) centre_pts(c1,2)],[centre_pts(c2,1) centre_pts(c2,2)]);
        e1 =orthogonalLine(in, [centre_pts(c2,1) centre_pts(c2,2)]);
        ce1=createEdge(e1,dd);
        tr1 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], 0);
        tr2 = createRotation([centre_pts(c2,1) centre_pts(c2,2)], pi);
        dest1 = transformEdge(ce1,tr1);
        dest2 = transformEdge(ce1,tr2);
        
        ce1=[dest1(1,3) dest1(1,4) dest2(1,3) dest2(1,4)];
        
        vpts=[];
        for h=1:length(rss)
            if slk(rss(h),1)~=centre_pts(c2,1)&slk(rss(h),2)~=centre_pts(c2,2)&slk(rss(h),3)~=centre_pts(c2,1)&slk(rss(h),4)~=centre_pts(c2,2)
                e2 = createEdge([slk(rss(h),1) slk(rss(h),2)], [slk(rss(h),3) slk(rss(h),4)]);
                point = intersectEdges(ce1, e2);
                if ~isnan(point(1,1)) && ~isinf(point(1,1))
                    vpts=vertcat(vpts,point);
                end
            end
        end
        
        if ~isempty(vpts)
            
            rv=find(vpts(:,1)==centre_pts(c2,1)&vpts(:,2)==centre_pts(c2,2));
            if isempty(rv)
                vpts=vertcat(vpts,[centre_pts(c2,1) centre_pts(c2,2)]);
            end
            vpts=unique([vpts(:,1) vpts(:,2)],'rows');
            p2=length(vpts(:,1));
            if length(vpts(:,1))>1
                aa=centroid(vpts);
                if distancePoints([centre_pts(c2,1) centre_pts(c2,2)], aa, 2)<=dd
                    centre_pts(c2,1)=aa(1,1);
                    centre_pts(c2,2)=aa(1,2);
                    
                    mb=vpts;
                    mb=unique(vpts,'rows');
                    pd=[centre_pts(c2,1) centre_pts(c2,2)];
                    pd=vertcat(pd,mb);
                    
                    Y = pdist(pd,'euclid');
                    SQ=squareform(Y);
                    p4=max(SQ(1,:));
                    centre_pts(c2,8)=p4;
                end
            end
        end
    end
end

fprintf('Writing nodes and links to file\n');

idx=max(centre_pts(:,3))+1;
for k=1:length(netsections(:,1))
    netsections(k,6)=idx;
    idx=idx+1;
end
n_edges=[];
dir=0;
for k=1:length(cluster_to_tr(:,1))
    rnnx=find(netnodes(:,1)==cluster_to_tr(k,3));
    if netnodes(rnnx,3)==2
        dir=1;
    else
        dir=0;
    end
    res=find(netsections(:,1)==cluster_to_tr(k,3));
    if isempty(res)
        n_edges=vertcat(n_edges,[cluster_to_tr(k,1) cluster_to_tr(k,2) dir]);
    else
        for i=1:length(res)
            if i==1
                n_edges=vertcat(n_edges,[cluster_to_tr(k,1) netsections(res(i),6) dir]);
            end
            if i<length(res)
                n_edges=vertcat(n_edges,[netsections(res(i),6) netsections(res(i+1),6) dir]);
            end
            if i==length(res)
                n_edges=vertcat(n_edges,[netsections(res(i),6) cluster_to_tr(k,2) dir]);
            end
        end
    end
end

n_nodes=centre_pts;
for k=1:length(netsections(:,1))
    n_nodes=vertcat(n_nodes,[netsections(k,2) netsections(k,3) netsections(k,6) 0 0 0 0 0 0]);
end


wf=['tracebundle_edges.txt'];
wff=['tracebundle_vertices.txt'];
fileID = fopen(wf,'w');
fileIDD = fopen(wff,'w');

for k=1:length(n_edges)
    fprintf(fileID,'%d,%d,%d,%d\n',k,n_edges(k,1),n_edges(k,2),n_edges(k,3));
end
fclose(fileID);

for k=1:length(n_nodes)
    fprintf(fileIDD,'%d,%f,%f\n',n_nodes(k,3),n_nodes(k,1),n_nodes(k,2));
end
fclose(fileIDD);


delete('slk.mat');
delete('pts_ln.mat');
delete('vehicles.mat');
delete('centre_pts.mat');
delete('pts_to_inter.mat');
delete('clusterseeds.mat');
delete('inter_to_cluster.mat');

fprintf('Finishing at %s\n', timestamp);

